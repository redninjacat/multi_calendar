# Implementation Log: Task 9

**Summary:** Added 5 exception CRUD methods to MCalEventController: addException (O(1) cache patch), addExceptions (batch with cache invalidation), removeException (nullable return), getExceptions (read-only), and modifyOccurrence (convenience wrapper). All mutation methods set _lastChange before notifyListeners().

**Timestamp:** 2026-02-12T05:14:14.714Z
**Log ID:** 184c2567-2d21-42b7-9816-5df16d8a3c70

---

## Statistics

- **Lines Added:** +131
- **Lines Removed:** -0
- **Files Changed:** 1
- **Net Change:** 131

## Files Modified
- lib/src/controllers/mcal_event_controller.dart

## Files Created
_No files created_

---

## Artifacts

### Functions

#### addException
- **Purpose:** Adds a single recurrence exception for a series, patches expansion cache in O(1), sets _lastChange with exceptionAdded type, notifies listeners, returns the exception
- **Location:** lib/src/controllers/mcal_event_controller.dart:677
- **Signature:** (String seriesId, MCalRecurrenceException exception) => MCalRecurrenceException
- **Exported:** Yes

#### addExceptions
- **Purpose:** Batch-adds multiple recurrence exceptions for a series, invalidates series expansion cache, sets _lastChange with bulkChange type, notifies listeners
- **Location:** lib/src/controllers/mcal_event_controller.dart:707
- **Signature:** (String seriesId, List<MCalRecurrenceException> exceptions) => void
- **Exported:** Yes

#### removeException
- **Purpose:** Removes a recurrence exception by series ID and original date, invalidates cache via _patchCacheForExceptionRemoval, sets _lastChange with exceptionRemoved type, returns removed exception or null
- **Location:** lib/src/controllers/mcal_event_controller.dart:737
- **Signature:** (String seriesId, DateTime originalDate) => MCalRecurrenceException?
- **Exported:** Yes

#### getExceptions
- **Purpose:** Returns all recurrence exceptions for a series as a list, read-only with no side effects
- **Location:** lib/src/controllers/mcal_event_controller.dart:762
- **Signature:** (String seriesId) => List<MCalRecurrenceException>
- **Exported:** Yes

#### modifyOccurrence
- **Purpose:** Convenience method that creates MCalRecurrenceException.modified and delegates to addException
- **Location:** lib/src/controllers/mcal_event_controller.dart:777
- **Signature:** (String seriesId, DateTime originalDate, MCalCalendarEvent modifiedEvent) => MCalRecurrenceException
- **Exported:** Yes

### Integrations

#### Integration
- **Description:** addException uses _patchCacheForException (Task 8) for O(1) cache updates and _computeAffectedRange (Task 8) for _lastChange date range
- **Frontend Component:** MCalEventController
- **Backend Endpoint:** _patchCacheForException, _computeAffectedRange
- **Data Flow:** addException stores exception -> patches cache in O(1) -> sets _lastChange -> notifyListeners

#### Integration
- **Description:** removeException uses _patchCacheForExceptionRemoval (Task 8) to invalidate cache when exception is removed
- **Frontend Component:** MCalEventController
- **Backend Endpoint:** _patchCacheForExceptionRemoval, _computeAffectedRange
- **Data Flow:** removeException removes from store -> invalidates cache -> sets _lastChange -> notifyListeners

#### Integration
- **Description:** addExceptions invalidates series expansion cache entirely rather than patching individual entries, since batch re-expansion is cheaper
- **Frontend Component:** MCalEventController
- **Backend Endpoint:** _expandedBySeriesId.remove(seriesId)
- **Data Flow:** addExceptions stores all exceptions -> removes series from cache -> sets _lastChange bulkChange -> notifyListeners

