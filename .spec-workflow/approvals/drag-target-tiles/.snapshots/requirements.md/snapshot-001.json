{
  "id": "snapshot_1770760831872_yjg6zd6pk",
  "approvalId": "approval_1770760831863_11vrtuiul",
  "approvalTitle": "Requirements: Drag Target Tiles (Layer 3)",
  "version": 1,
  "timestamp": "2026-02-10T22:00:31.872Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: Drag Target Tiles (Layer 3)\n\n## Introduction\n\nThis specification implements the previously introduced but never wired-up `dragTargetTileBuilder` feature for MCalMonthView. The parameter exists and is passed through the widget tree but is never used to build any widget; the code path ends in Layer 1 (grid-only) day cells that do not render event tiles.\n\nThis feature adds a new **Layer 3** that renders \"drag target tiles\"—preview tiles showing where a dragged event would land—using the **exact same week layout strategy as Layer 2** (same week layout builder, same date-label reserved space, same row assignment). The current highlight overlay (colored cell rectangles) becomes **Layer 4**. Layer 3 displays at most one phantom event per week row (the proposed drop span), positioned so it does not cover date labels. Drag target tiles can be disabled via `showDragTargetTiles`. The default tile looks like the default event tile but without text; customization is via new theme keys (with fallback to event tile theme) and optional `dragTargetTileBuilder`. A new details type `MCalDragTargetTileDetails` is used for the tile builder. Existing drag-target theme keys are renamed to include \"Cell\" or \"Tile\" so that cell overlay (Layer 4) and tile (Layer 3) styling are unambiguous and no key is shared between both.\n\n## Alignment with Product Vision\n\n- **Customization First**: Exposes `dragTargetTileBuilder` and dragTargetTile* theme/widget properties so developers can match app design.\n- **Developer-Friendly**: Same week layout builder and segment semantics as Layer 2 reduce cognitive load and keep one layout stack.\n- **Performance Conscious**: Layer 3 is non-interactive (IgnorePointer) and only visible during drag; reuse of existing layout avoids a second layout builder.\n\n## Requirements\n\n### Requirement 1: Layer Reorganization\n\n**User Story:** As a Flutter developer, I want the drag highlight overlay and drag target tiles to live on distinct layers, so that I can style or disable them independently.\n\n#### Acceptance Criteria\n\n1. WHEN the month calendar is built with drag-and-drop enabled THEN the system SHALL order layers as: Layer 1 (grid), Layer 2 (events and date labels), Layer 3 (drag target tiles, when enabled), Layer 4 (drag highlight overlay, when shown).\n2. WHEN a drag is active and Layer 4 is shown THEN the system SHALL render Layer 4 above Layer 3 so that the overlay appears on top of the tiles.\n3. WHEN both drag target tiles and the highlight overlay are enabled THEN the system SHALL show both during drag (tiles under overlay).\n\n### Requirement 2: New Layer 3 — Drag Target Tiles\n\n**User Story:** As a user dragging an event, I want to see preview tiles that match the week layout (same position and span as real events), so that the drop preview aligns with where events actually render.\n\n#### Acceptance Criteria\n\n1. WHEN `showDragTargetTiles` is true AND a drag is active AND a proposed drop range exists THEN the system SHALL render a new Layer 3 that displays drag target tiles for the proposed range.\n2. WHEN rendering Layer 3 THEN the system SHALL use the same week layout builder as Layer 2 (developer-provided `weekLayoutBuilder` if set, otherwise the built-in default).\n3. WHEN using the week layout builder for Layer 3 THEN the system SHALL pass a context that supplies exactly one phantom segment per week row (the portion of the proposed drop range in that week) and SHALL pass a tile builder that invokes the drag target tile logic (default or `dragTargetTileBuilder`) instead of the event tile builder.\n4. WHEN Layer 3 is rendered THEN the system SHALL reserve the same date-label space as Layer 2 (using the same theme/config) so that drag target tiles do not cover date labels.\n5. WHEN Layer 3 is rendered THEN the phantom tile(s) SHALL be placed in the first event row (row 0) under the date label area; there is at most one phantom event per week so row assignment always yields row 0.\n6. WHEN Layer 3 is visible THEN the system SHALL wrap the layer in `IgnorePointer` so that pointer events pass through to the underlying DragTarget.\n7. WHEN no drag is active OR `showDragTargetTiles` is false THEN the system SHALL not render Layer 3.\n\n### Requirement 3: showDragTargetTiles and Independence from Overlay\n\n**User Story:** As a developer, I want to control drag target tiles and the cell overlay independently, so that I can show overlay only, tiles only, both, or neither.\n\n#### Acceptance Criteria\n\n1. WHEN configuring MCalMonthView THEN the system SHALL provide a boolean property `showDragTargetTiles` (default true when drag-and-drop is enabled).\n2. WHEN `showDragTargetTiles` is false THEN the system SHALL not render Layer 3 (drag target tiles) regardless of overlay configuration.\n3. WHEN the highlight overlay (Layer 4) is shown is determined by existing logic (e.g. drop target cell/overlay builders or default painter); the system SHALL NOT tie Layer 4 visibility to `showDragTargetTiles`. The two are independent.\n\n### Requirement 4: Default Drag Target Tile (No Text)\n\n**User Story:** As a developer, I want the default drag target tile to look like the default event tile but without text, so that the preview is recognizable and unobtrusive.\n\n#### Acceptance Criteria\n\n1. WHEN Layer 3 is rendered AND `dragTargetTileBuilder` is not provided THEN the system SHALL render a default tile that matches the default event tile styling (shape, corners, border) but SHALL NOT display event title or other text.\n2. WHEN resolving default tile styling THEN the system SHALL use dragTargetTile* theme properties when present; when absent, SHALL fall back to the corresponding event tile theme properties (e.g. eventTileBackgroundColor, eventTileCornerRadius); when those are absent, SHALL use the same fallbacks as the regular event tile builder (e.g. event color or theme default).\n\n### Requirement 5: dragTargetTileBuilder and MCalDragTargetTileDetails\n\n**User Story:** As a developer, I want to customize the drag target tile per segment via a builder and a dedicated details type, so that I can match my app’s design and have clear segment/span context.\n\n#### Acceptance Criteria\n\n1. WHEN `dragTargetTileBuilder` is provided THEN the system SHALL call it once per week-row segment of the proposed drop range, with a details object of type `MCalDragTargetTileDetails`.\n2. WHEN building the details object THEN the system SHALL include: the dragged event, proposed start date, proposed end date, validity (isValid), and segment information for that week row (e.g. startDayInWeek, endDayInWeek, isFirstSegment, isLastSegment), and any other data needed to build a tile that matches the layout (e.g. display date for the segment).\n3. WHEN the developer provides `dragTargetTileBuilder` THEN the system SHALL use the returned widget for that segment in place of the default tile; widget-level styling overrides SHALL follow the same pattern as event tiles (widget overrides theme when provided).\n4. The system SHALL introduce a new public type `MCalDragTargetTileDetails` for this builder; the existing `MCalDragTargetDetails` (event, targetDate, isValid) SHALL remain for any other use and SHALL NOT be reused for this per-segment tile builder.\n\n### Requirement 6: Theme Key Renames (Cell vs Tile)\n\n**User Story:** As a developer, I want theme key names to clearly indicate whether they apply to the cell overlay (Layer 4) or the event-style tile (Layer 3), so that I can style each without ambiguity.\n\n#### Acceptance Criteria\n\n1. WHEN a theme property is used only for the cell highlight overlay (Layer 4) THEN its name SHALL include \"Cell\" (e.g. dragTargetCellValidColor, dragTargetCellInvalidColor, dragTargetCellBorderRadius).\n2. WHEN a theme property applies to the drag target tile (Layer 3) THEN its name SHALL include \"Tile\" (e.g. dragTargetTileBackgroundColor, dragTargetTileCornerRadius).\n3. The system SHALL NOT use the same theme key for both the cell overlay and the tile; each key SHALL apply to exactly one of Layer 3 or Layer 4.\n4. Existing keys `dragTargetValidColor`, `dragTargetInvalidColor`, and `dragTargetBorderRadius` are used in code only by the cell overlay (CustomPainter); the system SHALL rename them to `dragTargetCellValidColor`, `dragTargetCellInvalidColor`, and `dragTargetCellBorderRadius` respectively, and SHALL update all usages and theme defaults/copyWith/lerp/documentation accordingly.\n\n### Requirement 7: New Theme and Widget Properties for Tiles\n\n**User Story:** As a developer, I want to style drag target tiles via theme and optional widget overrides, so that I can match event tile styling or differentiate it without a custom builder.\n\n#### Acceptance Criteria\n\n1. WHEN styling the default drag target tile THEN the system SHALL support theme properties that mirror event tile styling, with fallback to event tile theme when not set. At minimum: background color (valid and invalid), corner radius, border color, border width. Naming SHALL use the \"Tile\" suffix (e.g. dragTargetTileBackgroundColor, dragTargetTileInvalidBackgroundColor, dragTargetTileCornerRadius, dragTargetTileBorderColor, dragTargetTileBorderWidth).\n2. WHEN both theme and widget-level overrides exist for a drag target tile property THEN the widget-level value SHALL take precedence, consistent with event tile behavior.\n3. Default values or fallback chain for tile theme SHALL be: dragTargetTile* if set, else eventTile* if set, else the same fallbacks used by the default event tile (e.g. event.color, then theme default).\n\n### Requirement 8: Remove Dead dragTargetTileBuilder Wiring from Layer 1\n\n**User Story:** As a maintainer, I want the only use of dragTargetTileBuilder to be in Layer 3, so that there is no dead parameter passing through Layer 1 day cells.\n\n#### Acceptance Criteria\n\n1. WHEN building Layer 1 (grid day cells) THEN the system SHALL NOT pass `dragTargetTileBuilder` (or any drag-target-tile-specific builder) into the day cell widget for use in Layer 1; the parameter SHALL only be used where Layer 3 is built (e.g. at the week/month page level).\n2. The system MAY continue to pass `dragTargetTileBuilder` through parent widgets only as needed to reach the Layer 3 construction site; it SHALL NOT be passed into widgets that do not participate in building Layer 3.\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- Reuse the existing week layout builder and segment model; do not introduce a second layout builder for Layer 3.\n- Single responsibility: Layer 3 construction and phantom segment preparation should be clearly scoped (e.g. one method or helper that builds Layer 3 content using the same layout stack as Layer 2).\n- Clear interfaces: `MCalDragTargetTileDetails` and any new theme properties must be documented (dartdoc) and consistent with existing callback/details patterns.\n\n### Performance\n\n- Layer 3 SHALL only be built when drag is active and `showDragTargetTiles` is true.\n- Reuse of Layer 2 layout logic SHALL avoid duplicate layout calculations where possible (e.g. shared config, same row-assignment algorithm).\n\n### Reliability\n\n- When proposed drop range is empty or invalid, Layer 3 SHALL show nothing (no tiles).\n- Layer 3 SHALL not affect hit-testing for the unified DragTarget; IgnorePointer SHALL be applied so drops and move events are unchanged.\n\n### Usability\n\n- Default tiles SHALL be visually consistent with event tiles (no text) so users recognize the preview. Custom builders and theme allow full customization.\n",
  "fileStats": {
    "size": 11510,
    "lines": 122,
    "lastModified": "2026-02-10T22:00:26.085Z"
  },
  "comments": []
}