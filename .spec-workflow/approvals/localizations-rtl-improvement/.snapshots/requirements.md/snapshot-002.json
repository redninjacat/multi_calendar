{
  "id": "snapshot_1771218164742_15wwae10g",
  "approvalId": "approval_1771215402780_ozwzgy6e2",
  "approvalTitle": "Requirements: Localizations & RTL Improvement",
  "version": 2,
  "timestamp": "2026-02-16T05:02:44.742Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements: Localizations & RTL Improvement\n\n## Introduction\n\nThe multi_calendar package uses a non-standard localization pattern where a custom wrapper class (`MCalLocalizations` in `lib/src/utils/mcal_localization.dart`) shadows the gen-l10n generated class of the same name, bypasses Flutter's standard `of(context)` localization tree, and uses a fragile string-key-based lookup. Additionally, multiple RTL-related bugs exist: keyboard navigation does not reverse arrow key direction in RTL layouts, several SemanticsService announcements contain hardcoded English strings, and RTL detection is inconsistent (sometimes using a custom `isRTL(locale)` helper, sometimes using `Directionality.of(context)`).\n\nFurthermore, the recent example app reorganization (spec `example-app-reorganization`) created 424 localization keys across 5 languages but left at least 14 files with hardcoded English strings — control panel labels, SnackBar messages, accessibility documentation, style widget text, and theme tab fallback strings all bypass `AppLocalizations.of(context)`.\n\nThis spec addresses the package localization architecture, RTL behavior, and example app localization completeness to bring everything in line with Flutter's standard practices and ensure correct right-to-left behavior throughout.\n\n## Alignment with Product Vision\n\n- **International Ready** (Principle #8): Proper localization architecture is foundational to international support. The current non-standard pattern makes it harder for consuming apps to integrate correctly and could cause locale resolution bugs.\n- **Accessibility First** (Principle #7): Hardcoded English strings in screen reader announcements make the package inaccessible to non-English users. RTL keyboard navigation bugs make the package unusable for RTL users relying on keyboard access.\n- **Developer-Friendly** (Principle #6): The name collision between the wrapper and generated class creates import confusion. Following Flutter's standard localization pattern reduces learning curve.\n- **Standards Compliance** (Principle #3): Flutter has a well-documented standard for package localization (`gen-l10n` with `of(context)`). The package should follow it.\n\n## Requirements\n\n### REQ-1: Eliminate Localization Name Collision\n\n**User Story:** As a developer using the multi_calendar package, I want unambiguous class names so that importing `MCalLocalizations` always refers to the same class and I can use it without import aliases.\n\n#### Acceptance Criteria\n\n1. WHEN a developer imports `package:multi_calendar/multi_calendar.dart`, THEN `MCalLocalizations` SHALL refer to the gen-l10n generated localization class (from `lib/l10n/mcal_localizations.dart`)\n2. WHEN the package exports date/time formatting utilities, THEN they SHALL be in a class with a distinct name (e.g., `MCalDateFormatUtils`) that does NOT collide with the generated class\n3. WHEN the renamed utility class is exported, THEN it SHALL contain ONLY formatting and RTL-detection methods: `formatDate()`, `formatTime()`, `formatMonthYear()`, `formatFullDateWithDayName()`, `formatMultiDaySpanLabel()`, and `isRTL()`\n4. WHEN the rename is complete, THEN the `getLocalizedString(String key, Locale locale)` method SHALL be removed entirely — all callers must use the generated class's typed getters instead\n\n### REQ-2: Standard Flutter Localization Pattern in Package Widgets\n\n**User Story:** As a developer, I want the package to use Flutter's standard `of(context)` localization pattern so that my app's locale settings are automatically respected without passing locale parameters manually.\n\n#### Acceptance Criteria\n\n1. WHEN a package widget (MCalMonthView, MCalDayView) needs a localized string, THEN it SHALL obtain it via `MCalLocalizations.of(context)` from the generated class — NOT via the wrapper's `getLocalizedString()`\n2. WHEN `MCalLocalizations.of(context)` is called and no delegate has been wired up, THEN the package SHALL provide a clear error message advising the developer to add `MCalLocalizations.delegate` to their `localizationsDelegates`\n3. WHEN the `locale` parameter is provided on a view widget, THEN it SHALL continue to be used for date/time formatting (via `MCalDateFormatUtils`) but SHALL NOT be used for localized string lookup — string lookup SHALL always come from the widget tree\n4. WHEN the package's `l10n.yaml` is configured, THEN it SHALL include `synthetic-package: false` (required as of Flutter 3.32+)\n\n### REQ-3: Package Delegate Wiring in Example App\n\n**User Story:** As a developer reading the example app, I want to see the correct delegate wiring pattern so that I can replicate it in my own app.\n\n#### Acceptance Criteria\n\n1. WHEN the example app configures `MaterialApp.localizationsDelegates`, THEN it SHALL include both `AppLocalizations.localizationsDelegates` and `MCalLocalizations.delegate` (the package delegate)\n2. WHEN the example app runs in any supported locale, THEN the package widgets SHALL display localized strings from the package's ARB files via the standard `of(context)` lookup\n3. WHEN a consuming app omits the `MCalLocalizations.delegate`, THEN the package SHALL either throw a descriptive error or fall back to English defaults with a debug-mode warning\n\n### REQ-4: Localize Hardcoded English in Screen Reader Announcements\n\n**User Story:** As a screen reader user using the calendar in Arabic or Hebrew, I want screen reader announcements in my language so that I can understand what the calendar is doing.\n\n#### Acceptance Criteria\n\n1. WHEN the Month View sends a SemanticsService announcement for keyboard operations (move, resize, cancel, confirm, event selection), THEN the announcement text SHALL be localized via `MCalLocalizations.of(context)` — NOT hardcoded English\n2. WHEN the Day View sends a SemanticsService announcement for any operation, THEN the announcement text SHALL be localized via `MCalLocalizations.of(context)`\n3. WHEN any SemanticsService announcement includes a text direction parameter, THEN the text direction SHALL be obtained from `Directionality.of(context)` — NOT hardcoded as `TextDirection.ltr`\n4. WHEN the following currently-hardcoded announcement strings are used, THEN they SHALL be moved to the package ARB files as new localization keys:\n   - \"Resize cancelled\"\n   - \"Move cancelled for {title}\"\n   - \"Event selection cancelled\"\n   - \"{count} events. {title} highlighted. Tab to cycle, Enter to confirm.\"\n   - \"Selected {title}. Arrow keys to move, Enter to confirm, Escape to cancel.\"\n   - \"{title}. {index} of {total}.\"\n   - \"Moving {title} to {date}\"\n   - \"Resize mode. Adjusting end edge. Arrow keys to resize, S for start, E for end, M for move mode, Enter to confirm.\"\n   - \"Resizing start edge\"\n   - \"Resizing end edge\"\n   - \"Move mode\"\n   - \"Move cancelled. Invalid target.\"\n   - \"Moved {title} to {date}\"\n   - \"Resizing {title} {edge} to {date}, {days} days\"\n   - \"Resize cancelled. Invalid resize.\"\n   - \"Resized {title} to {start} through {end}\"\n\n### REQ-5: Align Locale Support\n\n**User Story:** As a package maintainer, I want the package and example app to support the same set of locales so that testing covers the full locale matrix and there are no gaps.\n\n#### Acceptance Criteria\n\n1. WHEN the package defines supported locales in its ARB files, THEN the example app SHALL support the same set of locales\n2. IF the package supports `es_MX` (Mexican Spanish), THEN the example app SHALL also support `es_MX`, OR `es_MX` SHALL be removed from the package — the locale sets SHALL match\n3. WHEN the locale sets are aligned, THEN the `supportedLocales` exported by both `MCalLocalizations` and `AppLocalizations` SHALL be consistent\n\n### REQ-6: Month View Keyboard Navigation RTL\n\n**User Story:** As a user navigating the month calendar with a keyboard in an RTL language, I want arrow keys to move in the visual direction so that pressing the left arrow moves me to the next day (which is visually to my left in RTL) and the right arrow moves me to the previous day.\n\n#### Acceptance Criteria\n\n1. WHEN the layout direction is RTL AND the user presses the left arrow key in cell navigation mode, THEN the focused date SHALL advance by +1 day (moving visually left in RTL = forward in time)\n2. WHEN the layout direction is RTL AND the user presses the right arrow key in cell navigation mode, THEN the focused date SHALL go back by -1 day (moving visually right in RTL = backward in time)\n3. WHEN the layout direction is LTR, THEN the existing behavior SHALL be preserved (left = -1 day, right = +1 day)\n4. WHEN the layout direction is RTL, THEN the up and down arrow keys SHALL NOT be affected (up = -7 days, down = +7 days regardless of direction)\n\n### REQ-7: Month View Keyboard Move/Resize RTL\n\n**User Story:** As a user moving or resizing events via keyboard in an RTL layout, I want the arrow key directions to match the visual layout so that I can predictably position events.\n\n#### Acceptance Criteria\n\n1. WHEN the layout direction is RTL AND the user is in keyboard move mode AND presses the left arrow key, THEN the event SHALL move +1 day (visually left in RTL = forward in time)\n2. WHEN the layout direction is RTL AND the user is in keyboard move mode AND presses the right arrow key, THEN the event SHALL move -1 day (visually right in RTL = backward in time)\n3. WHEN the layout direction is RTL AND the user is in keyboard resize mode AND presses the left arrow key, THEN the resize edge SHALL adjust by +1 day\n4. WHEN the layout direction is RTL AND the user is in keyboard resize mode AND presses the right arrow key, THEN the resize edge SHALL adjust by -1 day\n5. WHEN the layout direction is LTR, THEN all existing keyboard move/resize behavior SHALL be preserved\n\n### REQ-8: Day View Keyboard Navigation RTL\n\n**User Story:** As a user navigating the day view with a keyboard in an RTL language, I want the left arrow to navigate to the next day and the right arrow to navigate to the previous day so that navigation matches my visual expectation.\n\n#### Acceptance Criteria\n\n1. WHEN the layout direction is RTL AND the user presses the left arrow key in the Day View, THEN the view SHALL navigate to the next day (visually left in RTL = forward in time)\n2. WHEN the layout direction is RTL AND the user presses the right arrow key in the Day View, THEN the view SHALL navigate to the previous day (visually right in RTL = backward in time)\n3. WHEN the layout direction is LTR, THEN the existing behavior SHALL be preserved (left = previous, right = next)\n\n### REQ-9: Day View Keyboard Move RTL\n\n**User Story:** As a user moving events via keyboard in the Day View with RTL layout, I want arrow key day-shifting to match the visual direction.\n\n#### Acceptance Criteria\n\n1. WHEN the layout direction is RTL AND the user is in keyboard move mode in the Day View AND presses the left arrow key, THEN the event SHALL shift +1 day\n2. WHEN the layout direction is RTL AND the user is in keyboard move mode AND presses the right arrow key, THEN the event SHALL shift -1 day\n3. WHEN the layout direction is LTR, THEN existing keyboard move behavior SHALL be preserved\n4. WHEN the user presses up/down arrow keys in keyboard move mode, THEN the behavior SHALL NOT change regardless of text direction (up = earlier time slots, down = later time slots)\n\n### REQ-10: Consistent RTL Detection\n\n**User Story:** As a package maintainer, I want RTL detection to use a single consistent mechanism so that RTL behavior is always in sync with the widget tree's text direction.\n\n#### Acceptance Criteria\n\n1. WHEN a package widget needs to determine text direction for layout purposes, THEN it SHALL use `Directionality.of(context)` as the primary source of truth\n2. WHEN the renamed utility class (`MCalDateFormatUtils`) provides an `isRTL()` method, THEN it SHALL be used ONLY for cases where a `BuildContext` is not available (e.g., pure utility functions)\n3. WHEN the Month View wraps content in a `Directionality` widget, THEN it SHALL derive the text direction from `Directionality.of(context)` (inherited from the app's widget tree) rather than from `localizations.isRTL(locale)` — unless the app explicitly does not set a `Directionality` for the locale\n4. WHEN both the Day View and Month View determine RTL state, THEN they SHALL use the same mechanism consistently\n\n### REQ-11: Update Package Exports\n\n**User Story:** As a developer consuming the package, I want the public exports to clearly expose the standard localization class and the separate formatting utility so that I can wire up my app correctly.\n\n#### Acceptance Criteria\n\n1. WHEN `package:multi_calendar/multi_calendar.dart` is imported, THEN it SHALL export:\n   - `MCalLocalizations` (the gen-l10n generated class with `.of(context)`, `.delegate`, `.supportedLocales`, `.localizationsDelegates`)\n   - `MCalDateFormatUtils` (the renamed formatting utility with `formatDate()`, `formatTime()`, `formatMonthYear()`, `formatFullDateWithDayName()`, `formatMultiDaySpanLabel()`, `isRTL()`)\n2. WHEN the old wrapper class `MCalLocalizations` (from `mcal_localization.dart`) is no longer exported under that name, THEN consuming apps that previously used `getLocalizedString()` SHALL receive a compile-time error guiding them to the new pattern\n3. WHEN the README documents localization setup, THEN it SHALL show the standard delegate wiring pattern with `MCalLocalizations.delegate`\n\n### REQ-12: Complete Example App Localization\n\n**User Story:** As a developer browsing the example app in a non-English locale, I want all user-facing text to be localized so that I can verify the package works correctly across all supported languages.\n\n**Context:** The recent example app reorganization (spec `example-app-reorganization`) was intended to localize all text, and 424 ARB keys were created across 5 languages. However, an audit reveals that at least 14 files still contain hardcoded English strings that bypass the localization system. These range from control panel labels and SnackBar messages to entire documentation sections.\n\n#### Acceptance Criteria\n\n##### REQ-12.1: Control Panel Labels and Settings\n\n1. WHEN the Month View Features tab displays control panel sections and setting labels, THEN ALL text SHALL come from `AppLocalizations.of(context)` — including section headers (\"Navigation\", \"Display\", \"Drag & Drop\", \"Resize\", \"Animation\", \"Keyboard\", \"Blackout Days\"), toggle labels (\"Show Navigator\", \"Enable Swipe Navigation\", etc.), dropdown options (\"Horizontal\", \"Vertical\", \"Monday\", \"Sunday\", etc.), and slider labels\n2. WHEN the Day View Features tab displays control panel sections and setting labels, THEN ALL text SHALL come from `AppLocalizations.of(context)` — including time region labels (\"Lunch Break\", \"After Hours (blocked)\")\n3. WHEN the Day View Theme tab displays settings, THEN it SHALL use `AppLocalizations.of(context)!` directly — NOT null-check fallback patterns with hardcoded English defaults\n\n##### REQ-12.2: SnackBar Messages\n\n1. WHEN any tab fires a SnackBar message in response to a gesture (cell tap, cell long press, cell double tap, date label tap, event tap, event long press, event double tap, overflow tap, drag events, resize events, swipe navigation, focus changes), THEN the message text SHALL come from `AppLocalizations.of(context)` using parameterized localization keys\n2. WHEN Day View style widgets (day_classic_style, day_modern_style, day_minimal_style, day_colorful_style) fire SnackBar messages for drag/resize operations, THEN those messages SHALL come from `AppLocalizations.of(context)`\n\n##### REQ-12.3: Accessibility Tab Content\n\n1. WHEN the Month View Accessibility tab displays keyboard shortcuts, THEN ALL shortcut labels and descriptions SHALL come from `AppLocalizations.of(context)` — including \"Arrow Keys\", \"Navigate between cells\", \"Enter / Space\", \"Select cell or enter event mode\", etc.\n2. WHEN the Month View Accessibility tab displays the Screen Reader Guide, THEN ALL guide content SHALL come from `AppLocalizations.of(context)` — including section titles (\"Cell Labels\", \"Event Labels\", \"Multi-day Events\", \"Navigator\", \"Overflow Indicators\") and example descriptions\n3. WHEN the Month View Accessibility tab displays the Accessibility Checklist, THEN ALL checklist items SHALL come from `AppLocalizations.of(context)`\n4. WHEN the Month View Accessibility tab displays the Keyboard Navigation Flow, THEN ALL step descriptions SHALL come from `AppLocalizations.of(context)`\n5. WHEN the Month View Accessibility tab displays toggle labels and section headers (\"High Contrast Mode\", \"Enable High Contrast\", \"Keyboard Shortcuts\", \"Screen Reader Guide\", \"Accessibility Checklist\", \"Keyboard Navigation Flow\"), THEN they SHALL come from `AppLocalizations.of(context)`\n\n##### REQ-12.4: Style Widget Text\n\n1. WHEN the month_classic_style widget displays navigator button labels (\"Prev\", \"Next\"), THEN they SHALL come from `AppLocalizations.of(context)`\n2. WHEN the month_modern_style widget displays a tooltip (\"Today\"), THEN it SHALL come from `AppLocalizations.of(context)`\n\n##### REQ-12.5: Sample and Stress Test Data\n\n1. WHEN sample events are created (in `sample_events.dart`), THEN event titles (\"Team Standup\", \"Project Review\", \"Design Workshop\", etc.) SHALL come from `AppLocalizations` or accept localized title parameters — OR these MAY remain in English if they are treated as realistic mock data rather than UI text, at the maintainer's discretion\n2. WHEN stress test events are created (in `stress_test_events.dart`), THEN the same policy SHALL apply — localize if feasible, or document them as intentionally English mock data\n3. WHEN the Day View stress test tab creates inline sample events (\"Morning Meeting\", \"Lunch Break\"), THEN those titles SHALL follow the same policy as above\n\n##### REQ-12.6: App Title\n\n1. WHEN the example app sets `MaterialApp.title`, THEN the title SHALL come from `AppLocalizations` or a localized string\n\n##### REQ-12.7: Missing ARB Keys\n\n1. WHEN any file references an `AppLocalizations` key that does not exist in the ARB files, THEN that key SHALL be added to all 5 ARB files (en, es, fr, ar, he) with proper translations\n2. WHEN all hardcoded strings are resolved, THEN `flutter gen-l10n` SHALL pass with no errors and `flutter analyze` SHALL report no missing key references\n\n### REQ-13: Update Steering Documents\n\n**User Story:** As a package maintainer, I want the steering documents to reflect the corrected localization architecture so that future specs reference accurate patterns.\n\n#### Acceptance Criteria\n\n1. WHEN the localization changes are complete, THEN `tech.md` SHALL be updated to describe the standard `of(context)` pattern instead of the context-free wrapper pattern\n2. WHEN the localization changes are complete, THEN `structure.md` SHALL be updated to reflect the renamed utility class and the removal of `getLocalizedString()`\n3. WHEN RTL changes are complete, THEN the steering documents SHALL note that RTL detection uses `Directionality.of(context)` as the primary mechanism\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility**: The gen-l10n generated class handles string localization; the utility class handles date/time formatting — these SHALL NOT be mixed\n- **Standard Patterns**: Package SHALL follow Flutter's documented localization pattern for packages, matching how `flutter_localizations`, `syncfusion_flutter_calendar`, and other established packages work\n- **Type Safety**: All localized string access SHALL use typed getters from the generated class — no string-key-based lookups\n\n### Performance\n\n- The localization changes SHALL NOT introduce additional widget rebuilds or performance regressions\n- `MCalLocalizations.of(context)` lookups are O(1) via InheritedWidget — no performance concern\n\n### Backward Compatibility\n\n- This is version 0.0.1 with no external consumers, so breaking changes to the wrapper class are acceptable\n- The `locale` parameter on view widgets SHALL continue to function for date/time formatting, preserving the existing API surface for non-string use cases\n\n### Reliability\n\n- All 6 package ARB files (en, es, es_MX, fr, ar, he) SHALL be kept in sync with the new announcement keys\n- All 5 example app ARB files (en, es, fr, ar, he) SHALL be kept in sync with any new keys added for previously-hardcoded strings\n- `flutter gen-l10n` SHALL pass with no errors for both the package and example app after changes\n- `flutter analyze` SHALL report no errors in both the package and example app\n- All existing tests SHALL continue to pass after the localization refactor\n\n### Testing\n\n- Existing localization tests SHALL be updated to use the new `of(context)` pattern\n- New tests SHALL verify RTL keyboard navigation direction reversal for both views\n- New tests SHALL verify that SemanticsService announcements use the correct text direction\n\n### Example App Verification\n\n- After all changes, a grep/search for hardcoded English user-facing strings across the example app SHALL return zero results (excluding intentional mock data if the maintainer opts to keep sample event titles in English)\n- The example app SHALL be manually verified in at least one RTL language (Arabic or Hebrew) to confirm all text appears translated and layouts are correctly mirrored\n",
  "fileStats": {
    "size": 21330,
    "lines": 249,
    "lastModified": "2026-02-16T05:00:55.337Z"
  },
  "comments": []
}