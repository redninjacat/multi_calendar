{
  "id": "snapshot_1771218454152_w8jblissh",
  "approvalId": "approval_1771218338185_78521ovgp",
  "approvalTitle": "Design: Localizations & RTL Improvement",
  "version": 2,
  "timestamp": "2026-02-16T05:07:34.152Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design: Localizations & RTL Improvement\n\n## Overview\n\nThis design refactors the multi_calendar package's localization system from a non-standard context-free wrapper pattern to Flutter's standard `of(context)` pattern, fixes RTL keyboard navigation bugs in both MCalMonthView and MCalDayView, localizes all hardcoded English screen reader announcement strings, and completes the example app's localization by replacing remaining hardcoded strings with `AppLocalizations.of(context)` lookups.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **Localization**: tech.md currently documents the non-standard wrapper pattern. This design replaces it with the standard Flutter package localization approach: `gen-l10n` + `of(context)` + delegate wiring. The `l10n.yaml` will be updated with `synthetic-package: false` per Flutter 3.32+ requirements.\n- **Accessibility**: tech.md requires WCAG accessibility and platform-specific screen reader support. This design ensures all SemanticsService announcements are localized and use correct TextDirection.\n- **Widget-based Architecture**: The `of(context)` pattern integrates naturally with Flutter's InheritedWidget system, consistent with the controller pattern documented in tech.md.\n\n### Project Structure (structure.md)\n\n- **Naming Conventions**: The renamed utility class `MCalDateFormatUtils` follows the `MCal` prefix convention documented in structure.md.\n- **File Size**: All changes stay within the 500-line file maximum; no new files exceed guidelines.\n- **Single Responsibility**: Separating string localization (gen-l10n generated class) from date/time formatting (utility class) follows the documented single-responsibility principle.\n- **Localization Notes**: structure.md currently describes the `getLocalizedString(key, locale)` pattern — this will be updated to document `MCalLocalizations.of(context)` instead.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **Generated `MCalLocalizations`** (`lib/l10n/mcal_localizations.dart`): Already exists and is fully functional with `of(context)`, `delegate`, `supportedLocales`. Currently unused by the package widgets — this design activates it.\n- **`Directionality.of(context)`**: Already used in many places throughout both views. This design standardizes its use as the sole RTL detection mechanism in widget code.\n- **`AppLocalizations`** (example app): Already has 424 keys and is wired up in the example app. Some keys may need to be added for gaps found during the audit.\n- **Existing package ARB files** (6 locales): `lib/l10n/app_en.arb` through `app_he.arb` — will be extended with ~17 new announcement keys.\n\n### Integration Points\n\n- **`MaterialApp.localizationsDelegates`**: Example app's `main.dart` will add `MCalLocalizations.delegate` alongside existing delegates.\n- **Package widget `build()` methods**: All calls to `localizations.getLocalizedString('key', locale)` will be replaced with `MCalLocalizations.of(context).propertyName`.\n- **Example app ARB files**: New keys will be added to all 5 example ARB files for any remaining hardcoded strings.\n\n## Architecture\n\n### Change Strategy\n\nThe refactoring follows a bottom-up approach to minimize breakage:\n\n1. **Rename utility class** (no widget changes yet — just the class name and removal of `getLocalizedString`)\n2. **Update `l10n.yaml`** (add `synthetic-package: false`)\n3. **Add new ARB keys** to package (for announcement strings)\n4. **Replace `getLocalizedString` calls** in package widgets with `of(context)` lookups\n5. **Fix RTL keyboard** navigation in both views\n6. **Fix SemanticsService** announcement text direction and localize strings\n7. **Wire delegate** in example app\n8. **Fix example app** hardcoded strings\n9. **Update exports** and steering documents\n\n### RTL Arrow Key Reversal Pattern\n\nAll keyboard handlers that use left/right arrow keys for day navigation will apply an RTL multiplier:\n\n```dart\nfinal isRTL = Directionality.of(context) == TextDirection.rtl;\nfinal rtlMultiplier = isRTL ? -1 : 1;\n\nif (key == LogicalKeyboardKey.arrowLeft) {\n  dayDelta = -1 * rtlMultiplier;  // LTR: -1 (past), RTL: +1 (future)\n} else if (key == LogicalKeyboardKey.arrowRight) {\n  dayDelta = 1 * rtlMultiplier;   // LTR: +1 (future), RTL: -1 (past)\n}\n// Up/Down remain unchanged\n```\n\nThis pattern is applied in 5 locations:\n1. Month View cell navigation (`_handleKeyEvent`)\n2. Month View keyboard move mode (`_handleKeyboardMoveModeKey`)\n3. Month View keyboard resize mode (`_handleKeyboardResizeModeKey`)\n4. Day View navigation (`_handleKeyEvent` arrow left/right for prev/next day)\n5. Day View keyboard move mode (`_handleKeyboardMoveKey`)\n\n### Weekday/Month Name Lookup Pattern\n\nThe current pattern uses dynamic string keys:\n```dart\n// OLD: fragile string-key lookup\nlocalizations.getLocalizedString(weekdayKeys[dayIndex], locale)\n```\n\nSince `MCalLocalizations.of(context)` provides typed getters (`.daySunday`, `.dayMonday`, etc.), dynamic lookup requires a helper. The renamed `MCalDateFormatUtils` will provide index-based accessors:\n\n```dart\nclass MCalDateFormatUtils {\n  /// Returns localized weekday name for the given day index (0=Sunday..6=Saturday)\n  static String weekdayName(MCalLocalizations l10n, int dayOfWeek) {\n    switch (dayOfWeek) {\n      case 0: return l10n.daySunday;\n      case 1: return l10n.dayMonday;\n      // ...\n    }\n  }\n\n  /// Returns localized short weekday name (0=Sun..6=Sat)\n  static String weekdayShortName(MCalLocalizations l10n, int dayOfWeek) { ... }\n\n  /// Returns localized month name (1=January..12=December)\n  static String monthName(MCalLocalizations l10n, int month) { ... }\n}\n```\n\nThis preserves type safety while supporting the dynamic lookup pattern needed by the weekday header and navigator widgets.\n\n## Components and Interfaces\n\n### Component 1: MCalDateFormatUtils (renamed from MCalLocalizations wrapper)\n\n- **File**: `lib/src/utils/mcal_date_format_utils.dart` (renamed from `mcal_localization.dart`)\n- **Purpose**: Date/time formatting utilities and index-based localization accessors. No longer performs string-key-based localization lookup.\n- **Interfaces**:\n  - `String formatDate(DateTime date, Locale locale)` — retained\n  - `String formatTime(DateTime time, Locale locale)` — retained\n  - `String formatMonthYear(DateTime date, Locale locale)` — retained\n  - `String formatFullDateWithDayName(DateTime date, Locale locale)` — retained\n  - `String formatMultiDaySpanLabel(MCalLocalizations l10n, int spanLength, int dayPosition)` — updated to take l10n instance instead of locale\n  - `bool isRTL(Locale locale)` — retained for context-free use cases\n  - `static String weekdayName(MCalLocalizations l10n, int dayOfWeek)` — NEW\n  - `static String weekdayShortName(MCalLocalizations l10n, int dayOfWeek)` — NEW\n  - `static String monthName(MCalLocalizations l10n, int month)` — NEW\n  - `static List<Locale> get supportedLocales` — retained\n- **Removed**:\n  - `getLocalizedString(String key, Locale locale)` — deleted\n  - `_lookup(Locale locale)` — deleted (no longer bypasses widget tree)\n- **Dependencies**: `intl` package for date formatting, `MCalLocalizations` generated class for index-based accessors\n- **Reuses**: All existing formatting logic, just removes the string lookup layer\n\n### Component 2: Package ARB Files (expanded)\n\n- **Files**: `lib/l10n/app_en.arb`, `app_es.arb`, `app_es_MX.arb`, `app_fr.arb`, `app_ar.arb`, `app_he.arb`\n- **Purpose**: Add ~17 new localization keys for screen reader announcement strings\n- **New keys** (parameterized where needed):\n\n| Key | English Value | Parameters |\n|-----|--------------|------------|\n| `announcementResizeCancelled` | \"Resize cancelled\" | — |\n| `announcementMoveCancelled` | \"Move cancelled for {title}\" | title |\n| `announcementEventSelectionCancelled` | \"Event selection cancelled\" | — |\n| `announcementEventsHighlighted` | \"{count} events. {title} highlighted. Tab to cycle, Enter to confirm.\" | count, title |\n| `announcementEventSelected` | \"Selected {title}. Arrow keys to move, Enter to confirm, Escape to cancel.\" | title |\n| `announcementEventCycled` | \"{title}. {index} of {total}.\" | title, index, total |\n| `announcementMovingEvent` | \"Moving {title} to {date}\" | title, date |\n| `announcementResizeModeEntered` | \"Resize mode. Adjusting end edge. Arrow keys to resize, S for start, E for end, M for move mode, Enter to confirm.\" | — |\n| `announcementResizingStartEdge` | \"Resizing start edge\" | — |\n| `announcementResizingEndEdge` | \"Resizing end edge\" | — |\n| `announcementMoveMode` | \"Move mode\" | — |\n| `announcementMoveInvalidTarget` | \"Move cancelled. Invalid target.\" | — |\n| `announcementEventMoved` | \"Moved {title} to {date}\" | title, date |\n| `announcementResizingProgress` | \"Resizing {title} {edge} to {date}, {days} days\" | title, edge, date, days |\n| `announcementResizeInvalid` | \"Resize cancelled. Invalid resize.\" | — |\n| `announcementEventResized` | \"Resized {title} to {start} through {end}\" | title, start, end |\n\n### Component 3: MCalMonthView (localization + RTL fixes)\n\n- **File**: `lib/src/widgets/mcal_month_view.dart`\n- **Changes**:\n  1. Replace all `MCalLocalizations()` instantiations with `MCalLocalizations.of(context)` from gen-l10n import (11 instances)\n  2. Replace all `getLocalizedString('key', locale)` calls with typed getters: `l10n.today`, `l10n.calendar`, `l10n.dropTargetPrefix`, etc. (14 calls)\n  3. Replace `localizations.isRTL(locale)` with `Directionality.of(context) == TextDirection.rtl` in all widget build methods (keep `isRTL()` only in the navigator/header widgets that have their own locale parameter and no parent Directionality)\n  4. Fix `_announceMonthChange`: replace hardcoded `TextDirection.ltr` with `Directionality.of(context)`\n  5. Localize all hardcoded SemanticsService announcement strings using new ARB keys\n  6. Fix `_handleKeyEvent` keyboard navigation: apply RTL multiplier to arrowLeft/arrowRight day delta\n  7. Fix `_handleKeyboardMoveModeKey`: apply RTL multiplier to arrowLeft/arrowRight day delta\n  8. Fix `_handleKeyboardResizeModeKey`: apply RTL multiplier to arrowLeft/arrowRight day delta\n  9. Use `MCalDateFormatUtils.weekdayShortName(l10n, dayIndex)` for weekday header names (replacing `getLocalizedString(weekdayKeys[dayIndex], locale)`)\n  10. Use `MCalDateFormatUtils.monthName(l10n, month)` for navigator month name\n- **Dependencies**: `MCalLocalizations` (gen-l10n generated), `MCalDateFormatUtils`\n- **RTL locations to fix**:\n  - `_handleKeyEvent` ~line 1823 (cell navigation)\n  - `_handleKeyboardMoveModeKey` ~line 2159 (move mode)\n  - `_handleKeyboardResizeModeKey` ~line 2556 (resize mode)\n\n### Component 4: MCalDayView (localization + RTL fixes)\n\n- **File**: `lib/src/widgets/mcal_day_view.dart`\n- **Changes**:\n  1. Replace all `MCalLocalizations()` instantiations with `MCalLocalizations.of(context)` (6 instances)\n  2. Replace all `getLocalizedString('key', locale)` calls with typed getters (14 calls)\n  3. Replace `localizations.isRTL(locale)` with `Directionality.of(context) == TextDirection.rtl` in widget build methods\n  4. Fix keyboard navigation ~line 1545-1553: reverse arrowLeft/arrowRight for prev/next day in RTL\n  5. Fix keyboard move mode ~line 1596-1600: reverse arrowLeft/arrowRight day delta in RTL\n  6. Navigator widget already handles RTL for button layout — verify it works correctly with `Directionality.of(context)` instead of `isRTL(locale)`\n- **Dependencies**: `MCalLocalizations` (gen-l10n generated), `MCalDateFormatUtils`\n- **RTL locations to fix**:\n  - `_handleNormalKeyEvent` ~line 1548 (arrowLeft/arrowRight navigation)\n  - `_handleKeyboardMoveKey` ~line 1596 (move mode arrowLeft/arrowRight)\n\n### Component 5: l10n.yaml Update\n\n- **File**: `l10n.yaml`\n- **Change**: Add `synthetic-package: false`\n- **Result**:\n  ```yaml\n  arb-dir: lib/l10n\n  template-arb-file: app_en.arb\n  output-localization-file: mcal_localizations.dart\n  output-class: MCalLocalizations\n  nullable-getter: false\n  synthetic-package: false\n  ```\n\n### Component 6: Package Exports Update\n\n- **File**: `lib/multi_calendar.dart`\n- **Changes**:\n  1. Replace `export 'src/utils/mcal_localization.dart'` with `export 'src/utils/mcal_date_format_utils.dart'`\n  2. Add `export 'l10n/mcal_localizations.dart'` to export the generated class (`MCalLocalizations` with `of`, `delegate`, `supportedLocales`, `localizationsDelegates`)\n- **Result**: Consuming apps can import both `MCalLocalizations` and `MCalDateFormatUtils` from the single package import\n\n### Component 7: Example App Delegate Wiring\n\n- **File**: `example/lib/main.dart`\n- **Changes**:\n  1. Import `package:multi_calendar/multi_calendar.dart` (or just the generated localizations file)\n  2. Add `MCalLocalizations.delegate` to `localizationsDelegates`:\n     ```dart\n     localizationsDelegates: [\n       ...AppLocalizations.localizationsDelegates,\n       MCalLocalizations.delegate,\n     ],\n     ```\n  3. Localize the app title: `title: AppLocalizations.of(context)?.appTitle ?? 'Multi Calendar Examples'` (or use `onGenerateTitle`)\n\n### Component 8: Example App Hardcoded String Fixes\n\n14 files need modifications. The changes are grouped by type:\n\n#### 8a. Control Panel Labels (month_features_tab.dart, day_features_tab.dart, day_theme_tab.dart)\n\nReplace all hardcoded section headers and setting labels with `AppLocalizations.of(context)!` lookups. These files already import AppLocalizations but have sections where the localization calls were missed. Existing ARB keys from the 424 already cover most section and setting labels (e.g., `sectionNavigation`, `settingShowNavigator`, etc.). For `day_theme_tab.dart`, remove the null-check fallback pattern and use `AppLocalizations.of(context)!` directly.\n\n#### 8b. SnackBar Messages (month_features_tab.dart, day_features_tab.dart, day_*_style.dart files)\n\nReplace hardcoded SnackBar messages with parameterized `AppLocalizations` lookups. Existing keys like `snackbarCellTap`, `snackbarEventDropped`, etc. should already be in the ARB files — verify and add any missing ones.\n\n#### 8c. Accessibility Content (month_accessibility_tab.dart)\n\nReplace all hardcoded keyboard shortcut labels, screen reader guide text, checklist items, and navigation flow descriptions with `AppLocalizations.of(context)!` lookups. This requires the most new ARB keys — approximately 40-50 strings. Check existing keys (the `accessibility*` prefix group has 68 keys) and add any that are missing.\n\n#### 8d. Style Widget Text (month_classic_style.dart, month_modern_style.dart)\n\nReplace \"Prev\", \"Next\", and \"Today\" with `AppLocalizations.of(context)!` lookups or use package-level localized strings from `MCalLocalizations.of(context)`.\n\n#### 8e. Sample/Stress Test Data (sample_events.dart, stress_test_events.dart, day_stress_test_tab.dart)\n\nThese are mock data event titles. Per REQ-12.5, the maintainer may choose to keep them in English as realistic mock data. If localization is desired, the generator functions would need to accept a `BuildContext` or localized title list parameter. The design recommendation is to **keep sample event titles in English** (they represent real-world event data from English-speaking organizations) and add a code comment documenting this decision.\n\n#### 8f. App Title (main.dart)\n\nUse `onGenerateTitle` callback:\n```dart\nonGenerateTitle: (context) => AppLocalizations.of(context)?.appTitle ?? 'Multi Calendar Examples',\n```\n\n### Component 9: Locale Alignment\n\n- **Decision**: Remove `es_MX` from the package to align with the example app's 5-locale set (en, es, fr, ar, he). Mexican Spanish is a minor variant that adds maintenance burden without significant value at this stage.\n- **Files affected**: Delete `lib/l10n/app_es_MX.arb`, update `l10n.yaml` if needed\n- **Alternative**: If maintaining es_MX is preferred, add `example/lib/l10n/app_es_MX.arb` instead. The design defers this decision to the maintainer.\n\n### Component 10: Steering Documents\n\n- **`tech.md`**: Update the \"Localization\" section under Key Dependencies to describe the `of(context)` pattern. Replace references to `getLocalizedString(key, locale)` with `MCalLocalizations.of(context).propertyName`. Update the `MCalLocalizations` description to say it's the gen-l10n generated class. Note that `MCalDateFormatUtils` handles formatting only. Update RTL description to note `Directionality.of(context)` as primary mechanism.\n- **`structure.md`**: Update the Utilities section to describe `MCalDateFormatUtils` instead of the old `MCalLocalizations` wrapper. Remove mention of `getLocalizedString`. Update the localization notes under External Integration Points.\n\n## Data Models\n\nNo new data models are introduced. The only model-level change is adding new string keys to ARB files (JSON format), which are compiled into the existing generated `MCalLocalizations` class by `gen-l10n`.\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Consuming app does not wire `MCalLocalizations.delegate`**\n   - **Handling**: `MCalLocalizations.of(context)` will throw a `FlutterError` with a message like: \"No MCalLocalizations found. Please add MCalLocalizations.delegate to your app's localizationsDelegates.\"\n   - **User Impact**: Clear crash with actionable error message during development. This is consistent with how `MaterialLocalizations.of(context)` behaves.\n   - **Note**: The generated class already throws when the delegate is missing (via the `!` operator on `Localizations.of<MCalLocalizations>(context, MCalLocalizations)!`). We just need to ensure the error message is clear.\n\n2. **Locale not supported by the package**\n   - **Handling**: gen-l10n's delegate automatically falls back to the closest supported locale. If the app's locale is `de` (German, not supported), it falls back to `en`.\n   - **User Impact**: English strings appear instead of the unsupported language. No crash.\n\n3. **Missing ARB key in translation file**\n   - **Handling**: `flutter gen-l10n` will fail at compile time if a key exists in the template (`app_en.arb`) but not in a translation file.\n   - **User Impact**: Build error with clear message identifying the missing key and file.\n\n## Testing Strategy\n\n### Unit Testing\n\n- Update `test/utils/localization_test.dart` to test `MCalDateFormatUtils` (renamed class) — verify `formatDate`, `formatTime`, `formatMonthYear`, `weekdayName`, `weekdayShortName`, `monthName`\n- Add tests for `isRTL()` utility method\n\n### Widget Testing\n\n- **RTL keyboard navigation tests** (new):\n  - Month View: Verify arrowLeft = +1 day when wrapped in `Directionality(textDirection: TextDirection.rtl)`\n  - Month View: Verify arrowRight = -1 day in RTL\n  - Month View: Verify arrowLeft = -1 day in LTR (regression)\n  - Month View: Verify arrowUp/arrowDown unaffected by RTL\n  - Day View: Verify arrowLeft = next day in RTL\n  - Day View: Verify arrowRight = previous day in RTL\n  - Day View keyboard move: Verify day shift reversal in RTL\n  - Month View keyboard move: Verify day shift reversal in RTL\n  - Month View keyboard resize: Verify delta reversal in RTL\n\n- **Localization pattern tests** (update existing):\n  - Verify `MCalLocalizations.of(context)` works when delegate is wired\n  - Verify correct locale-specific strings appear\n\n### Integration Testing\n\n- `flutter gen-l10n` passes for both package and example app\n- `flutter analyze` passes for both package and example app\n- `flutter build apk --debug` passes for example app\n- Grep for `getLocalizedString` in `lib/src/` returns zero results\n- Grep for hardcoded English user-facing strings in new example app files returns zero results (excluding intentional mock data)\n\n### End-to-End Testing\n\n- Manual: Run example app in Arabic (ar) — verify all text is Arabic, layout is RTL\n- Manual: Use keyboard navigation in Arabic locale — verify arrow keys move in visual direction\n- Manual: Switch between all 5 languages — verify no missing strings or fallback text\n- Manual: Verify screen reader announcements use correct language (test via accessibility inspector)\n",
  "fileStats": {
    "size": 20045,
    "lines": 327,
    "lastModified": "2026-02-16T05:05:32.225Z"
  },
  "comments": []
}