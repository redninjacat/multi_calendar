{
  "id": "snapshot_1770942321398_ap6zcazj4",
  "approvalId": "approval_1770941976130_qyox4jm76",
  "approvalTitle": "Month View Polish - Requirements Document",
  "version": 2,
  "timestamp": "2026-02-13T00:25:21.397Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document: Month View Polish\n\n## Introduction\n\nThis specification addresses four remaining gaps in the MCalMonthView implementation: event resizing via edge-dragging, system reduced-motion preference integration, keyboard-based event moving as a drag-and-drop accessibility alternative, and enriched semantic labels for multi-day events. These items were identified during a comprehensive audit of all steering documents, archived specs, and the active recurring-events spec against the current implementation.\n\nEvent resizing was explicitly deferred by the month-view and month-view-enhancements-part-2 specs (\"future spec for desktop/web\") and is now ready for implementation. The remaining three items are accessibility and polish requirements from the month-view-enhancements-part-2 non-functional requirements that were not implemented during that spec's lifecycle.\n\n## Alignment with Product Vision\n\n* **Customization First**: Event resizing is configurable per platform and overridable by the developer. The animation behavior respects system preferences by default but remains developer-overridable.\n* **Accessibility First**: Keyboard-based event moving provides a drag-and-drop alternative for users who cannot use pointer-based dragging. Multi-day semantic labels give screen reader users full context about event spans. Reduced motion respects system accessibility settings.\n* **Mobile-First Design**: Event resizing defaults to disabled on phones (small touch targets) but enabled on tablets, desktops, and web — matching platform conventions.\n* **Developer-Friendly**: The animation API is refactored to co-exist cleanly with the system accessibility preference, with a clear precedence model that is easy to understand.\n* **Performance Conscious**: Edge-drag resizing uses the same debounced position tracking as the existing unified DragTarget architecture to maintain 60fps.\n\n## Requirements\n\n### Requirement 1: Event Edge-Drag Resizing\n\n**User Story:** As a user, I want to drag the left or right edge of an event tile to change its start or end date, so that I can quickly adjust event durations without opening an editor.\n\n#### Acceptance Criteria\n\n##### Enabling and Disabling\n\n1. WHEN configuring MCalMonthView THEN it SHALL accept an `enableEventResize` parameter of type `bool?` (nullable).\n2. WHEN `enableEventResize` is `true` THEN edge-drag resizing SHALL be enabled regardless of platform.\n3. WHEN `enableEventResize` is `false` THEN edge-drag resizing SHALL be disabled regardless of platform.\n4. WHEN `enableEventResize` is `null` (the default) THEN the system SHALL auto-detect the platform and enable resizing on web, desktop (macOS, Windows, Linux), and tablets, but disable it on phones.\n5. WHEN `enableDragAndDrop` is `false` THEN edge-drag resizing SHALL also be disabled, regardless of `enableEventResize`, because the resize interaction requires the drag infrastructure.\n6. The system SHALL determine phone vs tablet using a width-based heuristic (e.g., shortest side >= 600dp = tablet) consistent with Material Design breakpoints. This is a rough heuristic and does not need to be exact.\n\n##### Resize Interaction\n\n7. WHEN the user drags the leading edge (left in LTR, right in RTL) of an event tile THEN the system SHALL adjust the event's **start date** while keeping the end date fixed.\n8. WHEN the user drags the trailing edge (right in LTR, left in RTL) of an event tile THEN the system SHALL adjust the event's **end date** while keeping the start date fixed.\n9. WHEN resizing THEN the system SHALL enforce a minimum event duration of 1 calendar day. The start date SHALL NOT be dragged past the end date, and vice versa.\n10. WHEN calculating new dates during resize THEN the system SHALL use calendar-day arithmetic (`DateTime(year, month, day + delta)`) rather than `Duration`-based arithmetic, to avoid DST-related bugs (consistent with existing DST workarounds in keyboard navigation and drag-and-drop).\n11. WHEN the user initiates a resize drag THEN the system SHALL provide a visual resize handle at the event tile edges. The handle SHALL be a small drag affordance (e.g., a vertical line or grip indicator) visible on hover or always visible, depending on platform.\n12. WHEN the resize handle area is too small for reliable touch interaction on mobile THEN this is acceptable because `enableEventResize` defaults to `false` on phones. On tablets, event tiles are generally large enough for edge interaction.\n\n##### Visual Feedback\n\n13. WHEN a resize operation is in progress THEN the system SHALL show a preview of the new event span (similar to drop target tiles) that updates in real-time as the user drags.\n14. WHEN a resize would result in an invalid state (e.g., less than 1 day, or rejected by validation callback) THEN the system SHALL show invalid visual feedback (consistent with existing drag-and-drop invalid styling).\n\n##### Resize Validation and Completion\n\n15. WHEN configuring MCalMonthView THEN it SHALL accept an `onResizeWillAccept` callback:\n    * Signature: `bool Function(BuildContext context, MCalResizeWillAcceptDetails details)?`\n    * `MCalResizeWillAcceptDetails` SHALL include: `event`, `proposedStartDate`, `proposedEndDate`, `resizeEdge` (enum: `start`, `end`)\n    * Returns `true` to allow the resize, `false` to reject\n    * Default: if callback not provided, resize is accepted\n16. WHEN configuring MCalMonthView THEN it SHALL accept an `onEventResized` callback:\n    * Signature: `bool Function(BuildContext context, MCalEventResizedDetails details)?`\n    * `MCalEventResizedDetails` SHALL include: `event`, `oldStartDate`, `oldEndDate`, `newStartDate`, `newEndDate`, `resizeEdge`, `isRecurring`, `seriesId`\n    * Returns `true` to confirm the resize, `false` to reject and revert\n    * Default: if callback not provided, resize is confirmed\n17. WHEN `onEventResized` returns `true` (or is not provided) THEN the controller SHALL update the event with the new dates.\n18. WHEN `onEventResized` returns `false` THEN the event SHALL revert to its original dates.\n\n##### Recurring Event Integration\n\n19. WHEN the user resizes an occurrence of a recurring event THEN the controller SHALL create a `modified` exception for that occurrence (with the updated start/end dates), consistent with how drag-and-drop creates `rescheduled` exceptions for moves.\n20. WHEN building `MCalEventResizedDetails` for a recurring occurrence THEN the system SHALL populate `isRecurring` and `seriesId` fields so the consuming app can handle recurring resizes differently if needed.\n\n##### Cross-Week Resize Behavior\n\n21. WHEN the user drags an event edge past a week row boundary THEN the resize preview SHALL extend into the adjacent week row(s), consistent with how multi-day events already render across rows.\n22. WHEN the user drags an event edge to the calendar's left/right edge THEN the system SHALL NOT trigger cross-month edge navigation (unlike drag-and-drop moves). Resizing is bounded to the visible month's dates.\n\n##### RTL Support\n\n23. WHEN the calendar is in RTL mode THEN the start edge SHALL be on the right and the end edge SHALL be on the left, consistent with the visual direction.\n\n### Requirement 2: System Reduced Motion Preference\n\n**User Story:** As a user with motion sensitivity, I want the calendar to automatically respect my system's reduced motion preference, so that animations are disabled without manual configuration.\n\n#### Acceptance Criteria\n\n##### Automatic Detection\n\n1. WHEN the system's reduced motion accessibility setting is enabled THEN MCalMonthView SHALL automatically disable all animations (month transitions, drag feedback, etc.) without requiring the developer to set any property.\n2. WHEN the system's reduced motion setting is disabled THEN MCalMonthView SHALL use animations normally (subject to the developer's configuration).\n3. The system SHALL detect reduced motion via `MediaQuery.accessibilityFeaturesOf(context).reduceMotion` (or equivalent Flutter API).\n\n##### Refactored Animation Control\n\n4. The existing `enableAnimations` parameter SHALL be refactored to be a nullable `bool?` (from non-nullable `bool`):\n   * WHEN `enableAnimations` is `null` (the new default) THEN the system SHALL respect the OS reduced motion preference: animations enabled when OS says normal, disabled when OS says reduce motion.\n   * WHEN `enableAnimations` is `true` THEN animations SHALL be force-enabled regardless of OS setting (developer override).\n   * WHEN `enableAnimations` is `false` THEN animations SHALL be force-disabled regardless of OS setting (developer override, backward compatible with current `false` usage).\n5. The `animationDuration` and `animationCurve` parameters SHALL continue to work as before — they configure the animation when animations are active.\n6. The `setDisplayDate(date, animate: true/false)` and `navigateToDateWithoutAnimation()` methods on the controller SHALL continue to work as before — `animate: false` always skips animation regardless of the `enableAnimations` setting.\n\n##### Behavioral Impact\n\n7. WHEN animations are disabled (by any mechanism) THEN month transitions SHALL be instant (jump, no slide).\n8. WHEN animations are disabled THEN all other animated behaviors in MCalMonthView SHALL also be affected (consistent behavior).\n\n### Requirement 3: Keyboard-Based Event Moving\n\n**User Story:** As a keyboard user or screen reader user, I want to move events between dates using keyboard shortcuts, so that I have an accessible alternative to drag-and-drop.\n\n#### Acceptance Criteria\n\n##### Activation and Flow\n\n1. WHEN `enableDragAndDrop` is `true` AND `enableKeyboardNavigation` is `true` THEN the keyboard event-move feature SHALL be available.\n2. WHEN the user presses Enter or Space on a focused day cell containing events THEN the system SHALL enter \"event selection mode\" if there are movable events in the cell.\n3. WHEN in event selection mode THEN the system SHALL visually highlight the selected event and provide a screen reader announcement (\"Selected [event title], use arrow keys to move, Enter to confirm, Escape to cancel\").\n4. IF the cell contains multiple events THEN the system SHALL allow cycling through events with Tab/Shift+Tab before confirming selection with Enter.\n5. WHEN an event is selected for moving THEN arrow keys SHALL move the event by one day (Left/Right) or one week (Up/Down), showing a preview of the new position (reusing the existing drop target tile and overlay system).\n6. WHEN the user presses Enter THEN the move SHALL be confirmed (following the same `onEventDropped` callback flow as drag-and-drop).\n7. WHEN the user presses Escape THEN the move SHALL be cancelled and the event SHALL return to its original position.\n8. WHEN a keyboard move is confirmed for a recurring event occurrence THEN the system SHALL create a `rescheduled` exception, consistent with drag-and-drop behavior.\n\n##### Validation\n\n9. WHEN the user moves an event via keyboard to a new date THEN the system SHALL call `onDragWillAccept` (if provided) with the proposed new date range, reusing the same validation flow as drag-and-drop.\n10. WHEN `onDragWillAccept` returns `false` THEN the move preview SHALL show invalid feedback and Enter SHALL not confirm the move.\n\n##### Boundaries\n\n11. WHEN keyboard-moving an event past the visible month boundary THEN the system SHALL navigate to the adjacent month (similar to edge navigation in drag-and-drop) and continue the move operation.\n12. WHEN keyboard-moving an event THEN `minDate` and `maxDate` restrictions SHALL be respected.\n\n##### Accessibility Announcements\n\n13. WHEN the user moves an event via keyboard THEN the screen reader SHALL announce each proposed position (\"Moving [event title] to [date]\").\n14. WHEN the move is confirmed THEN the screen reader SHALL announce \"Moved [event title] to [date]\".\n15. WHEN the move is cancelled THEN the screen reader SHALL announce \"Move cancelled\".\n\n### Requirement 4: Multi-Day Event Semantic Span Information\n\n**User Story:** As a screen reader user, I want multi-day event tiles to announce their span information (e.g., \"3-day event, day 2 of 3\"), so that I understand the full context of events that span multiple days.\n\n#### Acceptance Criteria\n\n1. WHEN a screen reader reads a multi-day event tile THEN the semantic label SHALL include span information in addition to the event title and time.\n2. The span information SHALL include:\n   * Total duration in days (e.g., \"3-day event\")\n   * Position within the span (e.g., \"day 2 of 3\")\n   * Whether this is the start, continuation, or end of the event\n3. WHEN building the semantic label for a multi-day event THEN the system SHALL follow a similar pattern to the existing drop target semantic labels (`_buildDropTargetSemanticLabel`), which already include date range information for multi-day drags. Specifically, the label format SHALL be: `\"{event title}, {time info}, {N}-day event, day {M} of {N}\"` — e.g., \"Team Offsite, All day, 3-day event, day 2 of 3\".\n4. WHEN a single-day event tile is read by a screen reader THEN the semantic label SHALL remain unchanged (no span info added).\n5. The span information SHALL be localized using the existing `MCalLocalizations` infrastructure.\n6. The `isStartOfSpan`, `isEndOfSpan`, and `spanLength` fields already available on `_EventTileWidget` SHALL be used to construct the span label — no new data plumbing is needed.\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n* **Single Responsibility**: Resize logic SHALL be encapsulated in dedicated handler methods (or a resize handler class/mixin), separate from the drag-and-drop move logic in `MCalDragHandler`.\n* **Modular Design**: The resize visual feedback (preview tiles, handle affordance) SHALL reuse existing infrastructure (drop target tiles, overlay system) where possible.\n* **DST Safety**: All date arithmetic for resizing SHALL use `DateTime(year, month, day + delta)` constructor form, never `Duration(days: N)` addition, consistent with established DST-safe patterns throughout the codebase.\n* **Backward Compatibility**: The `enableAnimations` refactor from `bool` to `bool?` SHALL not break existing code that passes `true` or `false` — both values retain their current meaning.\n\n### Performance\n\n* Resize interactions SHALL maintain 60fps rendering on mid-range mobile devices.\n* Resize position updates SHALL use the same debounced approach as drag-and-drop (16ms threshold).\n* Reduced motion detection via `MediaQuery` SHALL not cause additional rebuilds beyond what already occurs from the accessibility framework.\n\n### Reliability\n\n* Resize operations SHALL handle all edge cases: events at month boundaries, events on the first/last visible day, events spanning 1 day (at minimum), and rapid resize gestures.\n* Keyboard event moving SHALL handle month boundary transitions seamlessly.\n* All existing drag-and-drop tests SHALL continue to pass unchanged.\n\n### Usability\n\n* Resize handles SHALL be discoverable — visible on hover for pointer devices, or as a subtle visual indicator for touch.\n* The keyboard event-move flow SHALL be intuitive and follow platform conventions for keyboard-based item manipulation.\n* Screen reader announcements SHALL be concise but complete, avoiding excessive verbosity.\n\n### Accessibility\n\n* All new interactions (resize, keyboard move) SHALL have appropriate semantic labels and announcements.\n* Reduced motion SHALL be the default behavior when the OS setting is enabled — users should not need to configure anything.\n* Keyboard event moving provides a complete alternative to mouse/touch drag-and-drop for users who cannot use pointer-based interactions.\n",
  "fileStats": {
    "size": 15689,
    "lines": 184,
    "lastModified": "2026-02-13T00:19:30.616Z"
  },
  "comments": []
}