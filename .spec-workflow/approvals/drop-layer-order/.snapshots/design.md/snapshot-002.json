{
  "id": "snapshot_1770864777485_fr2h5ngp8",
  "approvalId": "approval_1770864193327_b8pemclkk",
  "approvalTitle": "Design: Drop Layer Order",
  "version": 2,
  "timestamp": "2026-02-12T02:52:57.485Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: Drop Layer Order\n\n## Overview\n\nThis feature adds a single boolean property (`dropTargetTilesAboveOverlay`) to `MCalMonthView` that controls the rendering order of the two drag-feedback layers in the month view's `Stack`. It also renames all internal identifiers that embed hard-coded layer numbers (\"Layer3\"/\"Layer4\") to descriptive, number-free names. The change is entirely within `mcal_month_view.dart` — no other source files are affected.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Widget-based Architecture / Builder Pattern**: The new property follows the established pattern of boolean toggles on `MCalMonthView` (e.g., `showDropTargetTiles`, `showDropTargetOverlay`). It is a simple declarative configuration that the widget tree passes down to `_MonthPageWidget`.\n- **Performance Conscious**: No additional widgets, layout passes, or rendering work — only the insertion order of two existing `Positioned.fill` children changes.\n\n### Project Structure (structure.md)\n- All changes are scoped to `lib/src/widgets/mcal_month_view.dart` (the private methods) and the public constructor of `MCalMonthView`. No new files are created.\n- Test additions go into the existing `test/` directory alongside existing month view tests.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`MCalMonthView` constructor**: Already has `showDropTargetTiles` and `showDropTargetOverlay` boolean properties; the new `dropTargetTilesAboveOverlay` follows the identical pattern.\n- **`_MonthPageWidget`**: Already receives both booleans and builds the `Stack` with conditionally-included layers. The Stack children list is the single place where order is determined.\n\n### Integration Points\n- **`MCalMonthView` → `_MonthPageWidget` parameter passing**: The property flows through `_buildPageView` → `_MonthPageWidget(...)` constructor, just like the existing drop-target booleans (see lines ~1178-1179, ~2059-2060 of `mcal_month_view.dart`).\n\n## Architecture\n\nThe change is minimal and localized. The conceptual model:\n\n```\nMCalMonthView\n  └── dropTargetTilesAboveOverlay: bool (default false)\n        ↓ passed to\n      _MonthPageWidget\n        ↓ used in build()\n      Stack children order:\n        [0] weekRowsColumn (always first — base content)\n        [1] tilesLayer or overlayLayer  ← order controlled by the bool\n        [2] overlayLayer or tilesLayer\n```\n\n### Current Stack Order (default, `dropTargetTilesAboveOverlay: false`)\n```\nStack:\n  [0] weekRowsColumn          // Base grid + events\n  [1] dropTargetTilesLayer    // Preview tiles (formerly \"Layer 3\")\n  [2] dropTargetOverlayLayer  // Highlight overlay (formerly \"Layer 4\")\n```\n\n### Reversed Stack Order (`dropTargetTilesAboveOverlay: true`)\n```\nStack:\n  [0] weekRowsColumn          // Base grid + events\n  [1] dropTargetOverlayLayer  // Highlight overlay rendered first (below)\n  [2] dropTargetTilesLayer    // Preview tiles rendered second (above)\n```\n\n## Components and Interfaces\n\n### MCalMonthView (public widget — modified)\n\n- **Change**: Add `dropTargetTilesAboveOverlay` parameter to constructor.\n- **Interface**:\n  ```dart\n  /// When true, the drop target tiles layer renders above the drop target\n  /// overlay layer during drag-and-drop. When false (default), tiles render\n  /// below the overlay.\n  ///\n  /// By default, drop target tiles are Layer 3 and the overlay is Layer 4.\n  /// Setting this to true reverses their order.\n  final bool dropTargetTilesAboveOverlay;\n  ```\n- **Default**: `false`\n- **Dependencies**: None new; flows to `_MonthPageWidget`.\n\n### _MonthPageWidget (private widget — modified)\n\n- **Change 1**: Accept `dropTargetTilesAboveOverlay` parameter.\n- **Change 2**: In the `build()` method's Stack, use the boolean to determine which layer widget is inserted first.\n- **Implementation approach**:\n  ```dart\n  // Build both layer widgets (only if active)\n  final tilesLayer = (widget.showDropTargetTiles && _isDragActive)\n      ? Positioned.fill(\n          child: RepaintBoundary(\n            child: IgnorePointer(\n              child: _buildDropTargetTilesLayer(context),\n            ),\n          ),\n        )\n      : null;\n\n  final overlayLayer = (widget.showDropTargetOverlay && _isDragActive)\n      ? Positioned.fill(\n          child: RepaintBoundary(\n            child: IgnorePointer(\n              child: _buildDropTargetOverlayLayer(context),\n            ),\n          ),\n        )\n      : null;\n\n  // Insert in order based on the toggle\n  final first = widget.dropTargetTilesAboveOverlay ? overlayLayer : tilesLayer;\n  final second = widget.dropTargetTilesAboveOverlay ? tilesLayer : overlayLayer;\n\n  return Stack(\n    children: [\n      weekRowsColumn,\n      if (first != null) first,\n      if (second != null) second,\n    ],\n  );\n  ```\n\n### Identifier Renames (private methods — renamed)\n\n| Current Name | New Name | Rationale |\n|---|---|---|\n| `_buildLayer3DropTargetTiles` | `_buildDropTargetTilesLayer` | Removes \"Layer3\"; \"Layer\" suffix indicates it builds a full stack layer |\n| `_buildLayer4HighlightOverlay` | `_buildDropTargetOverlayLayer` | Removes \"Layer4\"; consistent naming with tiles layer |\n| `_buildDropTargetTileBuilderForLayer3` | `_buildDropTargetTileEventBuilder` | Removes \"ForLayer3\"; \"EventBuilder\" clarifies it returns a `MCalEventTileBuilder` |\n| `_buildLayer3DateLabelPlaceholder` (top-level) | `_buildDropTargetDateLabelPlaceholder` | Removes \"Layer3\"; top-level helper, same file |\n\nAll call sites within `mcal_month_view.dart` are updated to use the new names. No public API is affected.\n\n## Data Models\n\nNo new data models. The only addition is a `bool` field on two existing widget classes.\n\n## Error Handling\n\n### Error Scenarios\n1. **Invalid combination**: `dropTargetTilesAboveOverlay: true` with both `showDropTargetTiles` and `showDropTargetOverlay` set to `false`.\n   - **Handling**: No error — the property is silently ignored because neither layer is built.\n   - **User Impact**: None.\n\n2. **Only one layer visible**: e.g. `showDropTargetTiles: true`, `showDropTargetOverlay: false`.\n   - **Handling**: Only the visible layer is added to the Stack. `dropTargetTilesAboveOverlay` has no observable effect since there is only one layer.\n   - **User Impact**: None.\n\n## Testing Strategy\n\n### Unit Testing\n- **Default order preserved**: Verify that with `dropTargetTilesAboveOverlay: false` (or unset), the Stack children order matches current behavior (tiles before overlay).\n- **Reversed order**: Verify that with `dropTargetTilesAboveOverlay: true`, the overlay widget appears before the tiles widget in the Stack children list.\n- **Single layer visible**: Verify correct behavior when only one of the two layers is shown.\n\n### Existing Tests\n- All 121 existing month view tests must continue to pass unchanged, since the default value preserves current behavior.\n- Renamed methods are private, so no test file references to update (tests interact via the public widget API).\n",
  "fileStats": {
    "size": 6994,
    "lines": 152,
    "lastModified": "2026-02-12T02:43:09.173Z"
  },
  "comments": []
}