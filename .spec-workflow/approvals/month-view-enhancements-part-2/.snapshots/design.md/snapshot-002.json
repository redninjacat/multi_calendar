{
  "id": "snapshot_1769997931077_0njn6qkmi",
  "approvalId": "approval_1769997534891_n63g0oex4",
  "approvalTitle": "Month View Enhancements Part 2 - Design",
  "version": 2,
  "timestamp": "2026-02-02T02:05:31.077Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design document specifies the technical implementation for Month View Enhancements Part 2, including callback API standardization, PageView-style swipe navigation with simultaneous slide animations, contiguous multi-day event tiles, and drag-and-drop event moving.\n\nThe design focuses on maintainability, performance, and developer experience while building upon the existing MCalMonthView architecture.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **Widget Architecture**: Follows existing StatefulWidget pattern with controller integration\n- **Performance**: Maintains 60fps with PageView-based animation and efficient drag handling\n- **Dart Version**: Compatible with Dart 3.10.4+\n- **Flutter Patterns**: Uses PageController, InheritedWidget for theme, LongPressDraggable/DragTarget for DnD\n- **Mobile-First**: PageView swipe is the standard mobile calendar pattern\n\n### Project Structure (structure.md)\n\n- **File Organization**: New files follow existing naming conventions (`mcal_*.dart`)\n- **Naming**: Classes use `MCal` prefix, details objects use `MCalXxxDetails` suffix\n- **Code Size**: Complex features split into separate files (drag handler, multi-day renderer)\n- **Testing**: Each component has corresponding unit and widget tests\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **MCalEventController**: Extend with `animate` parameter for `setDisplayDate()`\n- **MCalMonthView**: Refactor internal structure to use PageView\n- **MCalThemeData**: Keep as-is, add MCalTheme inherited widget wrapper\n- **Context classes**: Migrate to details pattern (remove theme property)\n- **date_utils.dart**: Reuse date calculation utilities\n- **MCalLocalizations**: Reuse for accessibility announcements\n\n### Integration Points\n\n- **Controller-View Communication**: Views continue listening via `addListener()`\n- **Theme System**: New `MCalTheme` InheritedWidget wraps existing ThemeExtension pattern\n- **Event Rendering**: Multi-day tiles integrate with existing event sorting and layout\n\n## Architecture\n\n### High-Level Component Architecture\n\n```mermaid\ngraph TD\n    subgraph Theme[\"Theme System\"]\n        IT[MCalTheme InheritedWidget]\n        TD[MCalThemeData]\n        IT --> TD\n    end\n\n    subgraph Controller[\"MCalEventController\"]\n        DD[displayDate]\n        AN[animateNext: bool]\n        EV[events]\n    end\n\n    subgraph View[\"MCalMonthView\"]\n        PC[PageController]\n        PV[PageView]\n        MG[MonthGrid]\n        MDR[MultiDayRenderer]\n        DH[DragHandler]\n        \n        PC --> PV\n        PV --> MG\n        MG --> MDR\n        MG --> DH\n    end\n\n    subgraph Details[\"Details Objects\"]\n        CTD[MCalCellTapDetails]\n        ETD[MCalEventTapDetails]\n        MTD[MCalMultiDayTileDetails]\n        DRD[MCalDraggedTileDetails]\n    end\n\n    Controller -->|notifyListeners| View\n    View -->|setDisplayDate| Controller\n    IT --> View\n    View --> Details\n```\n\n### Component Hierarchy\n\n```\nMCalTheme (InheritedWidget)\n└── MCalMonthView (StatefulWidget)\n    └── _MCalMonthViewState\n        ├── PageController\n        ├── _NavigatorWidget\n        ├── _WeekdayHeaderRowWidget\n        └── PageView\n            └── _MonthPage (for each month)\n                ├── _MultiDayEventRows (spanning tiles at top)\n                │   └── _MultiDayEventTile[]\n                └── _MonthGrid\n                    └── _WeekRowWidget[]\n                        └── _DayCellWidget[]\n                            └── _SingleDayEventTile[]\n                            \n        └── DragOverlay (when dragging)\n            ├── _DraggedTileWidget\n            └── _DragTargetOverlay\n```\n\n## Components and Interfaces\n\n### Component 1: MCalTheme InheritedWidget\n\n**Location**: `lib/src/styles/mcal_theme.dart`\n\n**Purpose**: Provide theme access via `MCalTheme.of(context)` without passing theme through every widget\n\n```dart\n/// InheritedWidget that provides MCalThemeData to descendants.\nclass MCalTheme extends InheritedWidget {\n  final MCalThemeData data;\n\n  const MCalTheme({\n    super.key,\n    required this.data,\n    required super.child,\n  });\n\n  /// Returns the MCalThemeData from the closest MCalTheme ancestor.\n  /// Falls back to ThemeExtension or fromTheme() if no MCalTheme found.\n  static MCalThemeData of(BuildContext context) {\n    final theme = context.dependOnInheritedWidgetOfExactType<MCalTheme>();\n    if (theme != null) return theme.data;\n    \n    // Fallback to ThemeExtension\n    final themeData = Theme.of(context);\n    return themeData.extension<MCalThemeData>() ?? \n           MCalThemeData.fromTheme(themeData);\n  }\n\n  /// Returns null if no MCalTheme ancestor and no ThemeExtension.\n  static MCalThemeData? maybeOf(BuildContext context) {\n    final theme = context.dependOnInheritedWidgetOfExactType<MCalTheme>();\n    if (theme != null) return theme.data;\n    return Theme.of(context).extension<MCalThemeData>();\n  }\n\n  @override\n  bool updateShouldNotify(MCalTheme oldWidget) => data != oldWidget.data;\n}\n```\n\n**Dependencies**: Flutter's InheritedWidget\n\n### Component 2: Callback Details Classes\n\n**Location**: `lib/src/widgets/mcal_callback_details.dart`\n\n**Purpose**: Standardized details objects for all callbacks\n\n```dart\n/// Details for cell tap and long-press callbacks.\nclass MCalCellTapDetails {\n  final DateTime date;\n  final List<MCalCalendarEvent> events;\n  final bool isCurrentMonth;\n\n  const MCalCellTapDetails({\n    required this.date,\n    required this.events,\n    required this.isCurrentMonth,\n  });\n}\n\n/// Details for event tap and long-press callbacks.\nclass MCalEventTapDetails {\n  final MCalCalendarEvent event;\n  final DateTime displayDate;\n\n  const MCalEventTapDetails({\n    required this.event,\n    required this.displayDate,\n  });\n}\n\n/// Details for swipe navigation callbacks.\nclass MCalSwipeNavigationDetails {\n  final DateTime previousMonth;\n  final DateTime newMonth;\n  final MCalSwipeDirection direction;\n\n  const MCalSwipeNavigationDetails({\n    required this.previousMonth,\n    required this.newMonth,\n    required this.direction,\n  });\n}\n\n/// Details for overflow tap and long-press callbacks.\nclass MCalOverflowTapDetails {\n  final DateTime date;\n  final List<MCalCalendarEvent> allEvents;\n  final int hiddenCount;\n\n  const MCalOverflowTapDetails({\n    required this.date,\n    required this.allEvents,\n    required this.hiddenCount,\n  });\n}\n\n/// Details for cell interactivity callback.\nclass MCalCellInteractivityDetails {\n  final DateTime date;\n  final bool isCurrentMonth;\n  final bool isSelectable;\n\n  const MCalCellInteractivityDetails({\n    required this.date,\n    required this.isCurrentMonth,\n    required this.isSelectable,\n  });\n}\n\n/// Details for error builder callback.\nclass MCalErrorDetails {\n  final Object error;\n  final VoidCallback onRetry;\n\n  const MCalErrorDetails({\n    required this.error,\n    required this.onRetry,\n  });\n}\n\n/// Details for multi-day event tile builder.\nclass MCalMultiDayTileDetails {\n  final MCalCalendarEvent event;\n  final DateTime displayDate;\n  final bool isFirstDayOfEvent;\n  final bool isLastDayOfEvent;\n  final bool isFirstDayInRow;\n  final bool isLastDayInRow;\n  final int dayIndexInEvent;\n  final int totalDaysInEvent;\n  final int dayIndexInRow;\n  final int totalDaysInRow;\n  final int rowIndex;\n  final int totalRows;\n\n  const MCalMultiDayTileDetails({\n    required this.event,\n    required this.displayDate,\n    required this.isFirstDayOfEvent,\n    required this.isLastDayOfEvent,\n    required this.isFirstDayInRow,\n    required this.isLastDayInRow,\n    required this.dayIndexInEvent,\n    required this.totalDaysInEvent,\n    required this.dayIndexInRow,\n    required this.totalDaysInRow,\n    required this.rowIndex,\n    required this.totalRows,\n  });\n}\n\n/// Details for the tile being dragged.\nclass MCalDraggedTileDetails {\n  final MCalCalendarEvent event;\n  final DateTime sourceDate;\n  final Offset currentPosition;\n\n  const MCalDraggedTileDetails({\n    required this.event,\n    required this.sourceDate,\n    required this.currentPosition,\n  });\n}\n\n/// Details for the drag source location.\nclass MCalDragSourceDetails {\n  final MCalCalendarEvent event;\n  final DateTime sourceDate;\n\n  const MCalDragSourceDetails({\n    required this.event,\n    required this.sourceDate,\n  });\n}\n\n/// Details for the drag target preview.\nclass MCalDragTargetDetails {\n  final MCalCalendarEvent event;\n  final DateTime targetDate;\n  final bool isValid;\n\n  const MCalDragTargetDetails({\n    required this.event,\n    required this.targetDate,\n    required this.isValid,\n  });\n}\n\n/// Details for drag validation callback.\nclass MCalDragWillAcceptDetails {\n  final MCalCalendarEvent event;\n  final DateTime proposedStartDate;\n  final DateTime proposedEndDate;\n\n  const MCalDragWillAcceptDetails({\n    required this.event,\n    required this.proposedStartDate,\n    required this.proposedEndDate,\n  });\n}\n\n/// Details for drop target cell builder.\nclass MCalDropTargetCellDetails {\n  final DateTime date;\n  final bool isValid;\n  final MCalCalendarEvent draggedEvent;\n\n  const MCalDropTargetCellDetails({\n    required this.date,\n    required this.isValid,\n    required this.draggedEvent,\n  });\n}\n\n/// Details for event dropped callback.\nclass MCalEventDroppedDetails {\n  final MCalCalendarEvent event;\n  final DateTime oldStartDate;\n  final DateTime oldEndDate;\n  final DateTime newStartDate;\n  final DateTime newEndDate;\n\n  const MCalEventDroppedDetails({\n    required this.event,\n    required this.oldStartDate,\n    required this.oldEndDate,\n    required this.newStartDate,\n    required this.newEndDate,\n  });\n}\n```\n\n### Component 3: PageView-Based Month Navigation\n\n**Location**: `lib/src/widgets/mcal_month_view.dart` (refactored)\n\n**Purpose**: Replace current AnimatedSwitcher with PageView for natural swipe navigation\n\n```dart\nclass _MCalMonthViewState extends State<MCalMonthView> {\n  late PageController _pageController;\n  \n  /// Index offset for \"infinite\" scrolling (start at large number)\n  static const int _initialPageIndex = 10000;\n  \n  /// Whether next navigation should be animated\n  bool _shouldAnimateNextNavigation = true;\n  \n  @override\n  void initState() {\n    super.initState();\n    _pageController = PageController(initialPage: _initialPageIndex);\n    // ... existing init\n  }\n\n  /// Converts page index to month DateTime\n  DateTime _pageIndexToMonth(int pageIndex) {\n    final delta = pageIndex - _initialPageIndex;\n    final baseMonth = _initialMonth;\n    return DateTime(baseMonth.year, baseMonth.month + delta, 1);\n  }\n\n  /// Converts month DateTime to page index\n  int _monthToPageIndex(DateTime month) {\n    final baseMonth = _initialMonth;\n    final yearDiff = month.year - baseMonth.year;\n    final monthDiff = month.month - baseMonth.month;\n    return _initialPageIndex + (yearDiff * 12) + monthDiff;\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    // Wrap content in MCalTheme for descendant access\n    return MCalTheme(\n      data: _resolveTheme(context),\n      child: Column(\n        children: [\n          if (widget.showNavigator) _NavigatorWidget(...),\n          _WeekdayHeaderRowWidget(...),\n          Expanded(\n            child: PageView.builder(\n              controller: _pageController,\n              physics: widget.enableSwipeNavigation\n                  ? const ClampingScrollPhysics()\n                  : const NeverScrollableScrollPhysics(),\n              onPageChanged: _onPageChanged,\n              itemBuilder: (context, index) {\n                final month = _pageIndexToMonth(index);\n                return _MonthPage(\n                  month: month,\n                  events: _getEventsForMonth(month),\n                  // ... other props\n                );\n              },\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _onPageChanged(int index) {\n    final newMonth = _pageIndexToMonth(index);\n    final direction = index > _previousPageIndex \n        ? MCalSwipeDirection.next \n        : MCalSwipeDirection.previous;\n    \n    // Update controller (this triggers event reloading)\n    widget.controller.setDisplayDate(newMonth, animate: false);\n    \n    // Fire callback\n    widget.onSwipeNavigation?.call(\n      context,\n      MCalSwipeNavigationDetails(\n        previousMonth: _currentMonth,\n        newMonth: newMonth,\n        direction: direction,\n      ),\n    );\n    \n    _previousPageIndex = index;\n  }\n\n  /// Navigate to specific month programmatically\n  void _navigateToMonth(DateTime month, {bool animate = true}) {\n    final targetIndex = _monthToPageIndex(month);\n    \n    if (animate && widget.enableAnimations && _shouldAnimateNextNavigation) {\n      _pageController.animateToPage(\n        targetIndex,\n        duration: widget.animationDuration,\n        curve: widget.animationCurve,\n      );\n    } else {\n      _pageController.jumpToPage(targetIndex);\n    }\n  }\n}\n```\n\n### Component 4: Controller Animation Support\n\n**Location**: `lib/src/controllers/mcal_event_controller.dart`\n\n**Purpose**: Add animation control to programmatic navigation\n\n```dart\nclass MCalEventController extends ChangeNotifier {\n  // ... existing fields\n  \n  /// Whether the next display date change should animate.\n  /// Views read this to determine animation behavior.\n  bool _animateNextChange = true;\n  \n  /// Gets whether the next change should animate.\n  bool get shouldAnimateNextChange => _animateNextChange;\n  \n  /// Resets animation flag after it's consumed.\n  void consumeAnimationFlag() {\n    _animateNextChange = true;\n  }\n  \n  /// Sets the display date with optional animation control.\n  ///\n  /// Parameters:\n  /// - [date]: The new display date\n  /// - [animate]: Whether to animate the transition (default: true)\n  void setDisplayDate(DateTime date, {bool animate = true}) {\n    if (_displayDate != date) {\n      _animateNextChange = animate;\n      _displayDate = date;\n      notifyListeners();\n    }\n  }\n  \n  /// Navigates to date without animation, regardless of view settings.\n  void navigateToDateWithoutAnimation(DateTime date) {\n    setDisplayDate(date, animate: false);\n  }\n}\n```\n\n### Component 5: Multi-Day Event Renderer\n\n**Location**: `lib/src/widgets/mcal_multi_day_renderer.dart`\n\n**Purpose**: Render contiguous multi-day event tiles spanning across cells\n\n```dart\n/// Calculates and renders multi-day events as contiguous tiles.\nclass MCalMultiDayRenderer {\n  /// Analyzes events and returns multi-day event layout info for a month.\n  static List<MCalMultiDayEventLayout> calculateLayouts(\n    List<MCalCalendarEvent> events,\n    DateTime monthStart,\n    int firstDayOfWeek,\n  ) {\n    // Filter to multi-day events only\n    final multiDayEvents = events.where(_isMultiDay).toList();\n    \n    // Sort by: all-day first, then start date, then title\n    multiDayEvents.sort(_multiDayEventComparator);\n    \n    // Calculate row segments for each event\n    return multiDayEvents.map((event) {\n      return _calculateEventLayout(event, monthStart, firstDayOfWeek);\n    }).toList();\n  }\n  \n  static bool _isMultiDay(MCalCalendarEvent event) {\n    final startDate = DateTime(event.start.year, event.start.month, event.start.day);\n    final endDate = DateTime(event.end.year, event.end.month, event.end.day);\n    return endDate.isAfter(startDate);\n  }\n  \n  static int _multiDayEventComparator(MCalCalendarEvent a, MCalCalendarEvent b) {\n    // 1. All-day events first\n    if (a.isAllDay && !b.isAllDay) return -1;\n    if (!a.isAllDay && b.isAllDay) return 1;\n    \n    // 2. By start date\n    final startCompare = a.start.compareTo(b.start);\n    if (startCompare != 0) return startCompare;\n    \n    // 3. By title\n    return a.title.compareTo(b.title);\n  }\n}\n\n/// Layout information for a multi-day event.\nclass MCalMultiDayEventLayout {\n  final MCalCalendarEvent event;\n  final List<MCalMultiDayRowSegment> rowSegments;\n\n  const MCalMultiDayEventLayout({\n    required this.event,\n    required this.rowSegments,\n  });\n}\n\n/// A segment of a multi-day event within a single week row.\nclass MCalMultiDayRowSegment {\n  final int weekRowIndex;\n  final int startDayInRow; // 0-6\n  final int endDayInRow;   // 0-6\n  final int totalDaysInRow;\n  final bool isFirstRowOfEvent;\n  final bool isLastRowOfEvent;\n\n  const MCalMultiDayRowSegment({\n    required this.weekRowIndex,\n    required this.startDayInRow,\n    required this.endDayInRow,\n    required this.totalDaysInRow,\n    required this.isFirstRowOfEvent,\n    required this.isLastRowOfEvent,\n  });\n}\n```\n\n### Component 6: Multi-Day Event Tile Widget\n\n**Location**: `lib/src/widgets/mcal_multi_day_tile.dart`\n\n**Purpose**: Render a single contiguous multi-day tile segment\n\n```dart\n/// Widget that renders a contiguous multi-day event tile spanning multiple cells.\nclass MCalMultiDayTile extends StatelessWidget {\n  final MCalCalendarEvent event;\n  final MCalMultiDayRowSegment segment;\n  final int rowIndex;\n  final int totalRows;\n  final bool renderAsContiguous;\n  final Widget Function(BuildContext, MCalMultiDayTileDetails, Widget)? builder;\n  final void Function(BuildContext, MCalEventTapDetails)? onTap;\n  final void Function(BuildContext, MCalEventTapDetails)? onLongPress;\n\n  @override\n  Widget build(BuildContext context) {\n    final theme = MCalTheme.of(context);\n    \n    // Calculate border radius based on position\n    BorderRadius borderRadius;\n    if (renderAsContiguous) {\n      borderRadius = _calculateContiguousBorderRadius(segment, rowIndex, totalRows);\n    } else {\n      borderRadius = BorderRadius.circular(4);\n    }\n    \n    Widget tile = Container(\n      decoration: BoxDecoration(\n        color: event.color ?? theme.eventTileBackgroundColor,\n        borderRadius: borderRadius,\n      ),\n      padding: const EdgeInsets.symmetric(horizontal: 4, vertical: 2),\n      child: Text(\n        event.title,\n        style: theme.eventTileTextStyle,\n        overflow: TextOverflow.ellipsis,\n      ),\n    );\n    \n    // Apply custom builder if provided\n    if (builder != null) {\n      final details = MCalMultiDayTileDetails(\n        event: event,\n        displayDate: _getDisplayDate(segment),\n        isFirstDayOfEvent: segment.isFirstRowOfEvent && segment.startDayInRow == 0,\n        isLastDayOfEvent: segment.isLastRowOfEvent && segment.endDayInRow == 6,\n        isFirstDayInRow: true,\n        isLastDayInRow: true,\n        dayIndexInEvent: _calculateDayIndex(segment),\n        totalDaysInEvent: _calculateTotalDays(event),\n        dayIndexInRow: 0,\n        totalDaysInRow: segment.totalDaysInRow,\n        rowIndex: rowIndex,\n        totalRows: totalRows,\n      );\n      tile = builder!(context, details, tile);\n    }\n    \n    return GestureDetector(\n      onTap: onTap != null ? () => onTap!(context, MCalEventTapDetails(\n        event: event,\n        displayDate: _getDisplayDate(segment),\n      )) : null,\n      onLongPress: onLongPress != null ? () => onLongPress!(context, MCalEventTapDetails(\n        event: event,\n        displayDate: _getDisplayDate(segment),\n      )) : null,\n      child: tile,\n    );\n  }\n  \n  /// Calculates border radius for contiguous rendering.\n  BorderRadius _calculateContiguousBorderRadius(\n    MCalMultiDayRowSegment segment,\n    int rowIndex,\n    int totalRows,\n  ) {\n    const radius = Radius.circular(4);\n    const square = Radius.zero;\n    \n    // First row of event: rounded left on first day\n    final topLeft = segment.isFirstRowOfEvent ? radius : square;\n    final bottomLeft = segment.isFirstRowOfEvent ? radius : square;\n    \n    // Last row of event: rounded right on last day\n    final topRight = segment.isLastRowOfEvent ? radius : square;\n    final bottomRight = segment.isLastRowOfEvent ? radius : square;\n    \n    return BorderRadius.only(\n      topLeft: topLeft,\n      bottomLeft: bottomLeft,\n      topRight: topRight,\n      bottomRight: bottomRight,\n    );\n  }\n}\n```\n\n### Component 7: Drag-and-Drop Handler\n\n**Location**: `lib/src/widgets/mcal_drag_handler.dart`\n\n**Purpose**: Manage drag-and-drop state and behavior\n\n```dart\n/// Manages drag-and-drop state for calendar events.\nclass MCalDragHandler extends ChangeNotifier {\n  MCalCalendarEvent? _draggedEvent;\n  DateTime? _sourceDate;\n  DateTime? _targetDate;\n  bool _isValidTarget = true;\n  Offset? _currentPosition;\n  Timer? _edgeNavigationTimer;\n  \n  /// The event currently being dragged, or null.\n  MCalCalendarEvent? get draggedEvent => _draggedEvent;\n  \n  /// The source date where drag started.\n  DateTime? get sourceDate => _sourceDate;\n  \n  /// The current target date, or null.\n  DateTime? get targetDate => _targetDate;\n  \n  /// Whether the current target is valid for drop.\n  bool get isValidTarget => _isValidTarget;\n  \n  /// Current drag position for rendering dragged tile.\n  Offset? get currentPosition => _currentPosition;\n  \n  /// Whether a drag is in progress.\n  bool get isDragging => _draggedEvent != null;\n  \n  /// Starts a drag operation.\n  void startDrag(MCalCalendarEvent event, DateTime date, Offset position) {\n    _draggedEvent = event;\n    _sourceDate = date;\n    _currentPosition = position;\n    notifyListeners();\n  }\n  \n  /// Updates drag position and target.\n  void updateDrag(Offset position, DateTime? targetDate, bool isValid) {\n    _currentPosition = position;\n    _targetDate = targetDate;\n    _isValidTarget = isValid;\n    notifyListeners();\n  }\n  \n  /// Handles drag near edge for auto-navigation.\n  void handleEdgeProximity(\n    bool isNearLeftEdge,\n    bool isNearRightEdge,\n    VoidCallback onNavigatePrevious,\n    VoidCallback onNavigateNext,\n    Duration delay,\n  ) {\n    _edgeNavigationTimer?.cancel();\n    \n    if (isNearLeftEdge) {\n      _edgeNavigationTimer = Timer(delay, onNavigatePrevious);\n    } else if (isNearRightEdge) {\n      _edgeNavigationTimer = Timer(delay, onNavigateNext);\n    }\n  }\n  \n  /// Completes the drag operation.\n  MCalEventDroppedDetails? completeDrag() {\n    if (_draggedEvent == null || _targetDate == null || !_isValidTarget) {\n      cancelDrag();\n      return null;\n    }\n    \n    final event = _draggedEvent!;\n    final oldStart = event.start;\n    final oldEnd = event.end;\n    \n    // Calculate new dates\n    final dayDelta = _targetDate!.difference(\n      DateTime(_sourceDate!.year, _sourceDate!.month, _sourceDate!.day)\n    ).inDays;\n    \n    final newStart = oldStart.add(Duration(days: dayDelta));\n    final newEnd = oldEnd.add(Duration(days: dayDelta));\n    \n    final details = MCalEventDroppedDetails(\n      event: event,\n      oldStartDate: oldStart,\n      oldEndDate: oldEnd,\n      newStartDate: newStart,\n      newEndDate: newEnd,\n    );\n    \n    _reset();\n    return details;\n  }\n  \n  /// Cancels the drag operation.\n  void cancelDrag() {\n    _reset();\n    notifyListeners();\n  }\n  \n  void _reset() {\n    _draggedEvent = null;\n    _sourceDate = null;\n    _targetDate = null;\n    _isValidTarget = true;\n    _currentPosition = null;\n    _edgeNavigationTimer?.cancel();\n    _edgeNavigationTimer = null;\n  }\n  \n  @override\n  void dispose() {\n    _edgeNavigationTimer?.cancel();\n    super.dispose();\n  }\n}\n```\n\n### Component 8: Draggable Event Tile\n\n**Location**: `lib/src/widgets/mcal_draggable_event_tile.dart`\n\n**Purpose**: Wrap event tiles with drag functionality\n\n```dart\n/// Wraps an event tile with drag functionality when enabled.\nclass MCalDraggableEventTile extends StatelessWidget {\n  final Widget child;\n  final MCalCalendarEvent event;\n  final DateTime displayDate;\n  final bool enableDrag;\n  final MCalDragHandler dragHandler;\n  final Widget Function(BuildContext, MCalDraggedTileDetails)? draggedBuilder;\n  final Widget Function(BuildContext, MCalDragSourceDetails)? sourceBuilder;\n\n  @override\n  Widget build(BuildContext context) {\n    if (!enableDrag) return child;\n    \n    return LongPressDraggable<MCalCalendarEvent>(\n      data: event,\n      delay: const Duration(milliseconds: 200),\n      feedback: _buildFeedback(context),\n      childWhenDragging: _buildSource(context),\n      onDragStarted: () {\n        dragHandler.startDrag(\n          event,\n          displayDate,\n          Offset.zero, // Updated by drag update\n        );\n      },\n      onDragUpdate: (details) {\n        dragHandler.updateDrag(\n          details.globalPosition,\n          null, // Target calculated by DragTarget\n          true,\n        );\n      },\n      onDragEnd: (details) {\n        if (!details.wasAccepted) {\n          dragHandler.cancelDrag();\n        }\n      },\n      child: child,\n    );\n  }\n  \n  Widget _buildFeedback(BuildContext context) {\n    if (draggedBuilder != null) {\n      return draggedBuilder!(\n        context,\n        MCalDraggedTileDetails(\n          event: event,\n          sourceDate: displayDate,\n          currentPosition: Offset.zero,\n        ),\n      );\n    }\n    \n    // Default: same as normal tile\n    return Material(\n      elevation: 4,\n      child: child,\n    );\n  }\n  \n  Widget _buildSource(BuildContext context) {\n    if (sourceBuilder != null) {\n      return sourceBuilder!(\n        context,\n        MCalDragSourceDetails(\n          event: event,\n          sourceDate: displayDate,\n        ),\n      );\n    }\n    \n    // Default: semi-transparent ghost\n    return Opacity(\n      opacity: 0.5,\n      child: child,\n    );\n  }\n}\n```\n\n### Component 9: Drag Target Cell\n\n**Location**: Integrated into `_DayCellWidget`\n\n**Purpose**: Accept dropped events and provide visual feedback\n\n```dart\n// Inside _DayCellWidget build method\nWidget _buildWithDragTarget(BuildContext context, Widget cell) {\n  if (!widget.enableDragAndDrop) return cell;\n  \n  return DragTarget<MCalCalendarEvent>(\n    onWillAcceptWithDetails: (details) {\n      final event = details.data;\n      final newStart = _calculateNewStart(event, date);\n      final newEnd = _calculateNewEnd(event, date);\n      \n      // Check with validation callback\n      if (widget.onDragWillAccept != null) {\n        return widget.onDragWillAccept!(\n          context,\n          MCalDragWillAcceptDetails(\n            event: event,\n            proposedStartDate: newStart,\n            proposedEndDate: newEnd,\n          ),\n        );\n      }\n      return true;\n    },\n    onAcceptWithDetails: (details) {\n      widget.dragHandler.updateDrag(\n        details.offset,\n        date,\n        true,\n      );\n    },\n    onLeave: (data) {\n      widget.dragHandler.updateDrag(\n        widget.dragHandler.currentPosition ?? Offset.zero,\n        null,\n        true,\n      );\n    },\n    builder: (context, candidateData, rejectedData) {\n      final isHovering = candidateData.isNotEmpty;\n      final isRejected = rejectedData.isNotEmpty;\n      \n      Widget result = cell;\n      \n      // Apply drop target styling\n      if (isHovering || isRejected) {\n        if (widget.dropTargetCellBuilder != null) {\n          result = widget.dropTargetCellBuilder!(\n            context,\n            MCalDropTargetCellDetails(\n              date: date,\n              isValid: isHovering && !isRejected,\n              draggedEvent: candidateData.first!,\n            ),\n          );\n        } else {\n          // Default: highlight cell\n          result = Container(\n            decoration: BoxDecoration(\n              color: isRejected\n                  ? Colors.red.withOpacity(0.2)\n                  : Colors.green.withOpacity(0.2),\n            ),\n            child: cell,\n          );\n        }\n      }\n      \n      return result;\n    },\n  );\n}\n```\n\n## Data Models\n\n### Updated Context Classes (Remove Theme)\n\n```dart\n// MCalDayCellContext - remove theme property\nclass MCalDayCellContext {\n  final DateTime date;\n  final bool isCurrentMonth;\n  final bool isToday;\n  final bool isSelectable;\n  final bool isFocused;\n  final List<MCalCalendarEvent> events;\n  // REMOVED: final MCalThemeData theme;\n\n  const MCalDayCellContext({\n    required this.date,\n    required this.isCurrentMonth,\n    required this.isToday,\n    required this.isSelectable,\n    this.isFocused = false,\n    required this.events,\n  });\n}\n\n// Similar updates for:\n// - MCalEventTileContext (remove theme)\n// - MCalDayHeaderContext (remove theme)\n// - MCalWeekNumberContext (remove theme)\n```\n\n### New Theme Properties\n\n```dart\n// Add to MCalThemeData\nclass MCalThemeData extends ThemeExtension<MCalThemeData> {\n  // ... existing properties\n  \n  /// Background color for valid drag target cells.\n  final Color? dragTargetValidColor;\n  \n  /// Background color for invalid drag target cells.\n  final Color? dragTargetInvalidColor;\n  \n  /// Opacity for drag source ghost.\n  final double? dragSourceOpacity;\n  \n  /// Elevation for dragged tile feedback.\n  final double? draggedTileElevation;\n  \n  /// Background color for multi-day event tiles.\n  final Color? multiDayEventBackgroundColor;\n  \n  /// Text style for multi-day event tiles.\n  final TextStyle? multiDayEventTextStyle;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Drag cancelled by escape key**\n   - **Handling**: Cancel drag, animate tile back to source\n   - **User Impact**: Event returns to original position smoothly\n\n2. **Drop rejected by validation callback**\n   - **Handling**: Show invalid feedback, cancel on release\n   - **User Impact**: Sees red highlight, event snaps back\n\n3. **Navigation during drag hits boundary**\n   - **Handling**: Prevent navigation, cancel edge timer\n   - **User Impact**: Cannot drag beyond min/max date\n\n4. **Controller update fails during drop**\n   - **Handling**: Revert event to original dates, notify via callback\n   - **User Impact**: Event returns to original position\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Details classes**: Test immutability and equality\n- **MCalTheme.of()**: Test inheritance chain and fallbacks\n- **MCalMultiDayRenderer**: Test layout calculations for various event spans\n- **MCalDragHandler**: Test state transitions and delta calculations\n- **Controller animate flag**: Test flag consumption\n\n### Widget Testing\n\n- **PageView navigation**: Test swipe gestures and page changes\n- **Multi-day tiles**: Test rendering across week boundaries\n- **Drag and drop**: Test drag initiation, feedback, and drop\n- **Edge navigation**: Test auto-scroll during drag near edges\n- **Callback signatures**: Test new callback patterns receive correct details\n\n### Integration Testing\n\n- **Full drag-drop flow**: Start drag, navigate months, drop, verify update\n- **Multi-view sync**: Test PageView sync with controller\n- **Theme inheritance**: Test MCalTheme.of() in nested widgets\n\n### Accessibility Testing\n\n- **Keyboard drag alternative**: Test arrow key movement with selection\n- **Screen reader**: Test drag state announcements\n- **Reduced motion**: Test instant navigation when preferred\n\n## Implementation Order\n\nRecommended implementation order based on dependencies:\n\n1. **MCalTheme InheritedWidget** (enables theme access pattern)\n2. **Callback Details Classes** (new file, no dependencies)\n3. **Update existing context classes** (remove theme property)\n4. **Migrate existing callbacks** (update signatures throughout)\n5. **Controller animation support** (add animate parameter)\n6. **PageView navigation** (replace AnimatedSwitcher)\n7. **Multi-day renderer** (layout calculations)\n8. **Multi-day tile widget** (contiguous rendering)\n9. **Drag handler** (state management)\n10. **Draggable tile wrapper** (LongPressDraggable integration)\n11. **Drag target cells** (DragTarget integration)\n12. **Cross-month drag navigation** (edge detection and auto-scroll)\n13. **Update example app** (demonstrate new features)\n14. **Comprehensive testing** (all test types)\n",
  "fileStats": {
    "size": 31422,
    "lines": 1094,
    "lastModified": "2026-02-02T01:58:47.147Z"
  },
  "comments": []
}