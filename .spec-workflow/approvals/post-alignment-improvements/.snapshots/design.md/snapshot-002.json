{
  "id": "snapshot_1772055666627_1xox23gym",
  "approvalId": "approval_1772055598211_5hw3oqoye",
  "approvalTitle": "Design: post-alignment-improvements",
  "version": 2,
  "timestamp": "2026-02-25T21:41:06.627Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design covers three fully-implemented enhancements delivered after the `month-day-view-api-alignment` spec:\n\n1. **Day View Page Swiping Improvements** — refinement of the PageView-based swipe navigation introduced in the alignment spec, fixing page/date synchronisation, drag coexistence, and RTL.\n2. **`MCalDayRegion`** — a new public model class for annotating and optionally blocking entire calendar days in Month View, the day-level counterpart of `MCalTimeRegion`.\n3. **DST-Safe `addDays()` Utility** — a centralised `addDays(DateTime, int)` function in `date_utils.dart` that replaces all inline `DateTime(y, m, d + N)` arithmetic throughout the core library.\n\nAll code is already merged into the working tree; this design document captures the technical decisions made during implementation for the spec record.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **DST-safe arithmetic**: `addDays()` uses the `DateTime` constructor form (`DateTime(y, m, d + N, h, min, s, ms, us)`) rather than `Duration` addition, consistent with the comment pattern already established in `mcal_event_controller.dart`.\n- **Builder-with-default pattern**: `dayRegionBuilder` receives a pre-built default widget as its third argument, matching the pattern established for all Day View and Month View builders in the alignment spec.\n- **RFC 5545 RRULE**: `MCalDayRegion.recurrenceRule` uses the same string format as `MCalTimeRegion.recurrenceRule` and `MCalRecurrenceRule`, maintaining format consistency.\n- **MCal prefix**: New public class `MCalDayRegion` and context class `MCalDayRegionContext` follow the established `MCal` prefix convention.\n- **Dart 3 / Flutter SDK**: All code uses null-safety, `const` constructors, and `withValues(alpha:)` instead of the deprecated `withOpacity`.\n\n### Project Structure (structure.md)\n\n- `MCalDayRegion` lives in `lib/src/models/mcal_day_region.dart`, consistent with other models (`mcal_time_region.dart`, `mcal_calendar_event.dart`).\n- Exported via `lib/multi_calendar.dart` alongside other model exports.\n- `addDays()` is added to `lib/src/utils/date_utils.dart` alongside the existing date utility functions (`getMonthRange`, `daysBetween`, `dateOnly`, etc.).\n- Unit tests for `addDays()` are added to `test/utils/date_utils_test.dart`, alongside the existing tests for the same file.\n- Widget integration (`dayRegions`, `dayRegionBuilder`, rendering, blocking) is contained entirely within `lib/src/widgets/mcal_month_view.dart` with no new widget files.\n\n## Code Reuse Analysis\n\n### Existing Components Leveraged\n\n- **`MCalTimeRegion`** (`lib/src/models/mcal_time_region.dart`): Structural template for `MCalDayRegion` — same field pattern (`id`, `color`, `text`, `blockInteraction`, `recurrenceRule`), same RRULE string format.\n- **`date_utils.dart` — `dateOnly()`, `daysBetween()`**: Used within `MCalMonthView` for date normalisation and delta computation alongside the new `addDays()`.\n- **`MCalMonthView` widget tree**: `dayRegions` and `dayRegionBuilder` are threaded through the existing four-layer widget hierarchy (`MCalMonthView` → `_MonthPageWidget` → `_WeekRowWidget` → `_DayCellWidget`) using the same propagation pattern as all other per-cell parameters.\n- **`_DayCellWidgetState.build()`**: The region overlay stack is injected into the existing `cellContent` build without restructuring — the `Stack` is only introduced when `applicableRegions` is non-empty.\n- **`MCalDragHandler` / `_processDragMove` / `validationCallback`**: The blocking check reuses the existing `onDragWillAccept` short-circuit path; blocking regions simply produce an early `isValid = false` before the consumer callback is reached.\n- **`addDays()` everywhere**: Replaces the identical `DateTime(d.year, d.month, d.day + N)` pattern already documented in comments as \"DST-safe arithmetic\" in four files.\n- **Day View `PageView.builder`** (`mcal_day_view.dart`): The swipe improvements refine code introduced in task 8 of the alignment spec; no new architectural components are added.\n\n### Integration Points\n\n- **`lib/multi_calendar.dart`**: `MCalDayRegion` and `MCalDayRegionContext` added to the `export 'src/models/mcal_day_region.dart'` line.\n- **`month_features_tab.dart` (example app)**: The blackout-days feature is refactored from manual `Set<DateTime>` computation to `List<MCalDayRegion>` with recurrence rules, demonstrating the API with real recurring patterns.\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph \"Model Layer\"\n        DR[MCalDayRegion\\nlib/src/models/mcal_day_region.dart]\n        DRC[MCalDayRegionContext]\n    end\n\n    subgraph \"Utility Layer\"\n        DU[date_utils.dart\\naddDays + existing helpers]\n    end\n\n    subgraph \"Widget Layer\"\n        MV[MCalMonthView\\ndayRegions, dayRegionBuilder]\n        MP[_MonthPageWidget]\n        WR[_WeekRowWidget]\n        DC[_DayCellWidget\\n_buildRegionOverlay]\n        DH[MCalDragHandler\\nblockInteraction check]\n        DAY[MCalDayView\\nswipe PageView]\n    end\n\n    subgraph \"Example App\"\n        MFT[month_features_tab.dart\\nMCalDayRegion with RRULE]\n    end\n\n    DR --> MV\n    DRC --> DC\n    DU --> MV\n    DU --> DH\n    DU --> DAY\n    DU --> MCalEventController\n    MV --> MP --> WR --> DC\n    MV --> DH\n    DR --> MFT\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `MCalDayRegion` is a pure model/logic class with no widget imports beyond `Color` and `IconData`. All rendering is in `mcal_month_view.dart`.\n- **No New Widget Files**: Region overlays are rendered by a private `_buildRegionOverlay()` helper on `_DayCellWidgetState`, keeping file count stable.\n- **Utility Centralisation**: `addDays()` is a single 10-line function that replaces ~25 scattered constructs across 4 files, becoming the single source of truth for calendar-day arithmetic.\n\n## Components and Interfaces\n\n### Component 1: `MCalDayRegion` (Model)\n\n- **Purpose:** Represents a day-level region with optional styling (`color`, `text`, `icon`), interaction control (`blockInteraction`), and RFC 5545 recurrence (`recurrenceRule`). Exposes `appliesTo(DateTime)` for O(1) membership testing.\n- **Interfaces:**\n  ```dart\n  class MCalDayRegion {\n    const MCalDayRegion({\n      required String id,\n      required DateTime date,\n      Color? color,\n      String? text,\n      IconData? icon,\n      bool blockInteraction = false,\n      String? recurrenceRule,\n      Map<String, dynamic>? customData,\n    });\n    bool appliesTo(DateTime queryDate);\n  }\n  ```\n- **Dependencies:** `dart:core`, `package:flutter/material.dart` (Color, IconData only — no widgets).\n- **Reuses:** Field shape and RRULE string contract from `MCalTimeRegion`.\n\n### Component 2: `MCalDayRegionContext` (Context Model)\n\n- **Purpose:** Passed to `dayRegionBuilder` so the builder has full cell context alongside the region.\n- **Interfaces:**\n  ```dart\n  class MCalDayRegionContext {\n    final MCalDayRegion region;\n    final DateTime date;\n    final bool isCurrentMonth;\n    final bool isToday;\n  }\n  ```\n- **Dependencies:** `MCalDayRegion`.\n- **Reuses:** Same context-object pattern as `MCalDayCellContext`, `MCalTimeLabelContext`, etc.\n\n### Component 3: `MCalMonthView` — `dayRegions` and `dayRegionBuilder` parameters\n\n- **Purpose:** Accepts the list of regions and optional custom builder. Threads both down the widget tree and renders overlays in each cell.\n- **Interfaces (new parameters):**\n  ```dart\n  MCalMonthView({\n    List<MCalDayRegion> dayRegions = const [],\n    Widget Function(BuildContext, MCalDayRegionContext, Widget)? dayRegionBuilder,\n    // ... all existing parameters unchanged\n  })\n  ```\n- **Rendering (in `_DayCellWidgetState.build`):**\n  1. Collect `applicableRegions = widget.dayRegions.where((r) => r.appliesTo(widget.date))`.\n  2. If non-empty, wrap `cellContent` in a `Stack(fit: StackFit.expand)` with region overlays as the bottom layer.\n  3. Each overlay is built by `_buildRegionOverlay()`: renders a `Container(color: region.color)` with optional `Row(icon + text)` at bottom-center; passes result to `dayRegionBuilder` if set.\n- **Drop blocking (in `_processDragMove` and `validationCallback`):**\n  1. Before calling `onDragWillAccept`, iterate `DateTime d = start; !d.isAfter(end); d = addDays(d, 1)`.\n  2. If any `d` matches a region where `blockInteraction == true`, set `isValid = false` and break.\n  3. Only reach `onDragWillAccept` when the library-level check passes.\n- **Dependencies:** `MCalDayRegion`, `addDays`, existing cell/drag infrastructure.\n- **Reuses:** `_MonthPageWidget → _WeekRowWidget → _DayCellWidget` propagation chain, `StackFit.expand` overlay pattern from the layered architecture spec.\n\n### Component 4: `addDays()` (Utility)\n\n- **Purpose:** DST-safe calendar-day arithmetic preserving all time-of-day components.\n- **Interface:**\n  ```dart\n  /// Located in lib/src/utils/date_utils.dart (public, exported).\n  DateTime addDays(DateTime date, int days) {\n    return DateTime(\n      date.year, date.month, date.day + days,\n      date.hour, date.minute, date.second,\n      date.millisecond, date.microsecond,\n    );\n  }\n  ```\n- **Why not `Duration`:** `Duration(days: 1)` adds 86 400 seconds. On a DST \"spring forward\" day the wall clock jumps from 01:59 to 03:00, so midnight + 86 400 s lands at 01:00 the next day, not midnight. The constructor form lets Dart resolve the correct local midnight directly.\n- **Call-site replacements:** 25 locations across `mcal_day_view.dart`, `mcal_month_view.dart`, `mcal_drag_handler.dart`, `mcal_event_controller.dart`. Not replaced in test files or when time components come from a *different* source datetime (e.g., `DateTime(newStart.day + span, master.end.hour, ...)` — those are intentional mixed-source constructs).\n- **Dependencies:** None beyond `dart:core`.\n- **Reuses:** Already-established DST-safe comment pattern in `mcal_event_controller.dart`.\n\n### Component 5: Day View Swipe Navigation Improvements\n\n- **Purpose:** Ensure the swipe PageView stays in sync with the controller's display date and does not interfere with drag-and-drop.\n- **Key refinements over the alignment-spec implementation:**\n  - `_pageIndexToDate()` uses `addDays(_swipeReferenceDate!, dayOffset)` (DST-safe) instead of `DateTime(y, m, d + offset)`.\n  - Navigation helpers (`_handleNavigatePrevious`, `_handleNavigateNext`, `_handleResizeNavigatePrevious`, `_handleResizeNavigateNext`) and boundary guards (`_canGoPrevious`, `_canGoNext`) all use `addDays(_displayDate, ±1)`.\n  - Keyboard-move delta also uses `addDays(start/end, deltaDays)`, preserving all time components.\n- **Dependencies:** `addDays`, existing `PageView.builder` infrastructure, `MCalEventController`.\n\n## Data Models\n\n### MCalDayRegion\n\n```\nMCalDayRegion (immutable, const-constructible)\n  id:               String          — unique identifier; used as widget key\n  date:             DateTime        — anchor date; only date part (y/m/d) is significant\n  color:            Color?          — semi-transparent background fill; null = no fill\n  text:             String?         — short label rendered at cell bottom\n  icon:             IconData?       — icon rendered alongside text\n  blockInteraction: bool            — if true, library rejects drag-and-drop onto this day\n  recurrenceRule:   String?         — RFC 5545 RRULE string; null = single occurrence\n  customData:       Map<String,dynamic>? — arbitrary consumer data passed through to builder\n```\n\n### MCalDayRegionContext\n\n```\nMCalDayRegionContext (immutable, const-constructible)\n  region:           MCalDayRegion   — the region being rendered\n  date:             DateTime        — the cell's calendar date\n  isCurrentMonth:   bool            — true when date is in the displayed month\n  isToday:          bool            — true when date is today\n```\n\n### RRULE Interpreter (internal to MCalDayRegion)\n\nThe simplified interpreter inside `_expandedOccurrences()` supports:\n\n| Pattern | Fields consumed |\n|---|---|\n| `FREQ=DAILY` | `INTERVAL`, `UNTIL`, `COUNT` |\n| `FREQ=WEEKLY` | `BYDAY` (MO/TU/WE/TH/FR/SA/SU), `INTERVAL`, `UNTIL`, `COUNT` |\n| `FREQ=MONTHLY` | `BYMONTHDAY`, `INTERVAL`, `UNTIL`, `COUNT` |\n| `FREQ=YEARLY` | `BYMONTH`, `BYMONTHDAY`, `INTERVAL`, `UNTIL`, `COUNT` |\n\nFor unsupported patterns the method silently returns `[]` (no match). Consumers needing full RFC 5545 expansion should pre-compute dates and pass one `MCalDayRegion` per date.\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Unsupported RRULE pattern** (e.g., `FREQ=HOURLY`, `BYSETPOS`, positional `BYDAY` modifiers like `1MO`):\n   - **Handling:** `_expandedOccurrences()` returns `[]`; `appliesTo()` returns `false`. Region silently does not match any date.\n   - **Consumer impact:** Region is not rendered and does not block. Documented in dartdoc — consumers should pre-expand complex rules.\n\n2. **Malformed UNTIL date in RRULE** (e.g., `UNTIL=NOTADATE`):\n   - **Handling:** `_parseUntil()` catches the parse exception and returns `null`, treating it as no UNTIL limit.\n   - **Consumer impact:** Region behaves as if no UNTIL was specified.\n\n3. **`addDays()` with very large delta** (e.g., ±10 000 days):\n   - **Handling:** Dart's `DateTime` constructor handles integer day overflow natively via calendar arithmetic; no overflow risk.\n   - **Consumer impact:** None.\n\n4. **Empty `dayRegions` list** (the default):\n   - **Handling:** The per-cell `where` filter short-circuits immediately; no `Stack` is injected; cell renders identically to the no-regions case.\n   - **Consumer impact:** Zero performance overhead when the feature is not used.\n\n5. **Swipe PageView and drag gesture conflict**:\n   - **Handling:** Flutter's gesture arena resolves this naturally — vertical drag gestures (time-grid scroll) and the long-press that initiates event drag both take priority over the horizontal PageView swipe. The swipe PageView only responds when no other gesture has claimed the pointer.\n   - **Consumer impact:** Drag-and-drop is unaffected when swipe navigation is enabled.\n\n## Testing Strategy\n\n### Unit Testing\n\n- **`addDays()`** — `test/utils/date_utils_test.dart`: 20 tests covering zero/positive/negative delta, month/year rollover, leap-year Feb 28/29, ±365/366 large deltas, full time-component preservation (including microseconds), DST-invariant calendar-day progression over 400 consecutive days (verified via `daysBetween()` which is UTC-based).\n- **`MCalDayRegion.appliesTo()`** — covered via the existing `MCalDayRegion` test plan; the RRULE interpreter is exercised with `FREQ=WEEKLY;BYDAY=SA,SU`, `FREQ=YEARLY`, `FREQ=DAILY;COUNT=`, and anchor-date boundary cases.\n\n### Widget Testing\n\n- **`MCalMonthView` with `dayRegions`** — verify region overlay renders (`find.byType(Container)` with correct color) for applicable dates; verify no overlay for non-applicable dates.\n- **Drop blocking** — simulate drag hover over a blocking-region cell; assert `isValid = false` is set and `onDragWillAccept` is NOT called.\n- **`dayRegionBuilder`** — supply a builder that returns a sentinel widget; verify it appears in the cell.\n- **Day View swipe** — existing swipe tests from the alignment spec continue to pass; `_canGoPrevious` and `_canGoNext` boundary tests verify correct behavior with `minDate`/`maxDate`.\n\n### Integration Testing\n\n- **Example app compilation** — `month_features_tab.dart` with `MCalDayRegion` recurrence patterns compiles and renders without error.\n- **Regression** — full `flutter test` suite passes; the 14 pre-existing test failures (unrelated to these changes, confirmed by `git stash` verification) remain unchanged.\n",
  "fileStats": {
    "size": 15643,
    "lines": 261,
    "lastModified": "2026-02-25T21:39:53.841Z"
  },
  "comments": []
}