{
  "id": "snapshot_1770505358725_6g50znzr2",
  "approvalId": "approval_1770505358719_l1yugczve",
  "approvalTitle": "Design: Unified Drag Target Architecture",
  "version": 1,
  "timestamp": "2026-02-07T23:02:38.725Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Unified Drag Target Architecture\n\n## Overview\n\nThis design refactors the drag-and-drop implementation in `MCalMonthView` from a per-cell `DragTarget` architecture to a single unified `DragTarget` that wraps all calendar layers. The unified approach uses the `onMove` callback for continuous position tracking, enabling mathematical cell detection, debounced updates with change detection, and flexible highlight overlay rendering.\n\n**Portability**: This architecture is designed with portability in mind. Core utilities (debouncing, cell detection, overlay rendering) will be structured for future extraction into shared modules that can be reused by `MCalDayView` and `MCalMultiDayView`.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **Widget-based Architecture**: Follows Flutter widget patterns with controller pattern for state management\n- **Builder Pattern**: Provides `dropTargetOverlayBuilder` and `dropTargetCellBuilder` for full customization\n- **Delegation Pattern**: Event drop validation delegated to developer via `onDragWillAccept` callback\n- **Performance**: 60fps rendering via debounced updates, O(1) cell detection, efficient CustomPainter default\n- **Touch Responsiveness**: <50ms feedback via 16ms debounce targeting 60fps\n\n### Project Structure (structure.md)\n\n- **Single Responsibility**: Drag logic in `MCalDragHandler`, overlay rendering separate\n- **Modular Design**: New utilities in `lib/src/utils/` for potential reuse\n- **Clear Interfaces**: Well-documented type signatures for all new callbacks\n- **File Size**: All new components under 500 lines\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`MCalDragHandler`**: Extended to handle unified drag state, debouncing, and position tracking\n- **`MCalDragData`**: Reused as-is for drag payload\n- **`MCalDragWillAcceptDetails`**: Reused for validation callback\n- **`MCalGrabOffsetHolder`**: Reused for capturing grab offset\n- **`daysBetween()`**: Reused for DST-safe date calculations\n\n### Components to Modify\n\n- **`_WeekRowWidget`**: Remove per-cell DragTargets, simplify to event/grid rendering only\n- **`_MonthPageWidget`**: Add unified DragTarget wrapper and highlight overlay layer\n\n### New Components\n\n- **`MCalDropOverlayDetails`**: Details object for `dropTargetOverlayBuilder`\n- **`MCalDropTargetCellDetails`**: Details object for `dropTargetCellBuilder`\n- **`MCalHighlightCellInfo`**: Data class for individual highlighted cell info\n- **`_DropTargetHighlightPainter`**: CustomPainter for default highlight rendering\n\n## Architecture\n\nThe new architecture wraps the entire month calendar in a single `DragTarget` and uses mathematical position tracking instead of per-cell hit detection.\n\n```mermaid\ngraph TD\n    subgraph MCalMonthView\n        DT[DragTarget wrapper]\n        DT --> Stack\n        Stack --> L1[Layer 1: Grid Background]\n        Stack --> L2[Layer 2: Events]\n        Stack --> L3[Layer 3: Highlight Overlay]\n    end\n    \n    DT -->|onMove| DH[MCalDragHandler]\n    DH -->|debounced| CD[Cell Detection Math]\n    CD -->|if changed| VO[Validation & Overlay Update]\n    VO -->|notifyListeners| L3\n    \n    L3 -->|Option 1| CP[CustomPainter default]\n    L3 -->|Option 2| CB[dropTargetCellBuilder]\n    L3 -->|Option 3| OB[dropTargetOverlayBuilder]\n```\n\n### Processing Flow\n\n```\nUser drags event\n       ↓\nDragTarget.onMove fires\n       ↓\nStore latest position (no debounce timer running)\n       ↓\nStart 16ms debounce timer\n       ↓\nTimer fires → Process latest position\n       ↓\nCalculate target cells: floor((pointerLocalX - grabOffsetX - horizontalSpacing) / dayWidth)\n       ↓\nCompare with previous target cells\n       ↓\n[If same] → No action (skip repaint)\n       ↓\n[If different] → Call onDragWillAccept (if provided)\n       ↓\nUpdate MCalDragHandler state (proposedStart, proposedEnd, isValid)\n       ↓\nMCalDragHandler.notifyListeners()\n       ↓\nHighlight overlay rebuilds with new state\n```\n\n## Components and Interfaces\n\n### Component 1: Extended MCalDragHandler\n\n**Purpose:** Central state manager for drag operations with debouncing and position tracking\n\n**New Fields:**\n```dart\n// Debounce state\nTimer? _debounceTimer;\nOffset? _latestPosition;\nstatic const Duration _debounceDuration = Duration(milliseconds: 16);\n\n// Previous target state (for change detection)\nint? _previousStartCellIndex;\nint? _previousEndCellIndex;\nint? _previousWeekRowIndex;\n\n// Full highlighted cells list (for overlay rendering)\nList<MCalHighlightCellInfo> _highlightedCells = [];\n```\n\n**New Methods:**\n```dart\n/// Called by DragTarget.onMove with raw position data\nvoid handleDragMove({\n  required Offset globalPosition,\n  required double dayWidth,\n  required double horizontalSpacing,\n  required double grabOffsetX,\n  required int eventDurationDays,\n  required List<DateTime> weekDates,\n  required int weekRowIndex,\n  required Size calendarSize,\n  required Rect weekRowBounds,\n});\n\n/// Internal: Process debounced position update\nvoid _processPositionUpdate();\n\n/// Internal: Calculate target cells from position\n(int startCell, int endCell, int weekRow) _calculateTargetCells();\n```\n\n**Dependencies:** None (pure Dart)\n\n**Reuses:** Existing `MCalDragHandler` fields and methods\n\n### Component 2: MCalDropOverlayDetails\n\n**Purpose:** Details object passed to `dropTargetOverlayBuilder` for full overlay control\n\n**Location:** `lib/src/widgets/mcal_callback_details.dart`\n\n```dart\n/// Details for building a custom drop target overlay.\n///\n/// Passed to [MCalMonthView.dropTargetOverlayBuilder] when a drag is active.\nclass MCalDropOverlayDetails {\n  /// List of cells that should be highlighted.\n  final List<MCalHighlightCellInfo> highlightedCells;\n  \n  /// Whether the current drop position is valid.\n  final bool isValid;\n  \n  /// Width of each day cell in pixels.\n  final double dayWidth;\n  \n  /// Total size of the calendar area.\n  final Size calendarSize;\n  \n  /// The drag data being dragged.\n  final MCalDragData dragData;\n  \n  const MCalDropOverlayDetails({\n    required this.highlightedCells,\n    required this.isValid,\n    required this.dayWidth,\n    required this.calendarSize,\n    required this.dragData,\n  });\n}\n```\n\n### Component 3: MCalDropTargetCellDetails\n\n**Purpose:** Details object passed to `dropTargetCellBuilder` for per-cell styling\n\n**Location:** `lib/src/widgets/mcal_callback_details.dart`\n\n```dart\n/// Details for building a custom drop target cell.\n///\n/// Passed to [MCalMonthView.dropTargetCellBuilder] for each highlighted cell.\nclass MCalDropTargetCellDetails {\n  /// The date of this cell.\n  final DateTime date;\n  \n  /// The bounds of this cell in local coordinates.\n  final Rect bounds;\n  \n  /// Whether this cell represents a valid drop target.\n  final bool isValid;\n  \n  /// Whether this is the first cell in the highlighted range.\n  final bool isFirst;\n  \n  /// Whether this is the last cell in the highlighted range.\n  final bool isLast;\n  \n  /// The cell's index within the week (0 = Sunday/Monday based on firstDayOfWeek).\n  final int cellIndex;\n  \n  /// The week row index within the month grid.\n  final int weekRowIndex;\n  \n  const MCalDropTargetCellDetails({\n    required this.date,\n    required this.bounds,\n    required this.isValid,\n    required this.isFirst,\n    required this.isLast,\n    required this.cellIndex,\n    required this.weekRowIndex,\n  });\n}\n```\n\n### Component 4: MCalHighlightCellInfo\n\n**Purpose:** Data class representing a single cell to highlight\n\n**Location:** `lib/src/widgets/mcal_callback_details.dart`\n\n```dart\n/// Information about a single cell to highlight during drag-and-drop.\nclass MCalHighlightCellInfo {\n  /// The date of this cell.\n  final DateTime date;\n  \n  /// Cell index within its week row (0-6).\n  final int cellIndex;\n  \n  /// Week row index within the month grid.\n  final int weekRowIndex;\n  \n  /// Bounds of this cell in calendar-local coordinates.\n  final Rect bounds;\n  \n  /// Whether this is the first cell in the event's span.\n  final bool isFirst;\n  \n  /// Whether this is the last cell in the event's span.\n  final bool isLast;\n  \n  const MCalHighlightCellInfo({\n    required this.date,\n    required this.cellIndex,\n    required this.weekRowIndex,\n    required this.bounds,\n    required this.isFirst,\n    required this.isLast,\n  });\n}\n```\n\n### Component 5: _DropTargetHighlightPainter\n\n**Purpose:** Default CustomPainter for efficient highlight rendering\n\n**Location:** `lib/src/widgets/mcal_month_view.dart` (private)\n\n```dart\n/// CustomPainter for rendering drop target highlights efficiently.\nclass _DropTargetHighlightPainter extends CustomPainter {\n  final List<MCalHighlightCellInfo> highlightedCells;\n  final bool isValid;\n  final Color validColor;\n  final Color invalidColor;\n  final double borderRadius;\n  \n  _DropTargetHighlightPainter({\n    required this.highlightedCells,\n    required this.isValid,\n    this.validColor = const Color(0x4000FF00),\n    this.invalidColor = const Color(0x40FF0000),\n    this.borderRadius = 4.0,\n  });\n  \n  @override\n  void paint(Canvas canvas, Size size) {\n    if (highlightedCells.isEmpty) return;\n    \n    final paint = Paint()\n      ..color = isValid ? validColor : invalidColor\n      ..style = PaintingStyle.fill;\n    \n    for (final cell in highlightedCells) {\n      final rrect = RRect.fromRectAndRadius(\n        cell.bounds,\n        Radius.circular(borderRadius),\n      );\n      canvas.drawRRect(rrect, paint);\n    }\n  }\n  \n  @override\n  bool shouldRepaint(_DropTargetHighlightPainter oldDelegate) {\n    return oldDelegate.highlightedCells != highlightedCells ||\n           oldDelegate.isValid != isValid;\n  }\n}\n```\n\n### Component 6: Updated _MonthPageWidget\n\n**Purpose:** Month page with unified DragTarget wrapper\n\n**Key Changes:**\n```dart\nWidget build(BuildContext context) {\n  return DragTarget<MCalDragData>(\n    onMove: _handleDragMove,\n    onLeave: _handleDragLeave,\n    onAcceptWithDetails: _handleDrop,\n    builder: (context, candidateData, rejectedData) {\n      return Stack(\n        children: [\n          // Layer 1: Grid background with date labels\n          _buildLayer1Grid(context),\n          \n          // Layer 2: Event tiles\n          _buildLayer2Events(context),\n          \n          // Layer 3: Highlight overlay (IgnorePointer for pass-through)\n          if (widget.enableDragAndDrop && _isDragActive)\n            IgnorePointer(\n              child: _buildLayer3HighlightOverlay(context),\n            ),\n        ],\n      );\n    },\n  );\n}\n\nvoid _handleDragMove(DragTargetDetails<MCalDragData> details) {\n  widget.dragHandler?.handleDragMove(\n    globalPosition: details.offset + Offset(details.data.grabOffsetX, 0),\n    dayWidth: _dayWidth,\n    horizontalSpacing: details.data.horizontalSpacing,\n    grabOffsetX: details.data.grabOffsetX,\n    eventDurationDays: _calculateEventDuration(details.data.event),\n    weekDates: _allWeekDates,\n    weekRowBounds: _weekRowBounds,\n    calendarSize: _calendarSize,\n    validationCallback: widget.onDragWillAccept,\n  );\n}\n\nWidget _buildLayer3HighlightOverlay(BuildContext context) {\n  final dragHandler = widget.dragHandler;\n  if (dragHandler == null) return const SizedBox.shrink();\n  \n  final highlightedCells = dragHandler.highlightedCells;\n  final isValid = dragHandler.isProposedDropValid;\n  \n  // Precedence: dropTargetOverlayBuilder > dropTargetCellBuilder > default\n  if (widget.dropTargetOverlayBuilder != null) {\n    return widget.dropTargetOverlayBuilder!(\n      context,\n      MCalDropOverlayDetails(\n        highlightedCells: highlightedCells,\n        isValid: isValid,\n        dayWidth: _dayWidth,\n        calendarSize: _calendarSize,\n        dragData: dragHandler.draggedEventData!,\n      ),\n    );\n  }\n  \n  if (widget.dropTargetCellBuilder != null) {\n    return Stack(\n      children: [\n        for (int i = 0; i < highlightedCells.length; i++)\n          Positioned.fromRect(\n            rect: highlightedCells[i].bounds,\n            child: widget.dropTargetCellBuilder!(\n              context,\n              MCalDropTargetCellDetails(\n                date: highlightedCells[i].date,\n                bounds: highlightedCells[i].bounds,\n                isValid: isValid,\n                isFirst: highlightedCells[i].isFirst,\n                isLast: highlightedCells[i].isLast,\n                cellIndex: highlightedCells[i].cellIndex,\n                weekRowIndex: highlightedCells[i].weekRowIndex,\n              ),\n            ),\n          ),\n      ],\n    );\n  }\n  \n  // Default: CustomPainter\n  return CustomPaint(\n    size: _calendarSize,\n    painter: _DropTargetHighlightPainter(\n      highlightedCells: highlightedCells,\n      isValid: isValid,\n    ),\n  );\n}\n```\n\n## Data Models\n\n### MCalHighlightCellInfo\n```dart\nclass MCalHighlightCellInfo {\n  final DateTime date;\n  final int cellIndex;      // 0-6 within week\n  final int weekRowIndex;   // 0-5 within month\n  final Rect bounds;        // Position in calendar coordinates\n  final bool isFirst;\n  final bool isLast;\n}\n```\n\n### MCalDropOverlayDetails\n```dart\nclass MCalDropOverlayDetails {\n  final List<MCalHighlightCellInfo> highlightedCells;\n  final bool isValid;\n  final double dayWidth;\n  final Size calendarSize;\n  final MCalDragData dragData;\n}\n```\n\n### MCalDropTargetCellDetails\n```dart\nclass MCalDropTargetCellDetails {\n  final DateTime date;\n  final Rect bounds;\n  final bool isValid;\n  final bool isFirst;\n  final bool isLast;\n  final int cellIndex;\n  final int weekRowIndex;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Drag leaves calendar area**\n   - **Handling:** `onLeave` clears highlight state, cancels debounce timer\n   - **User Impact:** Highlights disappear, drag can continue outside\n\n2. **Widget disposed during drag**\n   - **Handling:** `dispose()` cancels all timers, clears state\n   - **User Impact:** No visual artifacts, no memory leaks\n\n3. **RenderBox not available for position calculation**\n   - **Handling:** Fallback to last known good state, log warning in debug mode\n   - **User Impact:** Highlights may freeze momentarily, recovers on next valid position\n\n4. **Invalid drop over blocked cells**\n   - **Handling:** `onAcceptWithDetails` checks `isProposedDropValid`, returns early if false\n   - **User Impact:** Event returns to original position, no data corruption\n\n5. **Edge navigation during drag**\n   - **Handling:** Timer-based navigation continues to work via existing `handleEdgeProximity`\n   - **User Impact:** Smooth month transitions while maintaining drag state\n\n## Testing Strategy\n\n### Unit Testing\n\n- **MCalDragHandler debouncing**: Verify timer behavior, latest-position-wins\n- **Cell detection math**: Verify `(pointerX - grabOffsetX - spacing) / dayWidth` calculations\n- **Change detection**: Verify no updates when target cells unchanged\n- **MCalHighlightCellInfo equality**: Verify proper comparison for shouldRepaint\n\n### Widget Testing\n\n- **DragTarget wrapper**: Verify onMove receives correct data\n- **Highlight overlay rendering**: Verify correct cells highlighted\n- **Builder precedence**: Verify overlay > cell > default precedence\n- **CustomPainter shouldRepaint**: Verify efficient repainting\n\n### Integration Testing\n\n- **Multi-day event drag**: Verify N-day event highlights N cells\n- **Cross-week highlighting**: Verify cells highlighted across week boundaries\n- **Invalid drop visualization**: Verify red highlighting when onDragWillAccept returns false\n- **Drop accuracy**: Verify dropped position matches highlighted position\n- **Edge navigation**: Verify month navigation during drag\n\n### Performance Testing\n\n- **Frame rate during drag**: Measure FPS during continuous drag motion\n- **Debounce effectiveness**: Verify onMove processing capped at ~60/sec\n- **Change detection savings**: Measure skipped repaints when hovering same cell\n\n## Migration Notes\n\n### Breaking Changes\n\n- `dropTargetCellBuilder` signature updated to receive `MCalDropTargetCellDetails`\n- Per-cell DragTargets removed (internal change, no API impact)\n\n### Deprecations\n\n- None (existing `dropTargetCellBuilder` enhanced, not deprecated)\n\n### Backward Compatibility\n\n- Existing `onDragWillAccept` callback continues to work\n- Existing `onEventDropped` callback continues to work\n- `dragHandler` parameter continues to work\n- `dragEdgeNavigationEnabled` and `dragEdgeNavigationDelay` continue to work\n",
  "fileStats": {
    "size": 16295,
    "lines": 523,
    "lastModified": "2026-02-07T23:02:34.089Z"
  },
  "comments": []
}