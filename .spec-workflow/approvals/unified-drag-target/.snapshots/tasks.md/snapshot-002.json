{
  "id": "snapshot_1770505829153_bmwnhx6al",
  "approvalId": "approval_1770505776422_v5jrvok0r",
  "approvalTitle": "Tasks: Unified Drag Target Architecture",
  "version": 2,
  "timestamp": "2026-02-07T23:10:29.153Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document: Unified Drag Target Architecture\n\n## Phase 1: Data Models and Details Classes\n\n- [ ] 1. Create MCalHighlightCellInfo data class\n  - File: lib/src/widgets/mcal_callback_details.dart\n  - Add data class for individual highlighted cell information\n  - Include: date, cellIndex, weekRowIndex, bounds, isFirst, isLast\n  - Purpose: Represent a single cell to highlight during drag-and-drop\n  - _Leverage: Existing pattern from MCalDragData in same file_\n  - _Requirements: 5.3, 5.4_\n\n- [ ] 2. Create MCalDropOverlayDetails class\n  - File: lib/src/widgets/mcal_callback_details.dart\n  - Add details class for dropTargetOverlayBuilder callback\n  - Include: highlightedCells list, isValid, dayWidth, calendarSize, dragData\n  - Purpose: Provide full overlay context for advanced customization\n  - _Leverage: Existing pattern from MCalDragWillAcceptDetails_\n  - _Requirements: 5.2, 5.3_\n\n- [ ] 3. Create MCalDropTargetCellDetails class\n  - File: lib/src/widgets/mcal_callback_details.dart\n  - Add details class for dropTargetCellBuilder callback\n  - Include: date, bounds, isValid, isFirst, isLast, cellIndex, weekRowIndex\n  - Purpose: Provide per-cell context for simpler customization\n  - _Leverage: Existing pattern from MCalCellTapDetails_\n  - _Requirements: 5.4_\n\n## Phase 2: Extend MCalDragHandler\n\n- [ ] 4. Add debounce state fields to MCalDragHandler\n  - File: lib/src/widgets/mcal_drag_handler.dart\n  - Add: _debounceTimer, _latestPosition, _debounceDuration constant\n  - Add: _previousStartCellIndex, _previousEndCellIndex, _previousWeekRowIndex for change detection\n  - Purpose: Support debounced position updates with change detection\n  - _Leverage: Existing Timer pattern from _edgeNavigationTimer_\n  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_\n\n- [ ] 5. Add highlightedCells state to MCalDragHandler\n  - File: lib/src/widgets/mcal_drag_handler.dart\n  - Add: _highlightedCells list and public getter\n  - Add: method to build cell info list from proposed date range\n  - Purpose: Provide computed cell list for overlay rendering\n  - _Leverage: Existing proposedStartDate/proposedEndDate fields_\n  - _Requirements: 5.1_\n\n- [ ] 6. Implement handleDragMove method in MCalDragHandler\n  - File: lib/src/widgets/mcal_drag_handler.dart\n  - Create handleDragMove method that receives raw position data\n  - Implement 16ms debounce timer logic (latest-position-wins)\n  - Call internal _processPositionUpdate when timer fires\n  - Purpose: Central entry point for onMove position tracking\n  - _Leverage: Existing handleEdgeProximity pattern_\n  - _Requirements: 1.2, 3.1, 3.2_\n\n- [ ] 7. Implement cell detection and change detection in MCalDragHandler\n  - File: lib/src/widgets/mcal_drag_handler.dart\n  - Implement _processPositionUpdate method\n  - Calculate target cells: floor((pointerLocalX - grabOffsetX - horizontalSpacing) / dayWidth)\n  - Compare with previous target cells, skip update if unchanged\n  - Call validation callback if provided, update state if changed\n  - Purpose: Mathematical cell detection with performance optimization\n  - _Leverage: Existing updateProposedDropRange pattern_\n  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3_\n\n- [ ] 8. Add cleanup methods to MCalDragHandler\n  - File: lib/src/widgets/mcal_drag_handler.dart\n  - Add method to cancel debounce timer\n  - Update _reset and dispose to cancel debounce timer\n  - Add clearHighlightedCells method for onLeave handling\n  - Purpose: Proper resource cleanup in all scenarios\n  - _Leverage: Existing _cancelEdgeNavigationTimer pattern_\n  - _Requirements: 8.1, 8.2, 8.3, 8.4_\n\n## Phase 3: Create Default Highlight Painter\n\n- [ ] 9. Create DropTargetHighlightPainter class\n  - File: lib/src/widgets/mcal_month_view.dart (private class)\n  - Implement CustomPainter for efficient highlight rendering\n  - Draw colored rounded rectangles for each highlighted cell\n  - Implement shouldRepaint for efficient repainting\n  - Purpose: Default performant highlight rendering\n  - _Leverage: Flutter CustomPainter pattern_\n  - _Requirements: 5.5_\n\n## Phase 4: Refactor MonthPageWidget\n\n- [ ] 10. Add unified DragTarget wrapper to MonthPageWidget\n  - File: lib/src/widgets/mcal_month_view.dart\n  - Wrap Stack in single DragTarget widget\n  - Add onMove, onLeave, onAcceptWithDetails handlers\n  - Store calendar size and week row bounds for position calculations\n  - Purpose: Single entry point for all drag events\n  - _Leverage: Existing DragTarget pattern in _buildLayer3DropTargets_\n  - _Requirements: 1.1, 1.2, 1.3_\n\n- [ ] 11. Implement _handleDragMove in MonthPageWidget\n  - File: lib/src/widgets/mcal_month_view.dart\n  - Convert details.offset to pointer position (add grabOffsetX)\n  - Call dragHandler.handleDragMove with all required parameters\n  - Handle edge proximity for month navigation\n  - Purpose: Bridge between DragTarget and MCalDragHandler\n  - _Leverage: Existing onWillAcceptWithDetails logic_\n  - _Requirements: 1.2, 7.1, 7.2, 7.3, 7.4_\n\n- [ ] 12. Implement _handleDragLeave in MonthPageWidget\n  - File: lib/src/widgets/mcal_month_view.dart\n  - Clear highlight state via dragHandler\n  - Cancel any pending debounce timers\n  - Purpose: Clean up when drag leaves calendar area\n  - _Leverage: Existing onLeave pattern_\n  - _Requirements: 8.1_\n\n- [ ] 13. Update _handleDrop (onAcceptWithDetails) in MonthPageWidget\n  - File: lib/src/widgets/mcal_month_view.dart\n  - Check isProposedDropValid, return early if false\n  - Use proposedStartDate/proposedEndDate for drop location\n  - Clean up all drag state after drop\n  - Purpose: Ensure drop matches visual feedback, handle invalid drops\n  - _Leverage: Existing onAcceptWithDetails logic_\n  - _Requirements: 6.1, 6.2, 6.3, 6.4_\n\n## Phase 5: Implement Highlight Overlay Layer\n\n- [ ] 14. Create _buildLayer3HighlightOverlay method\n  - File: lib/src/widgets/mcal_month_view.dart\n  - Implement builder precedence: overlayBuilder > cellBuilder > default\n  - Wrap in IgnorePointer for pass-through\n  - Only render when drag is active\n  - Purpose: Flexible highlight overlay with customization support\n  - _Leverage: Existing _buildLayer3DropTargets structure_\n  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_\n\n- [ ] 15. Add dropTargetOverlayBuilder parameter to MCalMonthView\n  - File: lib/src/widgets/mcal_month_view.dart\n  - Add optional builder parameter with MCalDropOverlayDetails signature\n  - Pass through to MonthPageWidget\n  - Document in class dartdoc\n  - Purpose: Enable advanced overlay customization\n  - _Leverage: Existing builder parameter patterns_\n  - _Requirements: 5.2, 5.3_\n\n- [ ] 16. Update dropTargetCellBuilder parameter signature\n  - File: lib/src/widgets/mcal_month_view.dart\n  - Update signature to use MCalDropTargetCellDetails\n  - Update any existing usages in example app\n  - Document breaking change\n  - Purpose: Enhanced per-cell customization with position flags\n  - _Leverage: Existing dropTargetCellBuilder_\n  - _Requirements: 5.4_\n\n## Phase 6: Remove Old Per-Cell DragTargets\n\n- [ ] 17. Remove per-cell DragTargets from WeekRowWidget\n  - File: lib/src/widgets/mcal_month_view.dart\n  - Remove _buildLayer3DropTargets method from WeekRowWidget\n  - Remove _hoveredDropTarget state\n  - Remove _shouldHighlightCell method\n  - Purpose: Clean up old implementation\n  - _Leverage: N/A (removal task)_\n  - _Requirements: 1.1_\n\n- [ ] 18. Update WeekRowWidget build method\n  - File: lib/src/widgets/mcal_month_view.dart\n  - Remove Layer 3 from week row Stack\n  - Simplify to only Layer 1 (grid) and Layer 2 (events)\n  - Purpose: WeekRowWidget now only handles grid and events\n  - _Leverage: Existing build structure_\n  - _Requirements: 1.1_\n\n## Phase 7: Testing\n\n- [ ] 19. Add unit tests for MCalDragHandler debouncing\n  - File: test/widgets/mcal_drag_handler_test.dart\n  - Test debounce timer behavior\n  - Test latest-position-wins semantics\n  - Test change detection (no update when same cell)\n  - Purpose: Verify debounce and change detection logic\n  - _Leverage: Existing test patterns_\n  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_\n\n- [ ] 20. Add unit tests for cell detection math\n  - File: test/widgets/mcal_drag_handler_test.dart\n  - Test calculation: floor((pointerLocalX - grabOffsetX - horizontalSpacing) / dayWidth)\n  - Test edge cases: negative indices, beyond week bounds\n  - Test multi-day event spanning multiple weeks\n  - Purpose: Verify mathematical cell detection accuracy\n  - _Leverage: Existing test patterns_\n  - _Requirements: 2.1, 2.2, 2.3_\n\n- [ ] 21. Add widget tests for unified DragTarget\n  - File: test/widgets/mcal_month_view_test.dart\n  - Test onMove receives correct data\n  - Test builder precedence (overlay > cell > default)\n  - Test drop matches highlighted position\n  - Purpose: Verify widget integration\n  - _Leverage: Existing mcal_month_view_test.dart patterns_\n  - _Requirements: 1.1, 1.2, 5.2, 6.2_\n\n- [ ] 22. Update existing drag-and-drop tests\n  - File: test/widgets/mcal_month_view_test.dart\n  - Update tests to work with new unified DragTarget\n  - Remove tests for per-cell DragTarget behavior\n  - Add tests for invalid drop handling\n  - Purpose: Maintain test coverage after refactor\n  - _Leverage: Existing test structure_\n  - _Requirements: 6.3, 8.1, 8.2, 8.3_\n\n## Phase 8: Documentation and Example\n\n- [ ] 23. Update example app to use new builders\n  - File: example/lib/views/month_view/styles/features_demo_style.dart\n  - Update dropTargetCellBuilder usage if present\n  - Add example of dropTargetOverlayBuilder usage\n  - Purpose: Demonstrate new API usage\n  - _Leverage: Existing example patterns_\n  - _Requirements: 5.2, 5.4_\n\n- [ ] 24. Add dartdoc for new public APIs\n  - Files: mcal_callback_details.dart, mcal_month_view.dart\n  - Document MCalHighlightCellInfo, MCalDropOverlayDetails, MCalDropTargetCellDetails\n  - Document dropTargetOverlayBuilder parameter\n  - Document builder precedence\n  - Purpose: Complete API documentation\n  - _Leverage: Existing dartdoc patterns_\n  - _Requirements: NFR - Clear Interfaces_\n",
  "fileStats": {
    "size": 9935,
    "lines": 227,
    "lastModified": "2026-02-07T23:09:32.208Z"
  },
  "comments": []
}