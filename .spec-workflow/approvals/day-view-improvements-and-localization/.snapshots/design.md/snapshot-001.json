{
  "id": "snapshot_1771198718906_oor0g0x3n",
  "approvalId": "approval_1771198718901_1qqq0075i",
  "approvalTitle": "Design Document",
  "version": 1,
  "timestamp": "2026-02-15T23:38:38.906Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design addresses eight distinct requirements across localization, theming, UI enhancements, and interaction patterns. The implementation is structured into logical phases that build upon each other while maintaining backward compatibility where feasible (though not strictly required). The design leverages existing Flutter patterns, follows Material Design 3 guidelines, and maintains consistency with the package's established architecture.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n*Note: Steering documents do not exist yet for this project. Design follows general Flutter best practices.*\n\n- **Dart/Flutter Standards**: Uses Flutter's official gen-l10n system for internationalization as recommended by Flutter documentation\n- **Material Design 3**: Theme architecture follows M3 theming patterns with nested theme data objects\n- **Type Safety**: Leverages generated localization classes for compile-time safety\n- **Testing**: Comprehensive unit, widget, and integration tests for all new functionality\n\n### Project Structure (structure.md)\n\n*Note: Steering documents do not exist yet for this project.*\n\n- Follows existing package structure with theme classes in `lib/src/styles/`\n- Localization files in `lib/l10n/` and generated code in `.dart_tool/flutter_gen/gen_l10n/`\n- Widget implementations remain in `lib/src/widgets/`\n- Example app organization mirrors main package structure\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **MCalThemeData (lib/src/styles/mcal_theme.dart)**: Will be refactored into nested structure while maintaining existing properties\n- **MCalLocalizations (lib/src/utils/mcal_localization.dart)**: Current manual Map-based system will be deprecated in favor of generated classes, but retained temporarily for backward compatibility\n- **_TimeLegendColumn (mcal_day_view.dart lines 4239-4389)**: Already renders time labels; will be extended with CustomPainter for tick marks\n- **GestureDetector patterns in Day View**: Existing double-tap implementation serves as template for Month View\n- **intl package**: Already integrated for date/time formatting; will continue using for locale-aware formatting\n\n### Integration Points\n\n- **Flutter gen-l10n system**: Integrates with Flutter's build system via `l10n.yaml` configuration\n- **Theme.of(context)**: Existing theme resolution through InheritedWidget chain remains unchanged\n- **MCalEventController**: No changes needed; works with all views regardless of interaction patterns\n- **ARB files**: Already exist for English and Spanish; will be extended to 5 languages with additional keys\n\n## Architecture\n\nThe design follows a phased approach with clear separation of concerns:\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each theme data class (MCalThemeData, MCalMonthThemeData, MCalDayThemeData) handles only its view-specific properties\n- **Component Isolation**: Localization infrastructure is completely isolated from UI components; views depend only on generated localization classes\n- **Service Layer Separation**: Theme resolution, localization lookup, and gesture handling are distinct concerns\n- **Utility Modularity**: CustomPainter for tick marks is a focused, single-purpose utility class\n\n```mermaid\ngraph TD\n    A[MCalThemeData Root] --> B[MCalMonthThemeData]\n    A --> C[MCalDayThemeData]\n    A --> D[Shared Properties]\n    \n    E[MCalDayView] --> C\n    E --> F[Generated MCalLocalizations]\n    E --> G[_TimeLegendTickPainter]\n    \n    H[MCalMonthView] --> B\n    H --> F\n    H --> I[Double-Tap GestureDetectors]\n    \n    F --> J[ARB Files: en, es, fr, ar, he]\n    \n    K[Flutter gen-l10n] --> F\n    J --> K\n```\n\n## Components and Interfaces\n\n### Component 1: Nested Theme Data Architecture\n\n**File:** `lib/src/styles/mcal_theme.dart` (refactored)\n\n**Purpose:** Organize theme properties into view-specific nested classes for better discoverability and maintainability.\n\n**Interfaces:**\n```dart\nclass MCalThemeData extends ThemeExtension<MCalThemeData> {\n  // Shared properties (used by multiple views)\n  final Color? cellBackgroundColor;\n  final Color? eventTileBackgroundColor;\n  final TextStyle? navigatorTextStyle;\n  // ... other shared properties\n  \n  // Nested view-specific themes\n  final MCalMonthThemeData? monthTheme;\n  final MCalDayThemeData? dayTheme;\n  \n  // Constructor, copyWith, lerp, fromTheme methods\n}\n\nclass MCalMonthThemeData {\n  // Month-specific properties\n  final Color? weekdayHeaderBackgroundColor;\n  final TextStyle? weekNumberTextStyle;\n  final DateLabelPosition? dateLabelPosition;\n  final double? eventTileHeight;\n  final double? overflowIndicatorHeight;\n  // ... other month-specific properties\n  \n  // Constructor, copyWith, lerp methods\n}\n\nclass MCalDayThemeData {\n  // Day-specific properties\n  final double? timeLegendWidth;\n  final TextStyle? timeLegendTextStyle;\n  final Color? timeLegendBackgroundColor;\n  final bool? showTimeLegendTicks;\n  final Color? timeLegendTickColor;\n  final double? timeLegendTickWidth;\n  final double? timeLegendTickLength;\n  final Color? hourGridlineColor;\n  final double? hourGridlineWidth;\n  final Color? currentTimeIndicatorColor;\n  final int? allDaySectionMaxRows;\n  // ... other day-specific properties\n  \n  // Constructor, copyWith, lerp methods\n}\n```\n\n**Dependencies:** Flutter Material package\n\n**Reuses:** Existing MCalThemeData structure, property names, and default values\n\n**Migration Path:**\n- Old: `theme.timeLegendWidth`\n- New: `theme.dayTheme?.timeLegendWidth` (with null fallback to root theme if needed during transition)\n\n### Component 2: Time Legend Tick Marks\n\n**File:** `lib/src/widgets/mcal_day_view.dart` (lines 4239-4470, extended)\n\n**Purpose:** Add visual tick marks to time legend for improved visual alignment.\n\n**Interfaces:**\n```dart\nclass _TimeLegendTickPainter extends CustomPainter {\n  const _TimeLegendTickPainter({\n    required this.startHour,\n    required this.endHour,\n    required this.hourHeight,\n    required this.tickColor,\n    required this.tickWidth,\n    required this.tickLength,\n    required this.isRTL,\n    required this.displayDate,\n  });\n  \n  @override\n  void paint(Canvas canvas, Size size);\n  \n  @override\n  bool shouldRepaint(covariant _TimeLegendTickPainter oldDelegate);\n}\n```\n\n**Integration:** Added to `_TimeLegendColumn` widget's Stack as a background layer behind time labels.\n\n**Dependencies:** \n- MCalThemeData.dayTheme for tick configuration\n- MCalLocalizations for RTL detection\n\n**Reuses:** Existing `timeToOffset` utility function for positioning\n\n### Component 3: Flutter gen-l10n Localization System\n\n**Files:** \n- `l10n.yaml` (configuration)\n- `lib/l10n/app_*.arb` (6 files: en, es, es_MX, fr, ar, he)\n- `.dart_tool/flutter_gen/gen_l10n/mcal_localizations*.dart` (generated)\n\n**Purpose:** Replace manual Map-based localization with Flutter's official, type-safe localization system.\n\n**Interfaces:**\n```dart\n// Generated class (example)\nabstract class MCalLocalizations {\n  static const List<Locale> supportedLocales = [\n    Locale('en'),\n    Locale('es'),\n    Locale('es', 'MX'),\n    Locale('fr'),\n    Locale('ar'),\n    Locale('he'),\n  ];\n  \n  String get previousDay;\n  String get nextDay;\n  String get today;\n  String currentTime(String time);  // With parameter\n  String scheduleFor(String date);\n  // ... all other localized strings\n  \n  static MCalLocalizations of(BuildContext context);\n}\n```\n\n**Configuration (l10n.yaml):**\n```yaml\narb-dir: lib/l10n\ntemplate-arb-file: app_en.arb\noutput-localization-file: mcal_localizations.dart\noutput-class: MCalLocalizations\nnullable-getter: false\n```\n\n**Dependencies:** flutter_localizations, intl package\n\n**Reuses:** Existing ARB files (app_en.arb, app_es_MX.arb) extended with new keys\n\n**Migration:**\n- Deprecate `lib/src/utils/mcal_localization.dart`\n- Update all imports from manual class to generated class\n- Use `MCalLocalizations.of(context)` instead of `MCalLocalizations()`\n\n### Component 4: RTL Layout Corrections\n\n**Files:** `lib/src/widgets/mcal_day_view.dart` (multiple sections)\n\n**Purpose:** Fix RTL layout issues in Day View including time legend positioning, navigator arrows, and tooltips.\n\n**Changes:**\n1. **Time Legend Positioning** (lines 3757-3797):\n   - Already correctly implemented with conditional rendering based on `_isRTL(context)`\n   - Left side for LTR, right side for RTL\n\n2. **Navigator Button Logic** (lines 3907-4036):\n   - Verify arrow directions in RTL match expected behavior\n   - Left arrow = next day (forward), Right arrow = previous day (backward) in RTL\n   - All tooltips use `MCalLocalizations` generated strings\n\n3. **Current Time Indicator** (lines 4485-4493):\n   - Dot positioning already handles RTL correctly\n\n**Dependencies:** Generated MCalLocalizations for localized labels\n\n**Reuses:** Existing `_isRTL` detection method, Directionality.of(context)\n\n### Component 5: Month View Double-Tap Handlers\n\n**File:** `lib/src/widgets/mcal_month_view.dart` (multiple sections)\n\n**Purpose:** Add double-tap gesture handling to Month View for feature parity with Day View.\n\n**Interfaces:**\n```dart\n// Add to MCalMonthView parameters\nclass MCalMonthView extends StatefulWidget {\n  // ... existing parameters\n  \n  /// Called when user double-taps an empty date cell.\n  final void Function(BuildContext, MCalCellDoubleTapDetails)? onCellDoubleTap;\n  \n  /// Called when user double-taps an event tile.\n  final void Function(BuildContext, MCalEventDoubleTapDetails)? onEventDoubleTap;\n}\n\n// New detail classes\nclass MCalCellDoubleTapDetails {\n  final DateTime date;\n  final Offset localPosition;\n  final Offset globalPosition;\n}\n\nclass MCalEventDoubleTapDetails {\n  final MCalCalendarEvent event;\n  final Offset localPosition;\n  final Offset globalPosition;\n  final DateTime date;  // Date on which event was double-tapped\n}\n```\n\n**Implementation Strategy:**\n- Add `onDoubleTapDown` and `onDoubleTap` to existing GestureDetector wrapping date cells\n- Store tap position in State variable (similar to Day View's `_lastDoubleTapDownPosition`)\n- Use appropriate timing to distinguish single-tap from double-tap\n- Maintain all existing single-tap and long-press handlers\n\n**Dependencies:** None\n\n**Reuses:** Pattern from Day View's double-tap implementation (lines 3344-3362)\n\n### Component 6: Example App Reorganization\n\n**File:** `example/lib/views/day_view/day_view_showcase.dart`\n\n**Purpose:** Improve example app UX by reorganizing tabs and removing redundant RTL demo.\n\n**Changes:**\n1. Reorder `_buildStyles` method to put Features first\n2. Remove `RtlDemoDayStyle` class and related `_RtlDemoDayViewContent` (lines 193-358)\n3. Update TabController length from 10 to 9\n4. Update ARB files to rename `styleFeaturesDemo` → `styleFeatures`\n\n**Dependencies:** Example app l10n\n\n**Reuses:** Existing tab structure and navigation\n\n### Component 7: Enhanced Features Demo\n\n**File:** `example/lib/views/day_view/styles/features_demo_style.dart` (expanded)\n\n**Purpose:** Create comprehensive interactive demo showcasing Day View customization capabilities.\n\n**Architecture:**\n```dart\nclass FeaturesDemoDayStyle extends StatefulWidget {\n  // Interactive control panel with:\n  // - Hour height slider (60-120)\n  // - Gridline interval selector (5/10/15/30 min)\n  // - Snap-to-time toggle\n  // - Edge navigation delay slider\n  // - Time legend tick toggles and controls\n  // - Special time regions (lunch, after-hours) toggles\n  // - Blocked time regions toggles\n  // - Preset configurations dropdown\n  \n  @override\n  State<FeaturesDemoDayStyle> createState() => _FeaturesDemoDayStyleState();\n}\n\nclass _FeaturesDemoDayStyleState extends State<FeaturesDemoDayStyle> {\n  // State variables for all customizable options\n  double _hourHeight = 80.0;\n  Duration _gridlineInterval = const Duration(minutes: 15);\n  bool _snapToTimeSlots = true;\n  bool _showTimeLegendTicks = true;\n  Color _timeLegendTickColor = Colors.grey;\n  double _timeLegendTickLength = 8.0;\n  bool _showLunchRegion = true;\n  bool _showAfterHoursRegion = true;\n  // ... more state variables\n  \n  // Build methods for control panel and day view\n}\n```\n\n**UI Structure:**\n- Top: Control panel with collapsible sections (Theme, Gridlines, Interactions, Special Regions)\n- Bottom: Live Day View demonstrating current configuration\n- Side panel (optional): Code snippet showing theme configuration\n\n**Reuses:** Month View's features demo as template (example/lib/views/month_view/styles/features_demo_style.dart)\n\n### Component 8: Hebrew Language Support\n\n**Files:** \n- `lib/l10n/app_he.arb`\n- `example/lib/l10n/app_he.arb`\n- `lib/src/utils/mcal_localization.dart` (add Hebrew strings to maps)\n- `example/lib/screens/main_screen.dart` (add Hebrew to language menu)\n\n**Purpose:** Add Hebrew as the 5th supported language.\n\n**Implementation:**\n- Create comprehensive Hebrew translations for all 50+ strings\n- Add Hebrew to MCalLocalizations.supportedLocales\n- Add Hebrew option to example app language menu\n- Verify RTL layout works correctly (Hebrew is RTL like Arabic)\n\n**Dependencies:** Native Hebrew speaker review for translation quality\n\n**Reuses:** Arabic ARB files as RTL reference\n\n## Data Models\n\n### MCalThemeData (Refactored Structure)\n\n```dart\nclass MCalThemeData extends ThemeExtension<MCalThemeData> {\n  // === SHARED PROPERTIES (used by multiple views) ===\n  final Color? cellBackgroundColor;\n  final Color? cellBorderColor;\n  final TextStyle? cellTextStyle;\n  final Color? todayBackgroundColor;\n  final TextStyle? todayTextStyle;\n  final Color? focusedDateBackgroundColor;\n  final TextStyle? focusedDateTextStyle;\n  final Color? eventTileBackgroundColor;\n  final TextStyle? eventTileTextStyle;\n  final TextStyle? navigatorTextStyle;\n  final Color? navigatorBackgroundColor;\n  final Color? hoverCellBackgroundColor;\n  final Color? hoverEventBackgroundColor;\n  // ... other shared properties\n  \n  // === VIEW-SPECIFIC NESTED THEMES ===\n  final MCalMonthThemeData? monthTheme;\n  final MCalDayThemeData? dayTheme;\n  \n  // Standard ThemeExtension methods\n  MCalThemeData copyWith({...});\n  MCalThemeData lerp(MCalThemeData? other, double t);\n}\n```\n\n### MCalMonthThemeData (New)\n\n```dart\nclass MCalMonthThemeData {\n  // Month View specific properties\n  final TextStyle? weekdayHeaderTextStyle;\n  final Color? weekdayHeaderBackgroundColor;\n  final TextStyle? weekNumberTextStyle;\n  final Color? weekNumberBackgroundColor;\n  final double? eventTileHeight;\n  final double? eventTileHorizontalSpacing;\n  final double? eventTileVerticalSpacing;\n  final double? dateLabelHeight;\n  final DateLabelPosition? dateLabelPosition;\n  final double? overflowIndicatorHeight;\n  final double? eventTileCornerRadius;\n  final Color? multiDayEventBackgroundColor;\n  final TextStyle? multiDayEventTextStyle;\n  \n  const MCalMonthThemeData({...});\n  MCalMonthThemeData copyWith({...});\n  MCalMonthThemeData lerp(MCalMonthThemeData? other, double t);\n  \n  // Factory for defaults\n  factory MCalMonthThemeData.defaults(ThemeData theme) {...}\n}\n```\n\n### MCalDayThemeData (New)\n\n```dart\nclass MCalDayThemeData {\n  // Day View specific properties\n  final TextStyle? dayHeaderDayOfWeekStyle;\n  final TextStyle? dayHeaderDateStyle;\n  final Color? weekNumberTextColor;\n  final double? timeLegendWidth;\n  final TextStyle? timeLegendTextStyle;\n  final Color? timeLegendBackgroundColor;\n  final bool? showTimeLegendTicks;\n  final Color? timeLegendTickColor;\n  final double? timeLegendTickWidth;\n  final double? timeLegendTickLength;\n  final Color? hourGridlineColor;\n  final double? hourGridlineWidth;\n  final Color? majorGridlineColor;\n  final double? majorGridlineWidth;\n  final Color? minorGridlineColor;\n  final double? minorGridlineWidth;\n  final Color? currentTimeIndicatorColor;\n  final double? currentTimeIndicatorWidth;\n  final double? currentTimeIndicatorDotRadius;\n  final int? allDaySectionMaxRows;\n  final double? timedEventMinHeight;\n  final double? timedEventBorderRadius;\n  final EdgeInsets? timedEventPadding;\n  final Color? specialTimeRegionColor;\n  final Color? blockedTimeRegionColor;\n  final Color? timeRegionBorderColor;\n  final Color? timeRegionTextColor;\n  final TextStyle? timeRegionTextStyle;\n  \n  const MCalDayThemeData({...});\n  MCalDayThemeData copyWith({...});\n  MCalDayThemeData lerp(MCalDayThemeData? other, double t);\n  \n  // Factory for defaults\n  factory MCalDayThemeData.defaults(ThemeData theme) {...}\n}\n```\n\n### Localization Detail Classes (New)\n\n```dart\n// For double-tap handlers\nclass MCalCellDoubleTapDetails {\n  final DateTime date;\n  final Offset localPosition;\n  final Offset globalPosition;\n  \n  const MCalCellDoubleTapDetails({\n    required this.date,\n    required this.localPosition,\n    required this.globalPosition,\n  });\n}\n\nclass MCalEventDoubleTapDetails {\n  final MCalCalendarEvent event;\n  final Offset localPosition;\n  final Offset globalPosition;\n  final DateTime date;\n  \n  const MCalEventDoubleTapDetails({\n    required this.event,\n    required this.localPosition,\n    required this.globalPosition,\n    required this.date,\n  });\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Scenario: Missing ARB files during build**\n   - **Handling:** Flutter gen-l10n will fail at build time with clear error message indicating which ARB file is missing\n   - **User Impact:** Developer sees build error and must create missing ARB file\n   - **Prevention:** All 6 ARB files (en, es, es_MX, fr, ar, he) committed to repository\n\n2. **Scenario: Unsupported locale requested**\n   - **Handling:** Fall back through locale hierarchy (e.g., es_MX → es → en)\n   - **User Impact:** User sees content in fallback language\n   - **Prevention:** Document supported locales clearly\n\n3. **Scenario: Theme property null at runtime**\n   - **Handling:** Use default values from MCalThemeData.fromTheme(theme)\n   - **User Impact:** Component uses Material 3 defaults, no crash\n   - **Prevention:** All theme property access includes null coalescing\n\n4. **Scenario: Double-tap and single-tap conflict**\n   - **Handling:** Use gesture timing to distinguish (double-tap has priority)\n   - **User Impact:** Single-tap may have slight delay (~300ms) to detect double-tap\n   - **Prevention:** Document behavior; make configurable if needed\n\n5. **Scenario: RTL layout in unsupported language**\n   - **Handling:** RTL detected via MCalLocalizations.isRTL() based on language code\n   - **User Impact:** Layout mirrors correctly for any RTL language, even if not translated\n   - **Prevention:** RTL logic independent of translation availability\n\n## Testing Strategy\n\n### Unit Testing\n\n**Theme Architecture:**\n- Test `MCalMonthThemeData` construction, copyWith, lerp, equality\n- Test `MCalDayThemeData` construction, copyWith, lerp, equality\n- Test `MCalThemeData` with nested themes, null handling\n- Test theme property access patterns (root vs nested)\n- Verify migration path (old property access still works during transition)\n\n**Localization:**\n- Test ARB file parsing and code generation (build-time)\n- Test locale fallback chain (es_MX → es → en)\n- Test RTL detection for all RTL language codes\n- Test parameter substitution in localized strings (e.g., \"Current time: {time}\")\n\n**Time Legend Tick Marks:**\n- Test `_TimeLegendTickPainter.paint` produces correct line coordinates\n- Test tick positioning for LTR vs RTL\n- Test shouldRepaint logic\n- Test theme property null handling\n\n### Widget Testing\n\n**Double-Tap Handlers (Month View):**\n- Test `onCellDoubleTap` fires when double-tapping empty date cell\n- Test `onEventDoubleTap` fires when double-tapping event tile\n- Test single-tap still works alongside double-tap\n- Test long-press still works alongside double-tap\n- Test tap position passed correctly in details object\n\n**Time Legend Rendering:**\n- Test tick marks render when `showTimeLegendTicks = true`\n- Test tick marks hidden when `showTimeLegendTicks = false`\n- Test tick mark customization (color, width, length)\n- Golden test for LTR tick rendering\n- Golden test for RTL tick rendering\n\n**Localization Rendering:**\n- Test all navigation labels render in each of 5 languages\n- Test tooltips render in correct language\n- Test semantic labels render in correct language\n- Test RTL layouts for Arabic and Hebrew\n\n### Integration Testing\n\n**End-to-End Localization:**\n- Test switching between all 5 languages in example app\n- Test RTL languages (Arabic, Hebrew) flip layout correctly\n- Test time formatting uses correct locale (12h vs 24h)\n- Test all ARB keys present in all language files\n\n**Theme System:**\n- Test theme changes propagate to all views\n- Test nested theme properties override root properties\n- Test Material 3 defaults apply when no theme specified\n- Test theme lerp during theme transitions\n\n**Gesture Interactions:**\n- Test Month View double-tap creates event (if handler wired up)\n- Test Day View double-tap still works after changes\n- Test no gesture conflicts between single-tap, double-tap, long-press\n\n### End-to-End Testing\n\n**User Scenarios:**\n\n1. **Multilingual User:**\n   - User opens app → selects French → all UI in French\n   - User selects Arabic → layout flips to RTL, all UI in Arabic\n   - User selects Hebrew → layout flips to RTL, all UI in Hebrew\n\n2. **Theme Customization:**\n   - Developer creates custom theme with nested structure\n   - Month View uses monthTheme properties\n   - Day View uses dayTheme properties\n   - Shared properties work in both views\n\n3. **Gesture Consistency:**\n   - User single-taps event in Month View → detail dialog opens\n   - User double-taps date in Month View → create event dialog opens\n   - User long-presses event in Month View → context menu appears\n   - Same patterns work identically in Day View\n\n4. **Features Demo Exploration:**\n   - User opens Day View Features tab\n   - User adjusts hour height slider → view updates in real-time\n   - User toggles time legend ticks → ticks appear/disappear\n   - User toggles special regions → regions appear/disappear\n\n### Performance Testing\n\n- Measure render time for Day View with tick marks (should be < 16ms per frame)\n- Measure theme lerp performance with nested structures\n- Measure localization lookup performance (should be O(1) with generated code)\n- Measure Month View with 100+ events handling double-tap gestures\n",
  "fileStats": {
    "size": 22241,
    "lines": 634,
    "lastModified": "2026-02-15T23:38:30.515Z"
  },
  "comments": []
}