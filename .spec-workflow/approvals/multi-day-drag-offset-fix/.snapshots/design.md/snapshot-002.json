{
  "id": "snapshot_1770350544864_mx97ijtfv",
  "approvalId": "approval_1770350508928_u28v3uq1t",
  "approvalTitle": "Multi-Day Drag Offset Fix - Design",
  "version": 2,
  "timestamp": "2026-02-06T04:02:24.864Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: Multi-Day Drag Offset Fix\n\n## Overview\n\nThis design addresses a timing issue in Flutter's `LongPressDraggable` widget that causes multi-day event drag-and-drop to use stale grab offset values. The solution introduces a mutable holder pattern that allows the grab offset to be updated after the drag data has been captured, ensuring accurate drop position calculations.\n\nThe fix is localized to two files: `mcal_callback_details.dart` (data model) and `mcal_draggable_event_tile.dart` (drag handling).\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Flutter Best Practices**: The solution works within Flutter's widget lifecycle constraints rather than fighting against them\n- **Minimal API Surface Changes**: The fix uses internal implementation changes without modifying public APIs\n- **Pattern Consistency**: The holder pattern is a recognized approach for handling mutable state in immutable data structures\n\n### Project Structure (structure.md)\n- Changes are contained within the existing widget layer (`lib/src/widgets/`)\n- Data models remain in `mcal_callback_details.dart` following existing patterns\n- No new files required; modifications to existing architecture\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **MCalDraggableEventTile**: Existing draggable wrapper - will be modified to use holder pattern\n- **MCalDragData**: Existing drag data class - will be modified to use holder reference\n- **LongPressDraggable**: Flutter's built-in drag widget - understanding its behavior is key\n\n### Integration Points\n- **MCalBuilderWrapper**: Wraps event tiles with draggable; no changes needed\n- **_WeekRowWidgetState**: Drop target handling reads `grabOffsetX` from drag data; no changes needed (reads via getter)\n\n## Architecture\n\nThe core insight is that Flutter's `LongPressDraggable` captures its `data` parameter at widget build time. When `onPointerDown` fires (after build), updating state and triggering a rebuild doesn't guarantee the draggable will use the new data before the drag starts.\n\nThe solution uses a mutable holder object that the `MCalDragData` references. When `onPointerDown` fires, we update the holder directly. Since `MCalDragData` reads from the holder via a getter, it always returns the current value.\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant Listener\n    participant Holder as MCalGrabOffsetHolder\n    participant Draggable as LongPressDraggable\n    participant DragData as MCalDragData\n    participant DropTarget\n\n    Note over Draggable,DragData: Build time: MCalDragData created with holder reference\n    User->>Listener: Pointer Down\n    Listener->>Holder: Update grabOffsetX = 85.5\n    Note over Holder: Mutable value updated\n    User->>Draggable: Long press completes (200ms)\n    Draggable->>DropTarget: Drag starts with MCalDragData\n    DropTarget->>DragData: Read grabOffsetX\n    DragData->>Holder: Get grabOffsetX\n    Holder-->>DragData: Returns 85.5 (current value)\n    DragData-->>DropTarget: Returns 85.5\n```\n\n## Components and Interfaces\n\n### MCalGrabOffsetHolder\n- **Purpose:** Mutable container for grab offset value that can be updated after MCalDragData is created\n- **Interfaces:**\n  - `double grabOffsetX` - mutable property for the X offset from tile's left edge\n- **Dependencies:** None\n- **Location:** `lib/src/widgets/mcal_callback_details.dart`\n\n```dart\nclass MCalGrabOffsetHolder {\n  double grabOffsetX = 0.0;\n}\n```\n\n### MCalDragData (Modified)\n- **Purpose:** Data transferred during drag operations; now reads grab offset from holder\n- **Interfaces:**\n  - `MCalCalendarEvent event` - the event being dragged (unchanged)\n  - `DateTime sourceDate` - the segment start date (unchanged)\n  - `double get grabOffsetX` - getter that reads from holder (changed from final field)\n- **Dependencies:** MCalGrabOffsetHolder\n- **Changes:**\n  - Remove `final double grabOffsetX` field\n  - Add `final MCalGrabOffsetHolder _grabOffsetHolder` private field\n  - Add `double get grabOffsetX => _grabOffsetHolder.grabOffsetX` getter\n  - Constructor takes `grabOffsetHolder` parameter instead of `grabOffsetX`\n\n### _MCalDraggableEventTileState (Modified)\n- **Purpose:** Manages drag state for event tiles\n- **Changes:**\n  - Replace `double _grabOffsetX` with `final MCalGrabOffsetHolder _grabOffsetHolder`\n  - In `onPointerDown`: Update `_grabOffsetHolder.grabOffsetX` directly (no setState needed for this)\n  - In `LongPressDraggable.data`: Pass holder reference to MCalDragData\n\n## Data Models\n\n### MCalGrabOffsetHolder (New)\n```dart\nclass MCalGrabOffsetHolder {\n  /// The X offset in pixels from the tile's left edge where the user tapped.\n  double grabOffsetX = 0.0;\n}\n```\n\n### MCalDragData (Modified)\n```dart\nclass MCalDragData {\n  final MCalCalendarEvent event;\n  final DateTime sourceDate;\n  final MCalGrabOffsetHolder _grabOffsetHolder;\n  \n  double get grabOffsetX => _grabOffsetHolder.grabOffsetX;\n  \n  MCalDragData({\n    required this.event,\n    required this.sourceDate,\n    required MCalGrabOffsetHolder grabOffsetHolder,\n  }) : _grabOffsetHolder = grabOffsetHolder;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **Holder not initialized before drag**\n   - **Handling:** Holder initializes with `grabOffsetX = 0.0` by default\n   - **User Impact:** Event would land at leftmost position if touched before pointer down fires (edge case)\n\n2. **Multiple rapid drags on same tile**\n   - **Handling:** Each pointer down updates the same holder; each drag reads current value\n   - **User Impact:** Correct behavior - each drag uses its own grab position\n\n## Testing Strategy\n\n### Unit Testing\n- Verify `MCalGrabOffsetHolder` value can be updated and read correctly\n- Verify `MCalDragData.grabOffsetX` getter returns holder's current value\n- Verify updating holder after MCalDragData creation reflects in getter\n\n### Integration Testing\n- Test multi-day event drag with grab at left edge (grabOffsetX ≈ 0)\n- Test multi-day event drag with grab at center (grabOffsetX ≈ dayWidth * days/2)\n- Test multi-day event drag with grab at right edge (grabOffsetX ≈ dayWidth * days)\n- Test dragging same event twice with different grab positions\n- Verify all existing drag-and-drop tests continue to pass\n\n### End-to-End Testing\n- Drag a 5-day event by grabbing its center; verify it lands with correct alignment\n- Drag a multi-week event from one week to another; verify grab position is maintained\n- Drag events from different positions and verify drop targets highlight correctly\n",
  "fileStats": {
    "size": 6508,
    "lines": 150,
    "lastModified": "2026-02-06T04:01:58.487Z"
  },
  "comments": []
}