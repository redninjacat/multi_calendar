{
  "id": "snapshot_1771355564515_galeoghk9",
  "approvalId": "approval_1771355564497_brk69rrf1",
  "approvalTitle": "Design: Month/Day View API Alignment",
  "version": 1,
  "timestamp": "2026-02-17T19:12:44.515Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Month/Day View API Alignment\n\n## Overview\n\nThis design aligns the public APIs of `MCalDayView` and `MCalMonthView` by applying existing implementation patterns from each view to the other. The Month View already has patterns for builder-with-default, hover callbacks, swipe navigation, drag revert, cell interactivity, and resize handle insets — these patterns are applied to the Day View. The Day View already has keyboard CRUD via Shortcuts/Actions — this pattern is applied to the Month View. Naming, types, and signatures are standardized across both.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Widget-based Architecture**: All changes follow the existing controller + widget + builder pattern\n- **Builder Pattern**: Day View adopts the Month View's builder-with-default pattern (third `Widget` parameter)\n- **Delegation Pattern**: New callbacks (keyboard CRUD, swipe, interactivity) delegate to consuming apps\n- **Accessibility**: Keyboard CRUD in Month View improves keyboard-only accessibility\n- **Localization**: New semantic labels for hover targets and swipe use `MCalLocalizations.of(context)`\n\n### Project Structure (structure.md)\n- New context/details classes go in existing `mcal_callback_details.dart` and `mcal_day_view_contexts.dart`\n- New enums go in `mcal_day_view_contexts.dart` (TimeLabelPosition) or `mcal_month_week_layout_contexts.dart` (reuse DateLabelPosition)\n- New Intent classes go at the top of `mcal_month_view.dart` (following Day View's pattern in `mcal_day_view.dart`)\n- Theme additions go in `mcal_day_theme_data.dart`\n- Controller changes go in `mcal_event_controller.dart`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **Month View `dayCellBuilder` pattern**: The exact builder-with-default implementation (build default → pass to builder as third arg) is replicated in Day View for all builders\n- **Month View `onEventDropped` revert pattern**: The \"update first, revert if false\" pattern for non-recurring events and \"apply only if true\" for recurring events is replicated in Day View\n- **Month View `PageView.builder` swipe**: The same PageView approach with RTL reversal and direction configuration is replicated in Day View\n- **Month View `cellInteractivityCallback`**: The same check-before-tap and opacity pattern is replicated as `timeSlotInteractivityCallback` in Day View\n- **Month View `resizeHandleInset`**: The same `Positioned` inset logic is replicated in Day View resize handles\n- **Month View `MouseRegion` hover pattern**: The same onEnter/onExit with context creation is replicated for new Day View hover callbacks, updated to include `BuildContext`\n- **Day View `Shortcuts`/`Actions` pattern**: The exact Intent class + shortcut map + action map pattern is replicated in Month View for keyboard CRUD\n- **`MCalEventDroppedDetails` / `MCalEventResizedDetails`**: Reused directly — no changes needed to these classes\n- **`MCalCellInteractivityDetails`**: Used as reference for new `MCalTimeSlotInteractivityDetails`\n\n### Integration Points\n\n- **`MCalEventController`**: Gains `firstDayOfWeek` property; both views read from controller\n- **`mcal_callback_details.dart`**: New details classes added here\n- **`mcal_day_view_contexts.dart`**: New context class for time slot interactivity\n- **`mcal_day_theme_data.dart`**: New theme properties for hover colors and time label position\n- **`multi_calendar.dart`**: New exports for Intent classes and enums\n\n## Architecture\n\nThe changes follow a \"pattern transfer\" approach — mature patterns from one view are applied to the other with minimal adaptation.\n\n```mermaid\ngraph TD\n    subgraph \"Pattern Transfer\"\n        MV_BD[Month View<br/>Builder-with-Default] --> DV_BD[Day View<br/>Builder-with-Default]\n        MV_DR[Month View<br/>Drag Revert bool] --> DV_DR[Day View<br/>Drag Revert bool]\n        MV_SW[Month View<br/>PageView Swipe] --> DV_SW[Day View<br/>PageView Swipe]\n        MV_CI[Month View<br/>cellInteractivityCallback] --> DV_CI[Day View<br/>timeSlotInteractivityCallback]\n        MV_RI[Month View<br/>resizeHandleInset] --> DV_RI[Day View<br/>resizeHandleInset]\n        MV_HV[Month View<br/>MouseRegion Hover] --> DV_HV[Day View<br/>New Hover Callbacks]\n        DV_KB[Day View<br/>Shortcuts/Actions CRUD] --> MV_KB[Month View<br/>Shortcuts/Actions CRUD]\n    end\n\n    subgraph \"Standardization\"\n        NAMES[Rename Parameters]\n        TYPES[Align Types]\n        SIGS[Align Signatures]\n    end\n\n    subgraph \"New Features\"\n        TLP[TimeLabelPosition Enum]\n        SUB[Sub-Hour Labels]\n        HVTHEME[Hover Theme Colors]\n        FDOW[Controller firstDayOfWeek]\n    end\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each context/details class serves one callback type\n- **Component Isolation**: Changes to Day View don't require changes to Month View's internal implementation (except shared types)\n- **Utility Modularity**: Shared enums and details classes are in shared files (`mcal_callback_details.dart`)\n\n## Components and Interfaces\n\n### Component 1: Month View Keyboard CRUD (REQ-1)\n\n- **Purpose**: Add keyboard-based event CRUD to Month View matching Day View's pattern\n- **Files Modified**: `lib/src/widgets/mcal_month_view.dart`, `lib/multi_calendar.dart`\n- **Reuses**: Day View's Intent/Shortcuts/Actions architecture\n\n**New Intent Classes** (top of `mcal_month_view.dart`):\n```dart\nclass MCalMonthViewCreateEventIntent extends Intent {\n  const MCalMonthViewCreateEventIntent();\n}\nclass MCalMonthViewDeleteEventIntent extends Intent {\n  const MCalMonthViewDeleteEventIntent();\n}\nclass MCalMonthViewEditEventIntent extends Intent {\n  const MCalMonthViewEditEventIntent();\n}\n```\n\n**New Widget Parameters**:\n```dart\n// On MCalMonthView constructor:\nfinal Map<ShortcutActivator, Intent>? keyboardShortcuts;\nfinal VoidCallback? onCreateEventRequested;\nfinal void Function(MCalCalendarEvent event)? onDeleteEventRequested;\nfinal void Function(MCalCalendarEvent event)? onEditEventRequested;\n```\n\n**Implementation Pattern** (matching Day View lines 3807-3810):\n```dart\n// In _MCalMonthViewState.build():\nfinal shortcutsContent = Shortcuts(\n  shortcuts: _buildShortcutsMap(),\n  child: Actions(actions: _buildActionsMap(), child: focusContent),\n);\n\nMap<ShortcutActivator, Intent> _buildShortcutsMap() {\n  final defaults = <ShortcutActivator, Intent>{\n    const SingleActivator(LogicalKeyboardKey.keyN, meta: true):\n        const MCalMonthViewCreateEventIntent(),\n    const SingleActivator(LogicalKeyboardKey.keyN, control: true):\n        const MCalMonthViewCreateEventIntent(),\n    const SingleActivator(LogicalKeyboardKey.keyD, meta: true):\n        const MCalMonthViewDeleteEventIntent(),\n    const SingleActivator(LogicalKeyboardKey.keyD, control: true):\n        const MCalMonthViewDeleteEventIntent(),\n    const SingleActivator(LogicalKeyboardKey.delete):\n        const MCalMonthViewDeleteEventIntent(),\n    const SingleActivator(LogicalKeyboardKey.backspace):\n        const MCalMonthViewDeleteEventIntent(),\n    const SingleActivator(LogicalKeyboardKey.keyE, meta: true):\n        const MCalMonthViewEditEventIntent(),\n    const SingleActivator(LogicalKeyboardKey.keyE, control: true):\n        const MCalMonthViewEditEventIntent(),\n  };\n  if (widget.keyboardShortcuts != null) {\n    defaults.addAll(widget.keyboardShortcuts!);\n  }\n  return defaults;\n}\n\nMap<Type, Action<Intent>> _buildActionsMap() {\n  return {\n    MCalMonthViewCreateEventIntent: CallbackAction<MCalMonthViewCreateEventIntent>(\n      onInvoke: (_) { widget.onCreateEventRequested?.call(); return null; },\n    ),\n    MCalMonthViewDeleteEventIntent: CallbackAction<MCalMonthViewDeleteEventIntent>(\n      onInvoke: (_) {\n        final event = _focusedEvent; // existing Month View concept\n        if (event != null) widget.onDeleteEventRequested?.call(event);\n        return null;\n      },\n    ),\n    MCalMonthViewEditEventIntent: CallbackAction<MCalMonthViewEditEventIntent>(\n      onInvoke: (_) {\n        final event = _focusedEvent;\n        if (event != null) widget.onEditEventRequested?.call(event);\n        return null;\n      },\n    ),\n  };\n}\n```\n\n**`_focusedEvent` access**: Month View already has `_keyboardSelectedEventIndex` and event selection mode. The focused event is derived from the events list for the focused cell at the selected index.\n\n### Component 2: Drag/Resize Callback Alignment (REQ-2, REQ-9)\n\n- **Purpose**: Change Day View `onEventDropped`/`onEventResized` to return `bool`; add `resizeHandleInset`\n- **Files Modified**: `lib/src/widgets/mcal_day_view.dart`\n- **Reuses**: Month View's revert pattern (lines 2446-2471, 4382-4401)\n\n**Changed Signatures**:\n```dart\n// Before:\nfinal void Function(MCalEventDroppedDetails details)? onEventDropped;\nfinal void Function(MCalEventResizedDetails details)? onEventResized;\n\n// After (matching Month View):\nfinal bool Function(BuildContext, MCalEventDroppedDetails)? onEventDropped;\nfinal bool Function(BuildContext, MCalEventResizedDetails)? onEventResized;\n```\n\n**Revert Implementation** (applied to Day View's existing drop handler ~line 2928):\n```dart\n// Non-recurring: update first, revert if false\nwidget.controller.addEvents([updatedEvent]);\nif (widget.onEventDropped != null) {\n  final shouldKeep = widget.onEventDropped!(context, dropDetails);\n  if (!shouldKeep) {\n    final reverted = event.copyWith(start: oldStart, end: oldEnd);\n    widget.controller.addEvents([reverted]);\n  }\n}\n\n// Recurring: only apply exception if true\nif (widget.onEventDropped != null) {\n  final shouldKeep = widget.onEventDropped!(context, dropDetails);\n  if (shouldKeep) {\n    widget.controller.addException(seriesId, exception);\n  }\n} else {\n  widget.controller.addException(seriesId, exception);\n}\n```\n\n**New Parameter for Resize Handle Inset**:\n```dart\nfinal double Function(MCalTimedEventTileContext, MCalResizeEdge)? resizeHandleInset;\n```\n\nApplied in `_ResizeHandle` positioning using the same `Positioned` pattern as Month View (lines 7259-7265).\n\n### Component 3: Complete Handler Coverage (REQ-3, REQ-4, REQ-5)\n\n- **Purpose**: Add missing tap/long-press/double-tap/hover handlers to both views; add `BuildContext` to all hover callbacks\n- **Files Modified**: `lib/src/widgets/mcal_day_view.dart`, `lib/src/widgets/mcal_month_view.dart`\n\n**New Day View Parameters**:\n```dart\n// Double-tap handlers (new):\nfinal void Function(BuildContext, MCalDayHeaderContext)? onDayHeaderDoubleTap;\nfinal void Function(BuildContext, MCalTimeLabelContext)? onTimeLabelLongPress;\nfinal void Function(BuildContext, MCalTimeLabelContext)? onTimeLabelDoubleTap;\nfinal void Function(BuildContext, DateTime)? onTimeSlotDoubleTap;\nfinal void Function(BuildContext, MCalEventTapDetails)? onEventDoubleTap;\nfinal void Function(BuildContext, MCalOverflowTapDetails)? onOverflowDoubleTap;\n\n// Hover handlers (new, all with BuildContext):\nfinal void Function(BuildContext, MCalDayHeaderContext?)? onHoverDayHeader;\nfinal void Function(BuildContext, MCalTimeLabelContext?)? onHoverTimeLabel;\nfinal void Function(BuildContext, MCalOverflowTapDetails?)? onHoverOverflow;\nfinal void Function(BuildContext, MCalTimeSlotContext?)? onHoverEmptySpace;\n\n// Existing hover handlers (signature change — add BuildContext):\nfinal void Function(BuildContext, MCalCalendarEvent?)? onHoverEvent;       // was: void Function(MCalCalendarEvent)?\nfinal void Function(BuildContext, MCalTimeSlotContext?)? onHoverTimeSlot;   // was: void Function(MCalTimeSlotContext)?\n```\n\n**New Month View Parameters**:\n```dart\n// Double-tap handlers (new):\nfinal void Function(BuildContext, MCalDateLabelTapDetails)? onDateLabelDoubleTap;\nfinal void Function(BuildContext, MCalOverflowTapDetails)? onOverflowDoubleTap;\n\n// Hover handlers (new, with BuildContext):\nfinal void Function(BuildContext, MCalDateLabelContext?)? onHoverDateLabel;\nfinal void Function(BuildContext, MCalOverflowTapDetails?)? onHoverOverflow;\n\n// Existing hover handlers (signature change — add BuildContext):\nfinal void Function(BuildContext, MCalDayCellContext?)? onHoverCell;        // was: ValueChanged<MCalDayCellContext?>?\nfinal void Function(BuildContext, MCalEventTileContext?)? onHoverEvent;     // was: ValueChanged<MCalEventTileContext?>?\n```\n\n**Hover Implementation Pattern** (updated from Month View ~line 6373):\n```dart\n// Before (Month View current):\nif (widget.onHoverCell != null) {\n  result = MouseRegion(\n    onEnter: (_) { widget.onHoverCell!(contextObj); },\n    onExit: (_) => widget.onHoverCell!(null),\n    child: result,\n  );\n}\n\n// After (add BuildContext — context is available from build method):\nif (widget.onHoverCell != null) {\n  result = MouseRegion(\n    onEnter: (_) { widget.onHoverCell!(context, contextObj); },\n    onExit: (_) => widget.onHoverCell!(context, null),\n    child: result,\n  );\n}\n```\n\n**Double-Tap Implementation Pattern** (added alongside existing tap/long-press GestureDetector):\n```dart\n// For Day View day header — add to existing _DayHeader widget:\nGestureDetector(\n  onTap: () => widget.onDayHeaderTap?.call(context, headerContext),\n  onLongPress: () => widget.onDayHeaderLongPress?.call(context, headerContext),\n  onDoubleTap: () => widget.onDayHeaderDoubleTap?.call(context, headerContext),\n  child: /* existing header content */,\n);\n```\n\n**Note on `onTimeSlotDoubleTap` vs `onEmptySpaceDoubleTap`**: `onEmptySpaceDoubleTap` is renamed to `onTimeSlotDoubleTap` for consistency with `onTimeSlotTap`/`onTimeSlotLongPress`. The existing behavior (fires on empty time slot area, not on event tiles) is preserved.\n\n### Component 4: Day View Swipe Navigation (REQ-6)\n\n- **Purpose**: Add PageView-based swipe navigation to Day View matching Month View's pattern\n- **Files Modified**: `lib/src/widgets/mcal_day_view.dart`\n- **Reuses**: Month View's PageView.builder implementation (lines 1475-1495)\n\n**New Parameters**:\n```dart\nfinal bool enableSwipeNavigation; // default: false\nfinal MCalSwipeNavigationDirection? swipeNavigationDirection; // reuse existing enum\nfinal void Function(BuildContext, MCalSwipeNavigationDetails)? onSwipeNavigation;\n```\n\n**Implementation**: When `enableSwipeNavigation` is true, the Day View wraps its content in a `PageView.builder` (matching Month View lines 1475-1495):\n```dart\nif (widget.enableSwipeNavigation) {\n  body = PageView.builder(\n    controller: _swipePageController,\n    physics: const ClampingScrollPhysics(),\n    onPageChanged: _onSwipePageChanged,\n    scrollDirection: widget.swipeNavigationDirection == MCalSwipeNavigationDirection.vertical\n        ? Axis.vertical : Axis.horizontal,\n    reverse: isRTL && widget.swipeNavigationDirection == MCalSwipeNavigationDirection.horizontal,\n    itemBuilder: (context, pageIndex) {\n      final dayDate = _pageIndexToDay(pageIndex);\n      return _buildDayContent(context, dayDate, hourHeight);\n    },\n  );\n}\n```\n\nA page controller maps page indices to dates. When the page changes, `onDisplayDateChanged` fires (via `controller.setDisplayDate`), and `onSwipeNavigation` fires with direction details.\n\n**Interaction with vertical scroll**: The Day View's existing vertical scroll (for hours) uses `SingleChildScrollView`. When swipe is horizontal, they don't conflict. When swipe is vertical, the swipe `PageView` is configured as `Axis.vertical` and must coexist with the hours scroll — this requires wrapping the hours scroll in the PageView page, so vertical swipe detects at the page level while internal scroll handles time navigation. The implementation uses a `NotificationListener<ScrollNotification>` to prevent swipe interference when the user is scrolling the time grid.\n\n### Component 5: Day View Interactivity & Builders (REQ-7, REQ-8)\n\n- **Purpose**: Add `timeSlotInteractivityCallback` and builder-with-default pattern\n- **Files Modified**: `lib/src/widgets/mcal_day_view.dart`, `lib/src/widgets/mcal_day_view_contexts.dart`, `lib/src/widgets/mcal_callback_details.dart`\n\n**New Details Class** (in `mcal_callback_details.dart`):\n```dart\nclass MCalTimeSlotInteractivityDetails {\n  final DateTime date;\n  final int hour;\n  final int minute;\n  final DateTime startTime;\n  final DateTime endTime;\n\n  const MCalTimeSlotInteractivityDetails({\n    required this.date,\n    required this.hour,\n    required this.minute,\n    required this.startTime,\n    required this.endTime,\n  });\n}\n```\n\n**New Parameter**:\n```dart\nfinal bool Function(BuildContext, MCalTimeSlotInteractivityDetails)? timeSlotInteractivityCallback;\n```\n\n**Interactivity Check** (matching Month View ~line 6191):\n```dart\nfinal isInteractive = widget.timeSlotInteractivityCallback != null\n    ? widget.timeSlotInteractivityCallback!(context, MCalTimeSlotInteractivityDetails(\n        date: _displayDate,\n        hour: hour,\n        minute: minute,\n        startTime: slotStart,\n        endTime: slotEnd,\n      ))\n    : true;\n```\n\nNon-interactive time slots: tap/long-press/double-tap handlers do not fire; drag-and-drop rejects drops (via `onDragWillAccept`); visual opacity reduced to 0.5.\n\n**Builder-with-Default Refactor**: All Day View builders change signature to include the default widget. Example for `timedEventTileBuilder`:\n\n```dart\n// Before (current Day View):\nfinal Widget Function(BuildContext, MCalCalendarEvent, MCalTimedEventTileContext)? timedEventTileBuilder;\n\n// After (matching Month View pattern):\nfinal Widget Function(BuildContext, MCalCalendarEvent, MCalTimedEventTileContext, Widget defaultWidget)? timedEventTileBuilder;\n```\n\n**Implementation change** (refactoring Day View ~lines 5767-5828):\n```dart\n// Build the default tile first (always)\nfinal defaultTile = _buildDefaultTimedEventTile(context, event, tileContext);\n\n// Use builder if provided, otherwise use default\nfinal tile = timedEventTileBuilder != null\n    ? timedEventTileBuilder!(context, event, tileContext, defaultTile)\n    : defaultTile;\n```\n\nThis is extracted from the current inline default tile construction into a private `_buildDefaultTimedEventTile` method. The same pattern applies to all builders:\n\n| Builder | Default Method |\n|---------|---------------|\n| `dayHeaderBuilder` | `_buildDefaultDayHeader()` |\n| `timeLabelBuilder` | `_buildDefaultTimeLabel()` |\n| `gridlineBuilder` | `_buildDefaultGridline()` |\n| `allDayEventTileBuilder` | `_buildDefaultAllDayEventTile()` |\n| `timedEventTileBuilder` | `_buildDefaultTimedEventTile()` |\n| `currentTimeIndicatorBuilder` | `_buildDefaultCurrentTimeIndicator()` |\n| `navigatorBuilder` | `_buildDefaultNavigator()` |\n| `timeRegionBuilder` | `_buildDefaultTimeRegion()` |\n| `draggedTileBuilder` | `_buildDefaultDraggedTile()` |\n| `dragSourceTileBuilder` | `_buildDefaultDragSourceTile()` |\n| `dropTargetTileBuilder` | `_buildDefaultDropTargetTile()` |\n| `dropTargetOverlayBuilder` | `_buildDefaultDropTargetOverlay()` |\n| `timeResizeHandleBuilder` | `_buildDefaultResizeHandle()` |\n| `loadingBuilder` | `_buildDefaultLoading()` |\n| `errorBuilder` | `_buildDefaultError()` |\n\n### Component 6: API Naming & Navigation Cleanup (REQ-10, REQ-11, REQ-12, REQ-13)\n\n- **Purpose**: Rename parameters, remove per-button nav callbacks, move `firstDayOfWeek` to controller\n- **Files Modified**: `lib/src/widgets/mcal_day_view.dart`, `lib/src/widgets/mcal_month_view.dart`, `lib/src/controllers/mcal_event_controller.dart`, `lib/multi_calendar.dart`\n\n**Parameter Renames in Day View**:\n| Old Name | New Name |\n|----------|----------|\n| `showWeekNumber` | `showWeekNumbers` |\n| `showDropTargetPreview` | `showDropTargetTiles` |\n| `onEmptySpaceDoubleTap` | `onTimeSlotDoubleTap` (Component 3) |\n\n**Type Change in Month View**:\n```dart\n// Before:\nfinal String? dateFormat;\n\n// After:\nfinal DateFormat? dateFormat;  // import 'package:intl/intl.dart';\n```\n\nThe existing usage sites that format with `dateFormat` must be updated from `DateFormat(widget.dateFormat)` to directly using `widget.dateFormat`.\n\n**Removed Parameters from Day View**:\n```dart\n// REMOVED:\nfinal VoidCallback? onNavigatePrevious;\nfinal VoidCallback? onNavigateNext;\nfinal VoidCallback? onNavigateToday;\n```\n\n**Navigation Refactor**: `_handleNavigatePrevious`, `_handleNavigateNext`, `_handleNavigateToday` become simple methods that always auto-navigate (no callback check):\n```dart\nvoid _handleNavigatePrevious() {\n  final previousDay = DateTime(_displayDate.year, _displayDate.month, _displayDate.day - 1);\n  widget.controller.setDisplayDate(previousDay);\n  // onDisplayDateChanged fires via _onControllerChanged\n}\n```\n\nDrag edge navigation (lines 2631-2646) continues to call these methods — behavior unchanged.\n\n**New Week Number Builder** for Day View:\n```dart\nfinal Widget Function(BuildContext, MCalWeekNumberContext, Widget)? weekNumberBuilder;\n```\n\nUses the existing `MCalWeekNumberContext` from `mcal_month_view_contexts.dart` (reuse). The default widget is the existing week number badge. When builder is provided and `showWeekNumbers` is true, the builder result replaces the default.\n\n**Controller firstDayOfWeek**:\n```dart\n// In MCalEventController:\nMCalEventController({DateTime? initialDate, this.firstDayOfWeek});\n\nfinal int? firstDayOfWeek; // 0=Sunday..6=Saturday, null=system default\n\n// Add getter for resolved value:\nint get resolvedFirstDayOfWeek => firstDayOfWeek ?? DateTime.monday; // platform default\n```\n\nMonth View removes `firstDayOfWeek` from its constructor and reads `widget.controller.firstDayOfWeek` (or `widget.controller.resolvedFirstDayOfWeek`) wherever it currently uses `widget.firstDayOfWeek`.\n\nDay View reads from the controller for week number calculations.\n\nNote: This is separate from `MCalRecurrenceRule.weekStart` which is per-rule for RRULE expansion. The controller's `firstDayOfWeek` controls visual layout (which day starts the week in grid/header), while `weekStart` in recurrence rules controls RRULE expansion per RFC 5545.\n\n### Component 7: Day View Theme & Time Labels (REQ-14, REQ-15, REQ-16)\n\n- **Purpose**: Add time label positioning, sub-hour labels, and hover theme colors\n- **Files Modified**: `lib/src/styles/mcal_day_theme_data.dart`, `lib/src/widgets/mcal_day_view.dart`, `lib/src/widgets/mcal_day_view_contexts.dart`\n\n**New Enum** (in `mcal_day_view_contexts.dart`):\n```dart\n/// Position of time labels relative to the hour gridline.\n///\n/// \"Leading\" = left in LTR, right in RTL (automatically handled by Flutter).\n/// \"Trailing\" = right in LTR, left in RTL.\n/// \"Top\" = the gridline at the start of the hour.\n/// \"Bottom\" = the gridline at the end of the hour.\nenum MCalTimeLabelPosition {\n  /// Leading-aligned, bottom of label aligns with top gridline.\n  topLeadingAbove,\n  /// Leading-aligned, vertically centered with top gridline.\n  topLeadingCentered,\n  /// Leading-aligned, top of label aligns with top gridline.\n  topLeadingBelow,\n  /// Trailing-aligned, bottom of label aligns with top gridline.\n  topTrailingAbove,\n  /// Trailing-aligned, vertically centered with top gridline.\n  topTrailingCentered,\n  /// Trailing-aligned, top of label aligns with top gridline.\n  topTrailingBelow,\n  /// Leading-aligned, bottom of label aligns with bottom gridline.\n  bottomLeadingAbove,\n  /// Trailing-aligned, bottom of label aligns with bottom gridline.\n  bottomTrailingAbove,\n}\n```\n\n**New Theme Properties** (in `MCalDayThemeData`):\n```dart\nfinal MCalTimeLabelPosition? timeLabelPosition;          // default: topTrailingBelow\nfinal Color? hoverTimeSlotBackgroundColor;\nfinal Color? hoverEventBackgroundColor;\n```\n\n**Time Label Positioning Implementation**: The time legend currently uses `Positioned` widgets for each label. The position enum controls:\n- **Horizontal alignment**: `CrossAxisAlignment.start` (leading) or `CrossAxisAlignment.end` (trailing) — Flutter automatically handles RTL via `Directionality`\n- **Vertical alignment relative to gridline**:\n  - `Above`: `bottom` of label box = gridline Y position → `top: gridlineY - labelHeight`\n  - `Centered`: center of label = gridline Y → `top: gridlineY - labelHeight / 2`\n  - `Below`: `top` of label = gridline Y → `top: gridlineY`\n- **Reference gridline**: `top*` uses the hour's start gridline, `bottom*` uses the hour's end gridline (= next hour's start)\n\n**Sub-Hour Time Labels** — new widget parameters:\n```dart\nfinal bool showSubHourLabels;           // default: false\nfinal Duration? subHourLabelInterval;   // e.g., Duration(minutes: 15)\nfinal Widget Function(BuildContext, MCalTimeLabelContext, Widget)? subHourLabelBuilder;\n```\n\nWhen `showSubHourLabels` is true and `subHourLabelInterval` is set, the time legend generates additional labels between hour marks. Sub-hour labels reuse `MCalTimeLabelContext` (the `minute` field distinguishes them from hour labels). The default sub-hour label uses a smaller, lighter text style. The builder receives the default widget. Sub-hour labels follow the same `timeLabelPosition` as hour labels.\n\n**Hover Color Implementation**: When hover colors are set in the theme, `MouseRegion` wrappers apply background color changes on enter/exit via local state. The `_TimeSlotWidget` checks `theme.hoverTimeSlotBackgroundColor` and wraps in `MouseRegion` only when non-null (no performance impact when unused). Same pattern for event tiles with `hoverEventBackgroundColor`.\n\n### Component 8: Example App Updates (REQ-17)\n\n- **Purpose**: Update example app to showcase all new features\n- **Files Modified**: Multiple files in `example/lib/`\n\n**Day View Features Tab** (`example/lib/views/day_view/tabs/day_features_tab.dart`):\n- Add controls: `enableSwipeNavigation` toggle, `swipeNavigationDirection` dropdown, `showSubHourLabels` toggle, `subHourLabelInterval` dropdown, `timeSlotInteractivityCallback` toggle + time range config\n- Wire all new handlers: `onEventDoubleTap`, `onDayHeaderDoubleTap`, `onTimeLabelLongPress`, `onTimeLabelDoubleTap`, `onTimeSlotDoubleTap`, `onOverflowDoubleTap`, `onHoverDayHeader`, `onHoverTimeLabel`, `onHoverOverflow`, `onHoverEmptySpace`\n- Remove `onNavigatePrevious`, `onNavigateNext`, `onNavigateToday` usage\n- Rename `showWeekNumber` → `showWeekNumbers`, `showDropTargetPreview` → `showDropTargetTiles`\n- Update `onEventDropped`/`onEventResized` to return `bool`\n- Rename `onEmptySpaceDoubleTap` → `onTimeSlotDoubleTap`\n\n**Day View Theme Tab** (`example/lib/views/day_view/tabs/day_theme_tab.dart`):\n- Add `timeLabelPosition` dropdown (8 options)\n- Add `hoverTimeSlotBackgroundColor` color picker\n- Add `hoverEventBackgroundColor` color picker\n\n**Month View Features Tab** (`example/lib/views/month_view/tabs/month_features_tab.dart`):\n- Wire new handlers: `onDateLabelDoubleTap`, `onOverflowDoubleTap`, `onHoverDateLabel`, `onHoverOverflow`\n- Update hover callbacks to use new `BuildContext` signature\n- Remove `firstDayOfWeek` from widget (now on controller)\n\n**Month View Accessibility Tab** (`example/lib/views/month_view/tabs/month_accessibility_tab.dart`):\n- Add keyboard CRUD showcase: `onCreateEventRequested`, `onDeleteEventRequested`, `onEditEventRequested`\n- Update keyboard shortcuts documentation to include CRUD shortcuts\n\n**All Style Widgets**: Update `onEventDropped`/`onEventResized` signatures in Day View styles to return `bool`.\n\n**Main Screen / Controller Setup**: Set `firstDayOfWeek` on controller creation instead of on individual views.\n\n**Localization**: Add ARB keys for new SnackBar messages (double-tap handlers, hover handlers, time slot interactivity). Add to all 5 language files.\n\n## Data Models\n\n### New Details/Context Classes\n\n```dart\n// In mcal_callback_details.dart:\nclass MCalTimeSlotInteractivityDetails {\n  final DateTime date;\n  final int hour;\n  final int minute;\n  final DateTime startTime;\n  final DateTime endTime;\n}\n```\n\n### Modified Classes\n\n```dart\n// MCalEventController — add firstDayOfWeek:\nclass MCalEventController extends ChangeNotifier {\n  MCalEventController({DateTime? initialDate, this.firstDayOfWeek});\n  final int? firstDayOfWeek;\n  int get resolvedFirstDayOfWeek => firstDayOfWeek ?? DateTime.monday;\n}\n```\n\n### New Enums\n\n```dart\n// In mcal_day_view_contexts.dart:\nenum MCalTimeLabelPosition {\n  topLeadingAbove, topLeadingCentered, topLeadingBelow,\n  topTrailingAbove, topTrailingCentered, topTrailingBelow,\n  bottomLeadingAbove, bottomTrailingAbove,\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **`MCalLocalizations.of(context)` returns null in new hover/CRUD callbacks**\n   - **Handling**: All new localized strings in announcements use `MCalLocalizations.of(context)` which is already validated by existing code\n   - **User Impact**: None — existing error handling applies\n\n2. **`timeSlotInteractivityCallback` returns false during active drag**\n   - **Handling**: Matching Month View's approach — `onDragWillAccept` is the mechanism for rejecting drops, `timeSlotInteractivityCallback` controls tap/long-press only. This is documented in the parameter's dartdoc.\n   - **User Impact**: Developers use `onDragWillAccept` for drag validation, `timeSlotInteractivityCallback` for tap interactivity\n\n3. **Swipe navigation conflicts with vertical scroll**\n   - **Handling**: When `swipeNavigationDirection` is horizontal, no conflict. When vertical, the PageView handles outer scroll while `SingleChildScrollView` handles inner time-grid scroll. `NotificationListener` prevents interference.\n   - **User Impact**: Smooth swipe and scroll in both directions\n\n4. **`onEventDropped` returns false after controller update (revert)**\n   - **Handling**: Follows Month View's proven pattern — controller is updated first, then reverted if callback returns false. This ensures UI consistency.\n   - **User Impact**: Event visually snaps back to original position\n\n## Testing Strategy\n\n### Unit Testing\n- `MCalTimeLabelPosition` enum values cover all 8 positions\n- `MCalTimeSlotInteractivityDetails` construction and field access\n- Controller `firstDayOfWeek` getter returns correct resolved value\n\n### Widget Testing\n- **Keyboard CRUD** (Month View): Create test widget with `MCalMonthView`, enable keyboard nav, focus a cell with events, simulate Cmd+N/D/E, verify callbacks fire\n- **Drag Revert** (Day View): Simulate drag-and-drop, return `false` from `onEventDropped`, verify event reverts to original position\n- **Builder-with-Default**: Provide a builder that wraps default with `Container(color: Colors.red, child: defaultWidget)`, verify the default content is visible inside the red container\n- **Hover + BuildContext**: Mount `MCalDayView` with `onHoverEvent`, simulate hover via `TestGesture`, verify callback receives non-null `BuildContext`\n- **Swipe Navigation**: Mount `MCalDayView` with swipe enabled, simulate horizontal drag, verify `onDisplayDateChanged` fires with adjacent day\n- **RTL Swipe**: Mount in `Directionality(textDirection: TextDirection.rtl)`, verify swipe directions reverse\n- **Time Slot Interactivity**: Set callback to return `false` for hours 0-8, simulate tap at 7:00, verify no `onTimeSlotTap` fires\n- **Time Label Position**: Mount with each of 8 positions, use `tester.getTopLeft()` to verify label alignment relative to gridline\n- **Parameter Renames**: Verify `showWeekNumbers`, `showDropTargetTiles` work and old names don't compile\n- **Month View dateFormat**: Pass `DateFormat('MMMM yyyy')`, verify it renders correctly\n- **firstDayOfWeek on Controller**: Create controller with `firstDayOfWeek: DateTime.sunday`, mount Month View, verify Sunday is first column\n\n### Integration Testing\n- Full keyboard CRUD flow in Month View: navigate to cell → select event → edit → delete → create\n- Full swipe navigation flow in Day View: swipe through multiple days, verify date changes and events update\n- Cross-view consistency: Mount both views with same controller, verify `firstDayOfWeek` applies to both\n",
  "fileStats": {
    "size": 31617,
    "lines": 650,
    "lastModified": "2026-02-17T19:12:38.600Z"
  },
  "comments": []
}