{
  "id": "snapshot_1770155513327_ut6kvrc5l",
  "approvalId": "approval_1770155513317_ah25td2vq",
  "approvalTitle": "Month View Layered Architecture - Requirements",
  "version": 1,
  "timestamp": "2026-02-03T21:51:53.327Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThis specification defines a new layered architecture for MCalMonthView that fundamentally restructures how calendar grids, events, date labels, and drag-and-drop interactions are rendered. The current implementation has flaws in how multi-day events are rendered versus single-day events, leading to inconsistent layouts and limited customization options. The new architecture uses a 3-layer Stack approach where each layer has a distinct responsibility, enabling more flexible and consistent event layouts while preserving extensive customization capabilities.\n\n## Alignment with Product Vision\n\nThis feature directly supports the following product principles from product.md:\n\n- **Customization First**: The layered architecture exposes builder callbacks at multiple levels (day cell, week layout, event tile, date label), allowing developers to customize appearance without forking the package\n- **Separation of Concerns**: Each layer has a single responsibility (grid, events, drag feedback), making the code more modular and maintainable\n- **Flexibility**: The week layout builder pattern allows developers to implement completely custom event layouts (pile, dots, agenda style) while the package provides a sensible default\n- **Mobile-First**: The architecture is designed for efficient rendering on mobile devices while scaling to larger screens\n\n## Requirements\n\n### Requirement 1: Three-Layer Stack Architecture\n\n**User Story:** As a Flutter developer, I want the Month View to use a layered Stack architecture, so that calendar grids, events, and drag interactions are rendered independently and can be customized separately.\n\n#### Acceptance Criteria\n\n1. WHEN MCalMonthView renders THEN it SHALL use a Stack widget with three layers:\n   - Layer 1 (bottom): Calendar grid with day cells\n   - Layer 2 (middle): Event tiles and date labels\n   - Layer 3 (top): Drop target layer for drag-and-drop ghost tiles\n2. WHEN Layer 3 has no active drag operation THEN the system SHALL NOT render Layer 3 content\n3. WHEN the calendar renders THEN Layer 1 and Layer 2 SHALL have matching dimensions for each week row\n4. IF a developer provides a custom dayCellBuilder THEN Layer 1 SHALL use that builder to render cell backgrounds and borders\n\n### Requirement 2: Layer 1 - Calendar Grid\n\n**User Story:** As a Flutter developer, I want Layer 1 to render only the calendar grid structure, so that I can customize cell backgrounds, borders, and visual styling independently of events.\n\n#### Acceptance Criteria\n\n1. WHEN Layer 1 renders THEN it SHALL display a grid with the configured number of week rows and 7 day columns\n2. IF dayCellBuilder is provided THEN each cell in Layer 1 SHALL be rendered using that builder\n3. WHEN no dayCellBuilder is provided THEN the system SHALL use a default cell renderer with configurable border width and color\n4. WHEN a drag operation is active THEN Layer 1 cells MAY display visual highlighting to indicate valid/invalid drop targets\n5. IF showWeekNumbers is true THEN week numbers SHALL render outside the layer system (not in Layer 1) using the same height calculations for proper vertical alignment\n6. WHEN the locale is RTL THEN week numbers SHALL render on the right side; otherwise on the left side\n\n### Requirement 3: Layer 2 - Events and Date Labels\n\n**User Story:** As a Flutter developer, I want Layer 2 to handle all event tile and date label rendering through a week layout builder, so that I have complete control over event positioning and layout algorithms.\n\n#### Acceptance Criteria\n\n1. WHEN Layer 2 renders THEN it SHALL consist of one row per visible week\n2. WHEN a week row renders THEN it SHALL use the weekLayoutBuilder callback (if provided) or the default layout implementation\n3. WHEN the weekLayoutBuilder is called THEN it SHALL receive:\n   - All events (segments) for that week row\n   - Column widths for each day\n   - Day dates for the week\n   - The eventTileBuilder callback\n   - The dateLabelBuilder callback\n   - Layout constraints (available height, width)\n   - Configuration values (tile spacing, corner radius, etc.)\n4. IF no weekLayoutBuilder is provided THEN the system SHALL use a default layout that matches the POC implementation (greedy first-fit, multi-week event continuity, \"+N more\" overflow indicators)\n5. WHEN an event spans multiple weeks THEN the weekLayoutBuilder SHALL receive segment information including isFirstSegment and isLastSegment flags\n6. WHEN the default layout renders multi-week event segments THEN continuation edges (non-first, non-last) SHALL have no rounded corners, no border, and zero horizontal spacing\n\n### Requirement 4: Unified Event Tile Builder\n\n**User Story:** As a Flutter developer, I want a single eventTileBuilder that handles both single-day and multi-day events, so that I have a consistent API for customizing event appearance.\n\n#### Acceptance Criteria\n\n1. WHEN eventTileBuilder is called THEN it SHALL receive an event tile context containing:\n   - The event data (MCalCalendarEvent)\n   - Segment information (start day in week, end day in week, span days)\n   - Position flags (isFirstSegment, isLastSegment)\n   - Visual dimensions (width, height)\n2. WHEN no eventTileBuilder is provided THEN the system SHALL use a default tile renderer\n3. IF the old multiDayEventTileBuilder parameter is used THEN the system SHALL NOT compile (clean break - removed API)\n4. WHEN rendering a multi-week event segment THEN the builder SHALL apply appropriate styling based on isFirstSegment and isLastSegment flags\n\n### Requirement 5: Date Label Builder Integration\n\n**User Story:** As a Flutter developer, I want the dateLabelBuilder to be passed into the week layout builder, so that the layout builder can position date labels alongside events.\n\n#### Acceptance Criteria\n\n1. WHEN dateLabelBuilder is provided as a top-level parameter THEN it SHALL be passed to the weekLayoutBuilder\n2. WHEN the weekLayoutBuilder renders THEN it MAY use the dateLabelBuilder to render date labels at any position\n3. WHEN no dateLabelBuilder is provided THEN the system SHALL use a default date label renderer\n4. IF a developer wants date labels in Layer 1 instead THEN they MAY render them via dayCellBuilder and the weekLayoutBuilder can ignore the dateLabelBuilder\n5. WHEN the default layout renders date labels THEN it SHALL support configurable positions (top-left, top-center, top-right, bottom-left, bottom-center, bottom-right)\n\n### Requirement 6: Layer 3 - Drag-and-Drop Ghost Layer\n\n**User Story:** As a Flutter developer, I want a dedicated layer for drag-and-drop feedback, so that ghost tiles are rendered above static events with clear visual separation.\n\n#### Acceptance Criteria\n\n1. WHEN a drag operation begins THEN Layer 3 SHALL become visible\n2. WHEN Layer 3 renders THEN it SHALL use the same weekLayoutBuilder as Layer 2 but with only the dragged event\n3. WHEN the dragged event moves THEN the ghost tile in Layer 3 SHALL update position to show the drop target location\n4. WHEN the drag operation ends THEN Layer 3 content SHALL be hidden\n5. WHEN a valid drop target is hovered THEN the cell highlighting in Layer 1 MAY indicate validity\n6. IF the ghost tile position is invalid THEN the system SHALL provide visual feedback (e.g., different styling or opacity)\n\n### Requirement 7: Overflow Indicators\n\n**User Story:** As a Flutter developer, I want the calendar to display \"+N more\" indicators when there are more events than can be displayed, so that users know there are hidden events.\n\n#### Acceptance Criteria\n\n1. WHEN the number of events in a day column exceeds the displayable rows THEN the system SHALL show a \"+N more\" indicator\n2. WHEN calculating hidden event count THEN the system SHALL count hidden events per day column, not hidden rows\n3. WHEN a multi-day event creates blank areas above other events THEN those blank areas SHALL NOT count toward the hidden event count\n4. WHEN a multi-day event spans days with different overflow states THEN each day column SHALL independently calculate and display its hidden count\n5. WHEN an overflow indicator is tapped THEN the system SHALL invoke an onOverflowTap callback (if provided) with the date and list of hidden events\n\n### Requirement 8: Week Layout Builder API\n\n**User Story:** As a Flutter developer, I want a well-defined weekLayoutBuilder API, so that I can implement custom event layout algorithms while leveraging the package's tile and label builders.\n\n#### Acceptance Criteria\n\n1. WHEN weekLayoutBuilder is defined THEN it SHALL have the signature: `Widget Function(BuildContext context, MCalWeekLayoutContext layoutContext)?`\n2. WHEN MCalWeekLayoutContext is instantiated THEN it SHALL contain:\n   - `List<MCalEventSegment> segments` - Event segments for this week\n   - `List<DateTime> dates` - The 7 dates in this week row\n   - `List<double> columnWidths` - Width of each day column\n   - `double rowHeight` - Total height available for this week row\n   - `Widget Function(BuildContext, MCalEventTileContext) eventTileBuilder` - Callback to build event tiles\n   - `Widget Function(BuildContext, MCalDateLabelContext) dateLabelBuilder` - Callback to build date labels\n   - `MCalWeekLayoutConfig config` - Configuration values (spacing, styling parameters)\n3. WHEN the default weekLayoutBuilder renders THEN it SHALL implement greedy first-fit row assignment matching the POC\n4. IF a developer provides a custom weekLayoutBuilder THEN they SHALL have full control over event positioning and may ignore provided builders\n\n### Requirement 9: Breaking API Changes\n\n**User Story:** As a Flutter developer using this unreleased package, I want a clean API without backward compatibility cruft, so that the codebase remains simple and maintainable.\n\n#### Acceptance Criteria\n\n1. WHEN the new architecture is implemented THEN the multiDayEventTileBuilder parameter SHALL be removed\n2. WHEN the new architecture is implemented THEN the eventTileBuilder parameter SHALL accept the new unified signature with segment info\n3. WHEN the new architecture is implemented THEN new parameters SHALL be added: weekLayoutBuilder, MCalWeekLayoutConfig\n4. WHEN breaking changes are made THEN the CHANGELOG SHALL document all removed, modified, and new parameters\n\n### Requirement 10: Configuration and Theming\n\n**User Story:** As a Flutter developer, I want configurable layout parameters, so that I can fine-tune the visual appearance without implementing a custom layout builder.\n\n#### Acceptance Criteria\n\n1. WHEN MCalWeekLayoutConfig is instantiated THEN it SHALL support:\n   - `double tileHeight` - Height of event tiles\n   - `double tileVerticalSpacing` - Vertical space between tiles\n   - `double tileHorizontalSpacing` - Horizontal space between tiles\n   - `double tileCornerRadius` - Corner radius for tile borders\n   - `double tileBorderWidth` - Border width for tiles\n   - `double dateLabelHeight` - Height reserved for date labels\n   - `DateLabelPosition dateLabelPosition` - Position enum (topLeft, topCenter, topRight, bottomLeft, bottomCenter, bottomRight)\n   - `double overflowIndicatorHeight` - Height reserved for overflow indicators\n2. IF MCalThemeData contains layout values THEN MCalWeekLayoutConfig SHALL inherit from theme when not explicitly set\n3. WHEN configuration values are changed THEN the layout SHALL rebuild to reflect changes\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: Each layer has one purpose (Layer 1: grid, Layer 2: events/labels, Layer 3: drag feedback)\n- **Modular Design**: The weekLayoutBuilder pattern allows complete replacement of the event layout algorithm\n- **Dependency Management**: Layer 2 and Layer 3 share layout builder logic to ensure consistency\n- **Clear Interfaces**: MCalWeekLayoutContext and MCalEventSegment provide well-defined contracts\n\n### Performance\n\n- The layered architecture SHALL NOT significantly degrade rendering performance compared to the current implementation\n- Event segment calculations SHALL be performed once per layout pass, not per build\n- The greedy first-fit algorithm SHALL have O(n*m) complexity where n is events and m is max rows\n- Layer 3 SHALL only render during active drag operations to avoid unnecessary widget tree complexity\n\n### Accessibility\n\n- Event tiles SHALL maintain semantic labels for screen reader support\n- Overflow indicators SHALL announce the number of hidden events\n- Date labels SHALL be accessible via semantics\n- Drag-and-drop feedback SHALL include audio/haptic feedback where platform-appropriate\n\n### Usability\n\n- The default layout SHALL match user expectations from common calendar applications (Google Calendar, Apple Calendar)\n- Multi-week events SHALL be visually continuous across week boundaries\n- Overflow indicators SHALL be clearly visible and tappable\n- The API SHALL be intuitive for developers familiar with Flutter builder patterns\n",
  "fileStats": {
    "size": 12933,
    "lines": 193,
    "lastModified": "2026-02-03T21:51:42.125Z"
  },
  "comments": []
}