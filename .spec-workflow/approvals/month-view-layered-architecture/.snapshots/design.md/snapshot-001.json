{
  "id": "snapshot_1770164158955_4k73hkkdz",
  "approvalId": "approval_1770164158951_lqkrq2onk",
  "approvalTitle": "Month View Layered Architecture - Design",
  "version": 1,
  "timestamp": "2026-02-04T00:15:58.955Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design refactors MCalMonthView to use a 3-layer Stack architecture that separates grid rendering (Layer 1), event/label rendering (Layer 2), and drag-and-drop feedback (Layer 3). The core innovation is the `weekLayoutBuilder` pattern, which gives developers complete control over how events are positioned within each week row while the package handles interaction logic through builder wrapping.\n\nThe existing `MCalMultiDayRenderer` already implements the greedy first-fit algorithm for event positioning. This design extends that foundation by:\n1. Making it the basis for the default week layout builder\n2. Unifying single-day and multi-day event handling\n3. Adding overflow indicator support\n4. Introducing builder wrapping for separation of visual customization from interaction handling\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **Widget-based Architecture**: Maintains the existing widget tree with controller pattern\n- **Builder Pattern**: Extends the existing builder callback pattern (dayCellBuilder, eventTileBuilder, etc.) with new builders (weekLayoutBuilder, overflowIndicatorBuilder)\n- **Performance Requirements**: Segment calculations performed once per layout pass; Layer 3 only rendered during drag operations\n- **Flutter Conventions**: Context objects follow established pattern (MCalDayCellContext, MCalEventTileContext); new contexts follow same structure\n\n### Project Structure (structure.md)\n\n- **File Organization**: New files in appropriate directories (`lib/src/widgets/`, `lib/src/models/`)\n- **Naming Conventions**: All public classes prefixed with `MCal`; context objects named `MCal*Context`\n- **Single Responsibility**: Each layer has distinct purpose; builder wrapping logic isolated\n- **Code Size**: Large `mcal_month_view.dart` will be refactored with layout logic moved to new files\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **MCalMultiDayRenderer**: Already implements greedy first-fit algorithm via `calculateWeekLayout()`. Will be extended to handle all events (not just multi-day) and to support overflow calculations.\n- **MCalMultiDayRowSegment**: Existing segment model with `isFirstSegment`, `isLastSegment` flags. Will be renamed/adapted to `MCalEventSegment` for unified use.\n- **MCalWeekEventLayoutFrame**: Existing layout frame structure. Will be extended to include overflow information.\n- **MCalEventLayoutAssignment**: Existing assignment model. Will be reused as-is.\n- **MCalThemeData**: Existing theme extension. Will add new layout-related properties (dateLabelHeight, dateLabelPosition, overflowIndicatorHeight, tileCornerRadius).\n- **MCalDragHandler**: Existing drag state management. Will integrate with Layer 3 rendering.\n- **MCalDraggableEventTile**: Existing draggable wrapper. Will be part of the builder wrapping system.\n\n### Integration Points\n\n- **MCalEventController**: No changes needed; continues to provide events\n- **MCalTheme**: Extended with new layout properties\n- **Existing Callbacks**: onEventTap, onEventLongPress, onCellTap, etc. continue to work through builder wrapping\n\n## Architecture\n\nThe refactored MCalMonthView uses a Stack with three conceptual layers:\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                    MCalMonthView                             │\n│  ┌─────────────────────────────────────────────────────────┐│\n│  │  Optional Navigator (showNavigator: true)               ││\n│  └─────────────────────────────────────────────────────────┘│\n│  ┌─────────────────────────────────────────────────────────┐│\n│  │  Weekday Headers                                        ││\n│  └─────────────────────────────────────────────────────────┘│\n│  ┌─────────────────────────────────────────────────────────┐│\n│  │  Week Numbers (if showWeekNumbers)                      ││\n│  │  (positioned left/right based on RTL)                   ││\n│  │  ┌─────────────────────────────────────────────────────┐││\n│  │  │               Calendar Stack                        │││\n│  │  │  ┌───────────────────────────────────────────────┐  │││\n│  │  │  │ Layer 3: Drag Ghost (only during drag)        │  │││\n│  │  │  ├───────────────────────────────────────────────┤  │││\n│  │  │  │ Layer 2: Events, Labels, Overflow Indicators  │  │││\n│  │  │  ├───────────────────────────────────────────────┤  │││\n│  │  │  │ Layer 1: Calendar Grid (day cells)            │  │││\n│  │  │  └───────────────────────────────────────────────┘  │││\n│  │  └─────────────────────────────────────────────────────┘││\n│  └─────────────────────────────────────────────────────────┘│\n└─────────────────────────────────────────────────────────────┘\n```\n\n### Layer Details\n\n```mermaid\ngraph TD\n    MV[MCalMonthView] --> Stack\n    Stack --> L1[Layer 1: Grid]\n    Stack --> L2[Layer 2: Events]\n    Stack --> L3[Layer 3: Drag Ghost]\n    \n    L1 --> DCB[dayCellBuilder]\n    L2 --> WLB[weekLayoutBuilder]\n    WLB --> ETB[wrapped eventTileBuilder]\n    WLB --> DLB[wrapped dateLabelBuilder]\n    WLB --> OIB[wrapped overflowIndicatorBuilder]\n    L3 --> WLB2[weekLayoutBuilder with single event]\n    \n    ETB --> DEV[Developer's eventTileBuilder]\n    ETB --> IH[Interaction Handlers]\n    IH --> GD[GestureDetector]\n    IH --> LPD[LongPressDraggable]\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: \n  - `mcal_week_layout_builder.dart` - Default layout implementation\n  - `mcal_week_layout_contexts.dart` - Context objects for week layout\n  - `mcal_builder_wrapper.dart` - Builder wrapping logic\n\n- **Component Isolation**: Each layer is built by isolated methods; builder wrapping is separate from layout logic\n\n- **Service Layer Separation**: Layout calculation (MCalMultiDayRenderer) separate from rendering (week layout builder)\n\n## Components and Interfaces\n\n### Component 1: MCalWeekLayoutContext\n\n- **Purpose:** Provides all data needed by a weekLayoutBuilder to render one week row\n- **Interfaces:**\n  ```dart\n  class MCalWeekLayoutContext {\n    final List<MCalEventSegment> segments;\n    final List<DateTime> dates;  // 7 dates for this week\n    final List<double> columnWidths;  // Width of each day column\n    final double rowHeight;  // Total height available\n    final int weekRowIndex;  // Index in month grid (0-based)\n    final DateTime currentMonth;  // For current month styling\n    \n    // Pre-wrapped builders (include interaction handlers)\n    final Widget Function(BuildContext, MCalEventTileContext) eventTileBuilder;\n    final Widget Function(BuildContext, MCalDateLabelContext) dateLabelBuilder;\n    final Widget Function(BuildContext, MCalOverflowIndicatorContext) overflowIndicatorBuilder;\n    \n    // Configuration\n    final MCalWeekLayoutConfig config;\n  }\n  ```\n- **Dependencies:** MCalEventSegment, MCalWeekLayoutConfig, context objects\n- **Reuses:** Existing MCalDateLabelContext pattern\n\n### Component 2: MCalEventSegment\n\n- **Purpose:** Represents a portion of an event within a single week row (unified for single-day and multi-day)\n- **Interfaces:**\n  ```dart\n  class MCalEventSegment {\n    final MCalCalendarEvent event;\n    final int weekRowIndex;\n    final int startDayInWeek;  // 0-6\n    final int endDayInWeek;    // 0-6\n    final bool isFirstSegment;  // First segment of multi-week event\n    final bool isLastSegment;   // Last segment of multi-week event\n    \n    int get spanDays => endDayInWeek - startDayInWeek + 1;\n    bool get isSingleDay => spanDays == 1 && isFirstSegment && isLastSegment;\n  }\n  ```\n- **Dependencies:** MCalCalendarEvent\n- **Reuses:** Extends concept from MCalMultiDayRowSegment\n\n### Component 3: MCalWeekLayoutConfig\n\n- **Purpose:** Configuration values for week layout rendering, inheriting from theme\n- **Interfaces:**\n  ```dart\n  class MCalWeekLayoutConfig {\n    final double tileHeight;\n    final double tileVerticalSpacing;\n    final double tileHorizontalSpacing;\n    final double tileCornerRadius;\n    final double tileBorderWidth;\n    final double dateLabelHeight;\n    final DateLabelPosition dateLabelPosition;\n    final double overflowIndicatorHeight;\n    \n    factory MCalWeekLayoutConfig.fromTheme(MCalThemeData theme);\n  }\n  \n  enum DateLabelPosition {\n    topLeft, topCenter, topRight,\n    bottomLeft, bottomCenter, bottomRight,\n  }\n  ```\n- **Dependencies:** MCalThemeData\n- **Reuses:** Values from existing MCalThemeData\n\n### Component 4: MCalOverflowIndicatorContext\n\n- **Purpose:** Context for overflow indicator builder\n- **Interfaces:**\n  ```dart\n  class MCalOverflowIndicatorContext {\n    final DateTime date;\n    final int hiddenEventCount;\n    final List<MCalCalendarEvent> hiddenEvents;\n    final List<MCalCalendarEvent> visibleEvents;\n    final double width;\n    final double height;\n  }\n  ```\n- **Dependencies:** MCalCalendarEvent\n- **Reuses:** Pattern from MCalDateLabelContext\n\n### Component 5: MCalBuilderWrapper\n\n- **Purpose:** Wraps developer-provided builders with interaction handlers\n- **Interfaces:**\n  ```dart\n  class MCalBuilderWrapper {\n    /// Wraps eventTileBuilder with tap, long-press, and drag handlers\n    static Widget Function(BuildContext, MCalEventTileContext) wrapEventTileBuilder({\n      required Widget Function(BuildContext, MCalEventTileContext, Widget)? developerBuilder,\n      required Widget Function(BuildContext, MCalEventTileContext) defaultBuilder,\n      required void Function(BuildContext, MCalEventTapDetails)? onEventTap,\n      required void Function(BuildContext, MCalEventLongPressDetails)? onEventLongPress,\n      required bool enableDragAndDrop,\n      required MCalDragHandler? dragHandler,\n    });\n    \n    /// Wraps dateLabelBuilder (currently no interactions, but extensible)\n    static Widget Function(BuildContext, MCalDateLabelContext) wrapDateLabelBuilder({\n      required Widget Function(BuildContext, MCalDateLabelContext, String)? developerBuilder,\n      required Widget Function(BuildContext, MCalDateLabelContext) defaultBuilder,\n    });\n    \n    /// Wraps overflowIndicatorBuilder with tap handler\n    static Widget Function(BuildContext, MCalOverflowIndicatorContext) wrapOverflowIndicatorBuilder({\n      required Widget Function(BuildContext, MCalOverflowIndicatorContext, Widget)? developerBuilder,\n      required Widget Function(BuildContext, MCalOverflowIndicatorContext) defaultBuilder,\n      required void Function(BuildContext, MCalOverflowTapDetails)? onOverflowTap,\n    });\n  }\n  ```\n- **Dependencies:** MCalDragHandler, callback details classes\n- **Reuses:** Existing MCalDraggableEventTile wrapping pattern\n\n### Component 6: Default Week Layout Builder\n\n- **Purpose:** Provides the default greedy first-fit layout matching the POC\n- **Interfaces:**\n  ```dart\n  class MCalDefaultWeekLayoutBuilder {\n    /// Builds the default week layout widget\n    static Widget build(BuildContext context, MCalWeekLayoutContext layoutContext);\n    \n    /// Calculates row assignments using greedy first-fit\n    static List<MCalSegmentRowAssignment> assignRows(List<MCalEventSegment> segments);\n    \n    /// Calculates overflow counts per day column\n    static Map<int, MCalOverflowInfo> calculateOverflow({\n      required List<MCalSegmentRowAssignment> assignments,\n      required int maxVisibleRows,\n    });\n  }\n  \n  class MCalSegmentRowAssignment {\n    final MCalEventSegment segment;\n    final int row;  // 0-based row index\n  }\n  \n  class MCalOverflowInfo {\n    final int hiddenCount;\n    final List<MCalCalendarEvent> hiddenEvents;\n    final List<MCalCalendarEvent> visibleEvents;\n  }\n  ```\n- **Dependencies:** MCalWeekLayoutContext, MCalEventSegment\n- **Reuses:** Algorithm from MCalMultiDayRenderer.calculateWeekLayout()\n\n## Data Models\n\n### MCalEventSegment\n```dart\nclass MCalEventSegment {\n  final MCalCalendarEvent event;\n  final int weekRowIndex;\n  final int startDayInWeek;    // 0-6\n  final int endDayInWeek;      // 0-6\n  final bool isFirstSegment;\n  final bool isLastSegment;\n  \n  // Computed properties\n  int get spanDays;\n  bool get isSingleDay;\n}\n```\n\n### MCalWeekLayoutConfig\n```dart\nclass MCalWeekLayoutConfig {\n  final double tileHeight;           // default: 18.0\n  final double tileVerticalSpacing;  // default: 2.0\n  final double tileHorizontalSpacing; // default: 2.0\n  final double tileCornerRadius;     // default: 3.0\n  final double tileBorderWidth;      // default: 0.0\n  final double dateLabelHeight;      // default: 18.0\n  final DateLabelPosition dateLabelPosition; // default: topLeft\n  final double overflowIndicatorHeight; // default: 14.0\n}\n```\n\n### Updated MCalEventTileContext\n```dart\nclass MCalEventTileContext {\n  final MCalCalendarEvent event;\n  final DateTime displayDate;\n  final bool isAllDay;\n  \n  // New segment info (unified for single-day and multi-day)\n  final MCalEventSegment segment;\n  final double width;   // Computed tile width\n  final double height;  // Configured tile height\n}\n```\n\n### MCalOverflowTapDetails\n```dart\nclass MCalOverflowTapDetails {\n  final DateTime date;\n  final List<MCalCalendarEvent> hiddenEvents;\n  final List<MCalCalendarEvent> visibleEvents;\n}\n```\n\n## Theme Extensions\n\nAdd to MCalThemeData:\n\n```dart\n// New properties\nfinal double? dateLabelHeight;           // default: 18.0\nfinal DateLabelPosition? dateLabelPosition; // default: topLeft\nfinal double? overflowIndicatorHeight;   // default: 14.0\nfinal double? tileCornerRadius;          // default: 3.0\n\n// Existing properties to retain\nfinal double? eventTileHeight;           // already exists (default: 20.0, changing to 18.0)\nfinal double? eventTileHorizontalSpacing; // already exists\nfinal double? eventTileVerticalSpacing;  // already exists\n```\n\n## Builder Wrapping Flow\n\n```mermaid\nsequenceDiagram\n    participant Dev as Developer Code\n    participant MV as MCalMonthView\n    participant BW as MCalBuilderWrapper\n    participant WLB as weekLayoutBuilder\n    participant Tile as Event Tile Widget\n    \n    Dev->>MV: eventTileBuilder (visual only)\n    MV->>BW: wrapEventTileBuilder(developerBuilder, handlers)\n    BW-->>MV: wrappedBuilder\n    MV->>WLB: MCalWeekLayoutContext(wrappedBuilder, ...)\n    WLB->>BW: wrappedBuilder(context, tileContext)\n    BW->>Dev: developerBuilder(context, tileContext, default)\n    Dev-->>BW: visual Widget\n    BW->>BW: wrap with GestureDetector + LongPressDraggable\n    BW-->>Tile: wrapped Widget with handlers\n```\n\n## Layer Rendering Flow\n\n```mermaid\nflowchart TD\n    subgraph \"Build Phase\"\n        A[MCalMonthView.build] --> B[Build Stack]\n        B --> C[Build Layer 1: Grid]\n        B --> D[Build Layer 2: Events]\n        B --> E{isDragging?}\n        E -->|Yes| F[Build Layer 3: Ghost]\n        E -->|No| G[Skip Layer 3]\n    end\n    \n    subgraph \"Layer 2 Detail\"\n        D --> H[For each week row]\n        H --> I[Calculate segments]\n        I --> J[Wrap builders]\n        J --> K[Call weekLayoutBuilder]\n        K --> L[Position tiles + labels + overflow]\n    end\n    \n    subgraph \"Layer 3 Detail\"\n        F --> M[Get drag target position]\n        M --> N[Create single-event segment]\n        N --> O[Call weekLayoutBuilder]\n        O --> P[Render ghost tile]\n    end\n```\n\n## File Changes Summary\n\n### New Files\n\n| File | Purpose |\n|------|---------|\n| `lib/src/widgets/mcal_week_layout_contexts.dart` | MCalWeekLayoutContext, MCalEventSegment, MCalWeekLayoutConfig, MCalOverflowIndicatorContext |\n| `lib/src/widgets/mcal_default_week_layout.dart` | MCalDefaultWeekLayoutBuilder implementation |\n| `lib/src/widgets/mcal_builder_wrapper.dart` | Builder wrapping logic |\n\n### Modified Files\n\n| File | Changes |\n|------|---------|\n| `lib/src/widgets/mcal_month_view.dart` | Refactor to 3-layer Stack; remove renderMultiDayEventsAsContiguous; add weekLayoutBuilder, overflowIndicatorBuilder parameters; integrate builder wrapping |\n| `lib/src/widgets/mcal_month_view_contexts.dart` | Update MCalEventTileContext with segment info; add MCalOverflowTapDetails |\n| `lib/src/widgets/mcal_callback_details.dart` | Add MCalOverflowTapDetails |\n| `lib/src/styles/mcal_theme.dart` | Add dateLabelHeight, dateLabelPosition, overflowIndicatorHeight, tileCornerRadius |\n| `lib/src/widgets/mcal_multi_day_renderer.dart` | Extend to generate segments for ALL events (not just multi-day); add overflow calculation |\n| `lib/multi_calendar.dart` | Export new public classes |\n\n### Removed/Deprecated\n\n| Item | Reason |\n|------|--------|\n| `renderMultiDayEventsAsContiguous` parameter | Replaced by weekLayoutBuilder pattern |\n| `multiDayEventTileBuilder` parameter | Replaced by unified eventTileBuilder with segment info |\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid weekLayoutBuilder return**\n   - **Handling:** If weekLayoutBuilder returns null or throws, fall back to default layout with error logging\n   - **User Impact:** Calendar still renders with default layout; error logged for debugging\n\n2. **Event segment calculation fails**\n   - **Handling:** Return empty segment list; log warning\n   - **User Impact:** Events may not display for that week; other weeks unaffected\n\n3. **Overflow calculation overflow**\n   - **Handling:** Clamp maxVisibleRows to positive integer; handle edge cases\n   - **User Impact:** Overflow indicator shows correct count\n\n## Testing Strategy\n\n### Unit Testing\n\n- **MCalEventSegment**: Test segment creation, span calculation, edge cases\n- **MCalWeekLayoutConfig**: Test theme inheritance, override behavior\n- **MCalDefaultWeekLayoutBuilder.assignRows()**: Test greedy first-fit algorithm with various event combinations\n- **MCalDefaultWeekLayoutBuilder.calculateOverflow()**: Test hidden/visible event counting\n- **MCalBuilderWrapper**: Test that handlers are correctly attached\n\n### Widget Testing\n\n- **Layer rendering**: Verify correct Stack structure with 3 layers\n- **Builder wrapping**: Verify developer builders receive correct context and handlers work\n- **Default layout**: Visual regression tests matching POC behavior\n- **Overflow indicators**: Test display and tap handling\n- **Multi-week events**: Verify visual continuity (no corners/borders on continuation edges)\n- **RTL support**: Verify week numbers position correctly\n\n### Integration Testing\n\n- **Drag-and-drop**: Verify Layer 3 renders ghost correctly during drag\n- **Theme changes**: Verify layout responds to theme updates\n- **Event updates**: Verify layout recalculates when events change\n- **Example app**: Verify all tabs (default, dots, pills, custom) work correctly\n",
  "fileStats": {
    "size": 20112,
    "lines": 457,
    "lastModified": "2026-02-04T00:15:52.172Z"
  },
  "comments": []
}